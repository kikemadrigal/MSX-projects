0001   0000                 output "main.bin"
0002   0000             
0003   0000 FE              db   0FEh               ; ID archivo binario, siempre hay que poner el mismo 0FEh
0004   0001 00 86           dw   INICIO             ; dirección de inicio
0005   0003 BC B7           dw   FINAL - 1          ; dirección final
0006   0005 00 86           dw   MAIN               ; dircción del programa de ejecución (para cuando pongas r en bload"nombre_programa", r)
0007   0007                 
0008   0007                  
0009   0007              
0010   0007                 org #8600             ; org se utiliza para decirle al z80 en que posición de memoria empieza nuestro programa (es la 33280 en decimal), en hezadecimal sería #8200
0011   8600                     
0012   8600             INICIO: 
0013   8600             
0014   8600             screen:  equ #8500
0015   8600             game_over:  equ #8501
0016   8600             lives:  equ #8502
0017   8600             score:  equ #8503
0018   8600             in_game:  equ #8504
0019   8600             
0020   8600             
0021   8600             
0022   8600             MAIN:    
0023   8600             
0024   8600 CD 2A 8C    	call create_player
0025   8603 CD 22 8E    	call create_enemy
0026   8606                 
0027   8606              
0028   8606             .in_game: 
0029   8606 CD B4 98        call para_cancion
0030   8609 3E 01           ld a,1; le ponemos la música del menú
0031   860B 32 04 85        ld (musica_activa),a
0032   860E CD 52 98        call inicilizar_tracker
0033   8611                 
0034   8611 CD C7 87        call clear_screen
0035   8614 CD 44 00        call ENASCR; encendemos la pantalla
0036   8617 CD 56 01        call KILBUF
0037   861A CD 8A 87        call show_menu
0038   861D             
0039   861D             
0040   861D             ;.repetir_menu:
0041   861D             ;    ld a,0
0042   861D             ;    call GTTRIG
0043   861D             ;    cp 0
0044   861D             ;    jr z,.repetir_menu
0045   861D CD 9F 00        call CHGET
0046   8620             
0047   8620 CD B4 98        call para_cancion
0048   8623 3E 02           ld a,2; le ponemos la música ingame
0049   8625 32 04 85        ld (musica_activa),a
0050   8628 CD 52 98        call inicilizar_tracker
0051   862B             
0052   862B 3E 00           ld a,0
0053   862D 32 00 85        ld (screen),a
0054   8630 AF              xor a
0055   8631 32 01 85        ld (game_over),a
0056   8634 AF              xor a
0057   8635 32 03 85        ld (score),a
0058   8638 3E 07           ld a,7
0059   863A 32 02 85        ld (lives),a
0060   863D CD D3 87        call increase_screen
0061   8640             
0062   8640 CD 47 86        call main_loop
0063   8643 C3 06 86        jp .in_game
0064   8646 C9          	ret
0065   8647             
0066   8647             main_loop: 
0067   8647 76              halt
0068   8648 CD 50 8C        call update_player
0069   864B CD 43 8C        call render_player
0070   864E 3A 01 85        ld a, (game_over)
0071   8651 FE 01           cp 1
0072   8653 28 08           jr z,.end_main_loop
0073   8655             
0074   8655 CD 23 8E        call update_enemies
0075   8658 CD E2 90        call render_enemies
0076   865B             
0077   865B             
0078   865B                 
0079   865B 18 EA       	jr main_loop
0080   865D             .end_main_loop: 
0081   865D CD 31 91        call sacar_sprites_de_pantalla
0082   8660 3E D4           ld a,212
0083   8662 DD 77 00        ld (ix+player.y),a
0084   8665 CD 43 8C        call render_player
0085   8668 CD E2 90        call render_enemies
0086   866B C9              ret
0087   866C               
0088   866C             
0089   866C             
0090   866C             kill_player
0091   866C 3A 02 85        ld a,(lives)
0092   866F D6 01           sub 1
0093   8671 32 02 85        ld (lives),a
0094   8674 FE 00           cp 0
0095   8676 28 0A           jr z,.end_kill_player
0096   8678 CD 8E 8D        call recolocate_player
0097   867B CD E5 98        call efecto_mata_player
0098   867E CD AC 86        call hud
0099   8681 C9              ret
0100   8682             .end_kill_player
0101   8682 3E 01           ld a,1
0102   8684 32 01 85        ld (game_over),a
0103   8687 C9              ret
0104   8688             
0105   8688             
0106   8688             
0107   8688             
0108   8688             
0109   8688             
0110   8688             
0111   8688             
0112   8688             ;;----------------------------------
0113   8688             ;;   GETBLOCK=Hace esta formula (y/8)*32+(x/8)
0114   8688             ;;      Input:
0115   8688             ;;          D=con la posición x
0116   8688             ;;          E=con la posición y
0117   8688             ;;      Output
0118   8688             ;;          B=el tile sobre el que está laentidad
0119   8688             get_block: 
0120   8688 7B              ld a,e
0121   8689                 ;ld a,(ix+player.y) ;a=posicion y en pixeles
0122   8689 C6 10           add 16
0123   868B                 ;con srl estas dividiendo entre 2,ya que corre a la derecha los bits. 
0124   868B                 ;al hacerlo 3 veces es como dividir entre 8,a=y/8: 1.01001100, 2.00100110, 3.00010011
0125   868B CB 3F           srl a  
0126   868D CB 3F           srl a  
0127   868F CB 3F           srl a  
0128   8691 26 00           ld h,0 ; en h le ponemos un 0 
0129   8693 6F              ld l,a ;y en los 8 bytes de "l" le ponemos el valor que contiene a
0130   8694             
0131   8694                 ;-----------------
0132   8694                 ;Buscando la fila
0133   8694 29              add hl, hl ;x32, sumar algo por si mismo es como multiplizarlo por 2, si lo repetivos 5 es como si o multiplixaramos por 32
0134   8695 29              add hl, hl 
0135   8696 29              add hl, hl 
0136   8697 29              add hl, hl 
0137   8698 29              add hl, hl 
0138   8699             
0139   8699                 ;-----------------
0140   8699                 ;Esta es la parte +(x/8)
0141   8699 7A              ld a,d
0142   869A                 ;ld a,(ix+player.x) ;a=x
0143   869A C6 08           add 8
0144   869C CB 3F           srl a 
0145   869E CB 3F           srl a 
0146   86A0 CB 3F           srl a 
0147   86A2 16 00           ld d,0
0148   86A4 5F              ld e,a ;e=x
0149   86A5 19              add hl,de ;hl=(y/8)*32+(x/8)
0150   86A6             
0151   86A6 11 60 89        ld de, map_buffer; dirección buffer colisiones
0152   86A9 19              add hl,de ;hl=buffer_colisiones + (y/8)*32+(x/8)
0153   86AA             
0154   86AA 46              ld b,(hl) ;metemos en a el tile que nos pide
0155   86AB                 ;ld (tile0),a
0156   86AB C9              ret
0157   86AC             
0158   86AC             
0159   86AC             
0160   86AC             
0161   86AC             hud: 
0162   86AC                 ;------------------------Level--------------------------
0163   86AC                 ;ld a,0
0164   86AC                 ;ld (GRPACX),a ;GRPACX contiene la posición X del cursor en modo gráfico
0165   86AC                 ;ld a,184
0166   86AC                 ;ld (GRPACY),a
0167   86AC                 ;ld hl, message_level
0168   86AC                 ;call graphics_print
0169   86AC 3E 7A           ld a, 122
0170   86AE 21 C3 1A        ld hl,6851
0171   86B1 CD 4D 00        call WRTVRM
0172   86B4 3E 7B           ld a, 123
0173   86B6 21 C4 1A        ld hl,6852
0174   86B9 CD 4D 00        call WRTVRM
0175   86BC 3E 9A           ld a, 154
0176   86BE 21 E3 1A        ld hl,6883
0177   86C1 CD 4D 00        call WRTVRM
0178   86C4 3E 9B           ld a, 155
0179   86C6 21 E4 1A        ld hl,6884
0180   86C9 CD 4D 00        call WRTVRM
0181   86CC                 ;1 nos estudiamos donde está la dirección de la tabla de nombres en VRAM
0182   86CC                 ;2.obtenemos el número de tile que keremos poner
0183   86CC 3A 00 85        ld a,(screen)
0184   86CF 06 56           ld b, COMIENZO_TILE_NUMEROS
0185   86D1 80              add b
0186   86D2 21 E6 1A        ld hl, 6886 ;aki va la dirección de la tabla de nombres que keremos cambiar;6912(final de la tabla de nombres)-32(-1 fila)=6880+7
0187   86D5 CD 4D 00        call WRTVRM
0188   86D8                ;---------------------Fin Level--------------------------
0189   86D8             
0190   86D8             
0191   86D8                 ;------------------------Score--------------------------
0192   86D8                 ;ld a,90; posicionamos el cursor en la posición x ..
0193   86D8                 ;ld (GRPACX),a
0194   86D8                 ;ld hl, message_score
0195   86D8                 ;call graphics_print
0196   86D8                 
0197   86D8                 ;*******CON EL GRPPT SLAEN LOS NÚMERO MACHADOS***/
0198   86D8                 ;ld a,140; posicionamos el cursor en la posición x ..
0199   86D8                 ;ld (GRPACX),a
0200   86D8                 ;ld b,48;metemos en b el valor correspondiente al 0 en la tabla ascii
0201   86D8                 ;ld a,(score)
0202   86D8                 ;add b
0203   86D8                 ;cp 56
0204   86D8                 ;jr nc, .a_es_mayor_de_56
0205   86D8                 ;call GRPPRT 
0206   86D8             ;.a_es_mayor_de_56:
0207   86D8             ;    ld a,48
0208   86D8             ;    call GRPPRT
0209   86D8                 ;**************************************************
0210   86D8                 ;pintamos los 4 tiles del score (el dibujo)
0211   86D8 3E 7C           ld a, 124
0212   86DA 21 CE 1A        ld hl,6862
0213   86DD CD 4D 00        call WRTVRM
0214   86E0 3E 7D           ld a, 125
0215   86E2 21 CF 1A        ld hl,6863
0216   86E5 CD 4D 00        call WRTVRM
0217   86E8 3E 9C           ld a, 156
0218   86EA 21 EE 1A        ld hl,6894
0219   86ED CD 4D 00        call WRTVRM
0220   86F0 3E 9D           ld a, 157
0221   86F2 21 EF 1A        ld hl,6895
0222   86F5 CD 4D 00        call WRTVRM
0223   86F8             
0224   86F8             
0225   86F8             
0226   86F8 3A 03 85        ld a,(score)
0227   86FB 06 56           ld b, COMIENZO_TILE_NUMEROS
0228   86FD 80              add b
0229   86FE 06 00           ld b,0; Ponemos b a 0 ya que será nuestro contador de decenas
0230   8700             .repetir: 
0231   8700                 ;si score es mayor que 10
0232   8700 FE 60           cp COMIENZO_TILE_NUMEROS+10 ;no dará carry si score es mayor que 10
0233   8702 30 08           jr nc, .es_mayor_que_10
0234   8704 21 F2 1A        ld hl, 6898
0235   8707 CD 4D 00        call WRTVRM
0236   870A 18 05           jr .next
0237   870C             .es_mayor_que_10: 
0238   870C 04              inc b ; aumentamos el contador de decenas
0239   870D D6 0A           sub 10
0240   870F 18 EF           jr .repetir
0241   8711             .next: 
0242   8711                 ;aki imprimimos las decenas almacenadas en b
0243   8711 21 F1 1A        ld hl, 6897
0244   8714 78              ld a,b
0245   8715 FE 0A           cp #a ;si el valor de b es 10 sumamos una vida y ponemos el score a 0
0246   8717 28 08           jr z, .sumar_vida_y_reiniciar_score
0247   8719 06 56           ld b, COMIENZO_TILE_NUMEROS
0248   871B 80              add b
0249   871C CD 4D 00        call WRTVRM
0250   871F 18 0E           jr .fin
0251   8721             .sumar_vida_y_reiniciar_score: 
0252   8721 AF              xor a
0253   8722 32 03 85        ld (score),a
0254   8725 3A 02 85        ld a,(lives)
0255   8728 3C              inc a
0256   8729 32 02 85        ld (lives),a
0257   872C CD C0 98        call efecto_toque
0258   872F             .fin:     
0259   872F                 ;---------------------Fin score--------------------------
0260   872F             
0261   872F                 ;------------------------Lives--------------------------
0262   872F                 ;ld a,190
0263   872F                 ;ld (GRPACX),a
0264   872F                 ;ld hl, message_lives
0265   872F                 ;call graphics_print
0266   872F                 ;ld a,240
0267   872F                 ;ld (GRPACX),a
0268   872F             
0269   872F                 ;ld b,47    ;metemos en b el valor correspondiente al 0 en la tabla ascii
0270   872F                 ;ld a,(lives)    ;para sumar a y b tendremos que echar mano de ld a
0271   872F                 ;add b
0272   872F                 ;call GRPPRT 
0273   872F             
0274   872F 3E 7E           ld a, 126
0275   8731 21 D9 1A        ld hl,6873
0276   8734 CD 4D 00        call WRTVRM
0277   8737 3E 7F           ld a, 127
0278   8739 21 DA 1A        ld hl,6874
0279   873C CD 4D 00        call WRTVRM
0280   873F 3E 9E           ld a, 158
0281   8741 21 F9 1A        ld hl,6905
0282   8744 CD 4D 00        call WRTVRM
0283   8747 3E 9F           ld a, 159
0284   8749 21 FA 1A        ld hl,6906
0285   874C CD 4D 00        call WRTVRM
0286   874F             
0287   874F             
0288   874F 3A 02 85        ld a,(lives)
0289   8752 06 56           ld b, COMIENZO_TILE_NUMEROS
0290   8754 80              add b
0291   8755 21 FE 1A        ld hl, 6910 
0292   8758 CD 4D 00        call WRTVRM
0293   875B                 ;----------------------Fin lives-------------------------
0294   875B C9              ret
0295   875C             
0296   875C             graphics_print: 
0297   875C 7E              ld  a,(hl)          
0298   875D A7              and a               
0299   875E C8              ret z               
0300   875F CD 8D 00        call GRPPRT         
0301   8762 23              inc hl              
0302   8763 18 F7           jr graphics_print 
0303   8765 C9              ret     
0304   8766             graphics_print_sc2: 
0305   8766                 ;ld de, message_msx_spain ; la dirección donde empiezan los bytes del texto
0306   8766                 ;ld b, 1;    posicón y
0307   8766                 ;ld c, 5;    posicón x
0308   8766 21 00 19        ld hl, 6144 +256
0309   8769 CB 20           sla b           ;b x2
0310   876B CB 20           sla b           ;b x4
0311   876D CB 20           sla b           ;b x8
0312   876F CB 20           sla b           ;b x16
0313   8771 CB 20           sla b           ;b x32
0314   8773 78              ld a,b
0315   8774 06 00           ld b,0
0316   8776 09              add hl, bc; c ya lo teníamos, se lo sumamos a hl
0317   8777 4F              ld c,a
0318   8778 09              add hl, bc
0319   8779 CD 7D 87        call print_cs2
0320   877C C9              ret
0321   877D             
0322   877D             print_cs2: 
0323   877D 1A              ld a,(de)          
0324   877E A7              and a               
0325   877F C8              ret z  ;si ha llegado a 0 salimos    
0326   8780 C6 1F           add 31
0327   8782 CD 4D 00        call WRTVRM;en hl la dirección y en a el valor
0328   8785                 ;call GRPPRT         
0329   8785 13              inc de    
0330   8786 23              inc hl          
0331   8787 18 F4           jr print_cs2   
0332   8789 C9              ret
0333   878A             
0334   878A             show_menu: 
0335   878A                 ;pintamos la imagen de arriba
0336   878A 06 14           ld b,20
0337   878C 3E 27           ld a, 39
0338   878E 21 2C 18        ld hl, 6188
0339   8791             .repeat1: 
0340   8791 CD 4D 00        call WRTVRM;en hl la dirección y en a el valor
0341   8794 05              dec b
0342   8795 3C              inc a
0343   8796 23              inc hl
0344   8797 10 F8           djnz .repeat1
0345   8799             
0346   8799 06 14           ld b,20
0347   879B 3E 47           ld a, 71
0348   879D 21 4C 18        ld hl, 6220
0349   87A0             .repeat2: 
0350   87A0 CD 4D 00        call WRTVRM;en hl la dirección y en a el valor
0351   87A3 05              dec b
0352   87A4 3C              inc a
0353   87A5 23              inc hl
0354   87A6 10 F8           djnz .repeat2
0355   87A8             
0356   87A8 11 AD 88        ld de, message_msx_spain_presents ; la dirección donde empiezan los bytes del texto
0357   87AB 06 01           ld b, 1;    posicón y
0358   87AD 0E 07           ld c, 7;    posicón x
0359   87AF CD 66 87        call graphics_print_sc2
0360   87B2             
0361   87B2 11 C2 88        ld de, message_disco 
0362   87B5 06 04           ld b, 4;    posicón y
0363   87B7 0E 0D           ld c, 13;    posicón x
0364   87B9 CD 66 87        call graphics_print_sc2
0365   87BC             
0366   87BC 11 D5 88        ld de, message_press_any_key_to_start 
0367   87BF 06 07           ld b, 7;    posicón y
0368   87C1 0E 02           ld c, 2;    posicón x
0369   87C3 CD 66 87        call graphics_print_sc2
0370   87C6 C9              ret
0371   87C7             
0372   87C7             
0373   87C7             clear_screen: 
0374   87C7 3E 00           ld a,0
0375   87C9 01 00 03        ld bc, 768
0376   87CC 21 00 18        ld hl, 6144
0377   87CF CD 56 00        call FILVRM
0378   87D2 C9              ret
0379   87D3             
0380   87D3             
0381   87D3             
0382   87D3             
0383   87D3             increase_screen: 
0384   87D3 CD B4 98        call para_cancion
0385   87D6 3E 02           ld a,2; le ponemos la música ingame
0386   87D8 32 04 85        ld (musica_activa),a
0387   87DB CD 52 98        call inicilizar_tracker
0388   87DE             
0389   87DE CD 31 91        call sacar_sprites_de_pantalla
0390   87E1 CD 8E 8D        call recolocate_player 
0391   87E4                 ;call DISSCR ;Apagamos la pantalla
0392   87E4 3A 00 85        ld a,(screen)
0393   87E7 C6 01           add 1
0394   87E9 32 00 85        ld (screen),a ; aumentamos en contador de pantallas
0395   87EC CD AC 86        call hud
0396   87EF                 ;call ENASCR
0397   87EF                 ;posicinamos los enemigos
0398   87EF 3A 00 85        ld a,(screen)
0399   87F2 FE 01           cp 1
0400   87F4 CA 87 91        jp z, recolocate_and_level_screen_1
0401   87F7 FE 02           cp 2
0402   87F9 CA F1 91        jp z, recolocate_and_level_screen_2
0403   87FC FE 03           cp 3
0404   87FE CA 70 92        jp z, recolocate_and_level_screen_3
0405   8801 FE 04           cp 4
0406   8803 CA D7 92        jp z, recolocate_and_level_screen_4
0407   8806 FE 05           cp 5
0408   8808 CA 73 93        jp z, recolocate_and_level_screen_5
0409   880B FE 06           cp 6
0410   880D CA 27 94        jp z, recolocate_and_level_screen_6
0411   8810 FE 07           cp 7
0412   8812 CA BE 94        jp z, recolocate_and_level_screen_7
0413   8815 FE 08           cp 8
0414   8817 CA 55 95        jp z, recolocate_and_level_screen_8
0415   881A FE 09           cp 9
0416   881C CA EC 95        jp z, recolocate_and_level_screen_9
0417   881F FE 0A           cp 10
0418   8821 CA 83 96        jp z, recolocate_and_level_screen_10
0419   8824 FE 0B           cp 11
0420   8826 CA 1A 97        jp z, recolocate_and_level_screen_11
0421   8829 FE 0C           cp 12
0422   882B CA B1 97        jp z, recolocate_and_level_screen_12
0423   882E FE 0D           cp 13
0424   8830 CA 34 88        jp z, is_final_screen
0425   8833             
0426   8833             
0427   8833 C9              ret
0428   8834             
0429   8834             is_final_screen: 
0430   8834                 ;sacamos de la pantalla al player
0431   8834 3E D4           ld a,212
0432   8836 DD 77 00        ld (ix+player.y),a
0433   8839 CD 43 8C        call render_player
0434   883C                 ;Sacamos a los enemigos
0435   883C CD 31 91        call sacar_sprites_de_pantalla
0436   883F CD E2 90        call render_enemies
0437   8842                 ;ponemos el juego en game over
0438   8842 3E 01           ld a,1
0439   8844 32 01 85        ld (game_over),a
0440   8847             
0441   8847 CD B4 98        call para_cancion
0442   884A 3E 03           ld a,3; le ponemos la música del final
0443   884C 32 04 85        ld (musica_activa),a
0444   884F CD 52 98        call inicilizar_tracker
0445   8852 CD C7 87        call clear_screen
0446   8855             
0447   8855 11 F2 88        ld de, message_congratulations 
0448   8858 06 01           ld b, 1;    posicón y
0449   885A 0E 00           ld c, 0;    posicón x
0450   885C CD 66 87        call graphics_print_sc2
0451   885F             
0452   885F 11 30 89        ld de, message_developer
0453   8862 06 04           ld b, 4;    posicón y
0454   8864 0E 04           ld c, 4;    posicón x
0455   8866 CD 66 87        call graphics_print_sc2
0456   8869             
0457   8869 11 1C 89        ld de, message_music
0458   886C 06 05           ld b, 5;    posicón y
0459   886E 0E 04           ld c, 4;    posicón x
0460   8870 CD 66 87        call graphics_print_sc2
0461   8873             
0462   8873 11 46 89        ld de, message_graphics
0463   8876 06 06           ld b, 6;    posicón y
0464   8878 0E 04           ld c, 4;    posicón x
0465   887A CD 66 87        call graphics_print_sc2
0466   887D             
0467   887D 11 D5 88        ld de, message_press_any_key_to_start 
0468   8880 06 0F           ld b, 15;    posicón y
0469   8882 0E 02           ld c, 2;    posicón x
0470   8884 CD 66 87        call graphics_print_sc2
0471   8887             
0472   8887             
0473   8887             ;.repetir_menu:
0474   8887             ;    ld a,0
0475   8887             ;    call GTTRIG
0476   8887             ;    cp 0
0477   8887             ;    jr z,.repetir_menu
0478   8887             ;hacemos una pekeña pausa
0479   8887 11 00 01        ld de,#100
0480   888A             .wait:     
0481   888A 76              halt
0482   888B 1B              dec de
0483   888C 7A              ld a,d
0484   888D B3              or e
0485   888E C2 8A 88        jp nz,.wait
0486   8891 CD 56 01        call KILBUF
0487   8894                 ;esperamos a que se pulse una tecla
0488   8894 CD 9F 00        call CHGET
0489   8897 CD 31 91        call sacar_sprites_de_pantalla
0490   889A C9              ret
0491   889B             
0492   889B             
0493   889B             
0494   889B             
0495   889B             message_level:  db "Level",0
0495   889B 4C6576656C00
0496   88A1             message_lives:  db "Lives",0
0496   88A1 4C6976657300
0497   88A7             message_score:  db "Score",0
0497   88A7 53636F726500
0498   88AD             message_msx_spain_presents:  db "MSXñSPAINñPRESENTS",0
0498   88AD 4D5358C3B1535041494EC3B150524553454E545300
0499   88C2             message_disco:  db "DISCO",0
0499   88C2 444953434F00
0500   88C8             message_start_game:  db "1.start game",0
0500   88C8 312E73746172742067616D6500
0501   88D5             message_press_any_key_to_start:  db "PRESSñSPACEñKEYñTOñSTART",0
0501   88D5 5052455353C3B15350414345C3B14B4559C3B1544FC3B1535441525400
0502   88F2             message_congratulations:  db "CONGRATULATIONS¡YOU¡FINISHED¡THE¡GAME",0
0502   88F2 434F4E47524154554C4154494F4E53C2A1594F55C2A146494E4953484544C2A1
0502   8912 544845C2A147414D4500
0503   891C             message_music:  db "MUSIC¡BY¡CLEMENTE",0
0503   891C 4D55534943C2A14259C2A1434C454D454E544500
0504   8930             message_developer:  db "DEVELOPER¡MSX¡SPAIN",0
0504   8930 444556454C4F504552C2A14D5358C2A1535041494E00
0505   8946             message_graphics:  db "GRAPHICS¡KIKE¡MADRIGAL",0
0505   8946 4752415048494353C2A14B494B45C2A14D4144524947414C00
0506   895F             
0507   895F 00          change_screen:  db 0
0508   8960             
0509   8960 00          map_buffer:  ds 704 ;768-64 es el mapa o tabla de nombres de VRAM copiada aquí
0510   8C20             MAPS_DIRECTION:  equ #c001
0511   8C20             MAP_SIZE:  equ 704 ;son 22 líneas de 32 bytes cada línea
0512   8C20             ;Store_Sprite_Collision: db 0
0513   8C20             COMIENZO_TILE_NUMEROS:  equ 86
0514   8C20             
0515   8C20 00          buffer_numeros:  ds 8
0516   8C28             TILE_DOOR:  equ 55
0517   8C28             TILE_SOLID:  equ 32
0518   8C28             TILE_BOTTLE1:  equ 56
0519   8C28             TILE_BOTTLE2:  equ 57
0520   8C28 00          tile_negro:  db 0
0521   8C29             
0522   8C29             UP:  equ 1
0523   8C29             DOWN:  equ 5
0524   8C29             LEFT:  equ 7
0525   8C29             RIGHT:  equ 3 
0526   8C29             
0527   8C29             
0528   8C29             
0529   8C29             
0530   8C29             ;Includes para sjasmplus
0531   8C29             	include "src/vars_msxBios.asm"    
0001+  8C29             ;ver las instruciones del z80: http://clrhome.org/table/
0002+  8C29             ;ver las instrucciones de la bios: https://map.grauw.nl/resources/msxbios.php
0003+  8C29             ;ver las instrucciones: https://www.msx.org/wiki/Z80_Assembler_for_Dummies
0004+  8C29             
0005+  8C29             ; use RST assembler mnemonic to call
0006+  8C29             CHKRAM equ 0x00 ; RST 0x00 > Check RAM and sets slot for command area.
0007+  8C29             SYNCHR equ 0x08 ; RST	0x08 > Checks if then current character pointed by HL is one desired.
0008+  8C29             CHRGTR equ 0x10 ; RST	0x10 > Gets the next character (or token) of the Basic-text
0009+  8C29             OUTDO  equ 0x18 ; RST	0x18 > Output to current outputchannel (printer, diskfile, etc.)
0010+  8C29             DCOMPR equ 0x20 ; RST	0x20 > Compares HL with DE
0011+  8C29             GETYPR equ 0x28 ; RST	0x28 > Returns Type of DAC
0012+  8C29             CALLF  equ 0x30 ; RST	0x30 > Executes an interslot call
0013+  8C29             KEYINT equ 0x38 ; RST	0x38 > Executes the timer interrupt process routine
0014+  8C29             
0015+  8C29             ; use CALL assembler mnemonic
0016+  8C29             RDSLT  equ 0x000C ; Reads the value of an address in another slot
0017+  8C29             WRSLT  equ 0x0014 ; Writes a value to an address in another slot
0018+  8C29             CALSLT equ 0x001C ; Executes inter-slot call
0019+  8C29             ENASLT equ 0x0024 ; Switches indicated slot at indicated page on perpetual
0020+  8C29             
0021+  8C29             ; Initialization-routines
0022+  8C29             INITIO equ 0x003B ; Initialises the device
0023+  8C29             INIFNK equ 0x003E ; Initialises the contents of the function keys
0024+  8C29             
0025+  8C29             ; VDP routines
0026+  8C29             DISSCR equ 0x0041 ; inhibits the screen display
0027+  8C29             ENASCR equ 0x0044 ; displays the screen
0028+  8C29             WRTVDP equ 0x0047 ; write data in the VDP-register, B  - Data to write, C  - Number of the register
0029+  8C29             RDVRM  equ 0x004A ; Reads the content of VRAM
0030+  8C29             WRTVRM equ 0x004D ; Writes data in VRAM
0031+  8C29             SETRD  equ 0x0050 ; Enable VDP to read
0032+  8C29             SETWRT equ 0x0053 ; Enable VDP to write
0033+  8C29             FILVRM equ 0x0056 ; fill VRAM with value
0034+  8C29             LDIRMV equ 0x0059 ; Block transfer to memory from VRAM
0035+  8C29             LDIRVM equ 0x005C ; Block transfer to VRAM from memory
0036+  8C29             CHGMOD equ 0x005F ; Switches to given screenmode
0037+  8C29             CHGCLR equ 0x0062 ; Changes the screencolors
0038+  8C29             CLRSPR equ 0x0069 ; Initialises all sprites
0039+  8C29             INITXT equ 0x006C ; Switches to SCREEN 0 (text screen with 40 * 24 characters)
0040+  8C29             INIT32 equ 0x006F ; Switches to SCREEN 1 (text screen with 32*24 characters)
0041+  8C29             INIGRP equ 0x0072 ; Switches to SCREEN 2 (high resolution screen with 256*192 pixels)
0042+  8C29             INIMLT equ 0x0075 ; Switches to SCREEN 3 (multi-color screen 64*48 pixels)
0043+  8C29             SETTXT equ 0x0078 ; Switches to VDP in SCREEN 0 mode
0044+  8C29             SETT32 equ 0x007B ; Switches VDP in SCREEN mode 1
0045+  8C29             SETGRP equ 0x007E ; Switches VDP to SCREEN 2 mode
0046+  8C29             SETMLT equ 0x0081 ; Switches VDP to SCREEN 3 mode
0047+  8C29             CALPAT equ 0x0084 ; Returns the address of the sprite pattern table
0048+  8C29             CALATR equ 0x0087 ; Returns the address of the sprite attribute table
0049+  8C29             GSPSIZ equ 0x008A ; Returns current sprite size
0050+  8C29             GRPPRT equ 0x008D ; Displays a character on the graphic screen
0051+  8C29             
0052+  8C29                     
0053+  8C29             ; PSG routines
0054+  8C29             GICINI equ 0x0090 ; Initialises PSG and sets initial value for the PLAY statement
0055+  8C29             WRTPSG equ 0x0093 ; Writes data to PSG-register
0056+  8C29             ;Input    : A  - PSG register number
0057+  8C29             ;           E  - Data write
0058+  8C29             RDPSG  equ 0x0096 ; Reads value from PSG-register
0059+  8C29             STRTMS equ 0x0099 ; Tests whether the PLAY statement is being executed as a background task. If not, begins to execute the PLAY statement  */
0060+  8C29             
0061+  8C29             ; Console routines, rutinas de consola
0062+  8C29             CHSNS  equ 0x009C ; Tests the status of the keyboard buffer
0063+  8C29             CHGET  equ 0x009F ; One character input (waiting)
0064+  8C29             CHPUT  equ 0x00A2 ; Displays one character
0065+  8C29             LPTOUT equ 0x00A5 ; Sends one character to printer
0066+  8C29             LPTSTT equ 0x00A8 ; Tests printer status
0067+  8C29             CNVCHR equ 0x00AB ; tests for the graphic header and transforms the code
0068+  8C29             PINLIN equ 0x00AE ; Stores in the specified buffer the character codes input until the return key or STOP key is pressed     */
0069+  8C29             INLIN  equ 0x00B1 ; Same as PINLIN except that AUGFLG (#F6AA) is set
0070+  8C29             QINLIN equ 0x00B4 ; Prints a questionmark andone space
0071+  8C29             BREAKX equ 0x00B7 ; Tests status of CTRL-STOP 
0072+  8C29             ISCNTC equ 0x00BA ; Tests status of SHIFT-STOP 
0073+  8C29             CKCNTC equ 0x00BD ; Same as ISCNTC. used in Basic
0074+  8C29             BEEP   equ 0x00C0 ; generates beep
0075+  8C29             BCLS   equ 0x00C3 ; Clears the screen
0076+  8C29             POSIT  equ 0x00C6 ; Places the cursor at the specified location
0077+  8C29             FNKSB  equ 0x00C9 ; Tests whether the function key display is active (FNKFLG)If so, displays them, otherwise erase them */
0078+  8C29             ERAFNK equ 0x00CC ; Erase functionkey display
0079+  8C29             DSPFNK equ 0x00CF ; Displays the function keys
0080+  8C29             TOTEXT equ 0x00D2 ; Forces the screen to be in the text mode
0081+  8C29             
0082+  8C29             ; Controller routines                      
0083+  8C29             GTSTCK equ 0x00D5 ; Returns the joystick status
0084+  8C29             GTTRIG equ 0x00D8 ; Returns current trigger status
0085+  8C29             GTPAD  equ 0x00DB ; Returns current touch pad status
0086+  8C29             GTPDL  equ 0x00DE ; Returns currenct value of paddle
0087+  8C29             
0088+  8C29             ; Tape device routines                      
0089+  8C29             TAPION equ 0x00E1 ; Reads the header block after turning the cassette motor on
0090+  8C29             TAPIN  equ 0x00E4 ; Read data from the tape
0091+  8C29             TAPIOF equ 0x00E7 ; Stops reading from the tape
0092+  8C29             TAPOON equ 0x00EA ; Turns on the cassette motor and writes the header
0093+  8C29             TAPOUT equ 0x00ED ; Writes data on the tape
0094+  8C29             TAPOOF equ 0x00F0 ; Stops writing on the tape
0095+  8C29             STMOTR equ 0x00F3 ; Sets the cassette motor action
0096+  8C29             
0097+  8C29             ; Queue routines                      
0098+  8C29             LFTQ equ 0x00F6 ; Gives number of bytes in queue
0099+  8C29             PUTQ equ 0x00F9 ; Put byte in queue
0100+  8C29             
0101+  8C29             ; Graphic routines
0102+  8C29             ;More info (MSX Assembly Page): http:;map.grauw.nl/resources/msxbios.php                      
0103+  8C29             RIGHTC equ 0x00FC ; Shifts screenpixel to the right
0104+  8C29             LEFTC  equ 0x00FF ; Shifts screenpixel to the left
0105+  8C29             UPC    equ 0x0102 ; Shifts screenpixel up
0106+  8C29             TUPC   equ 0x0105 ; Tests whether UPC is possible, if possible, execute UPC
0107+  8C29             DOWNC  equ 0x0108 ; Shifts screenpixel down
0108+  8C29             TDOWNC equ 0x010B ; Tests whether DOWNC is possible, if possible, execute DOWNC
0109+  8C29             SCALXY equ 0x010E ; Scales X and Y coordinates
0110+  8C29             MAPXY  equ 0x0111 ; Places cursor at current cursor address
0111+  8C29             FETCHC equ 0x0114 ; Gets current cursor addresses mask pattern
0112+  8C29             STOREC equ 0x0117 ; Record current cursor addresses mask pattern
0113+  8C29             SETATR equ 0x011A ; Set attribute byte
0114+  8C29             READC  equ 0x011E ; Reads attribute byte of current screenpixel
0115+  8C29             SETC   equ 0x0120 ; Returns currenct screenpixel of specificed attribute byte
0116+  8C29             NSETCX equ 0x0123 ; Set horizontal screenpixels
0117+  8C29             GTASPC equ 0x0126 ; Gets screen relations
0118+  8C29             PNTINI equ 0x0129 ; Initalises the PAINT instruction
0119+  8C29             SCANR  equ 0x012C ; Scans screenpixels to the right
0120+  8C29             SCANL  equ 0x012F ; Scans screenpixels to the left
0121+  8C29             
0122+  8C29             ; Graphic routines MSX2
0123+  8C29             ;More info (MSX Assembly Page): http:;map.grauw.nl/resources/msxbios.php#msx2bios
0124+  8C29             CHKNEW equ 0x0165 ;Tests screen mode > C-flag set if screenmode = 5, 6, 7 or 8
0125+  8C29             BIGFIL equ 0x016B ;fill VRAM with value (total VRAM can be reached) HL address, BC length, A data
0126+  8C29             NSETRD equ 0x016E ;Enable VDP to read.(with full 16 bits VRAM-address)
0127+  8C29             NSTWRT equ 0x0171 ;Enable VDP to write.(with full 16 bits VRAM-address) 
0128+  8C29             NRDVRM equ 0x0174 ;Reads VRAM like in RDVRM.(with full 16 bits VRAM-address)
0129+  8C29             NWRVRM equ 0x0177 ;Writes to VRAM like in WRTVRM.(with full 16 bits VRAM-address)
0130+  8C29             
0131+  8C29             
0132+  8C29             
0133+  8C29             
0134+  8C29             
0135+  8C29             
0136+  8C29                                  
0137+  8C29             ; Misc routines
0138+  8C29             CLIKSW equ 0xF3DB; para que no se oiga el click que hace al pulsar las teclas
0139+  8C29             CHGCAP equ 0x0132 ; Alternates the CAP lamp status
0140+  8C29             CHGSND equ 0x0135 ; Alternates the 1-bit sound port status
0141+  8C29             RSLREG equ 0x0138 ; Reads the primary slot register
0142+  8C29             WSLREG equ 0x013B ; Writes value to the primary slot register
0143+  8C29             RDVDP  equ 0x013E ; Reads VDP status register
0144+  8C29             SNSMAT equ 0x0141 ; Returns the value of the specified line from the keyboard matrix
0145+  8C29             ; 0   1          2           3           4           5           6           7           8       9       10
0146+  8C29             ;0    1          2                      4           5           6
0147+  8C29             ;1   ; fin grabr ' grabar                                                    Ñ
0148+  8C29             ;2                                      \grabar2  DEADfingrabar2 A           B
0149+  8C29             ;3 C                        F           G           H
0150+  8C29             ;4                          N
0151+  8C29             ;5 S                        V                       X                       Z
0152+  8C29             ;6SHIFtONTROL    GRAPH      CAPS        CODE
0153+  8C29             ;7              ESCAPE                              BS                      RET
0154+  8C29             ;8                                               Cursor ^    Cursor v
0155+  8C29             PHYDIO equ 0x0144 ; Executes I/O for mass-storage media like diskettes
0156+  8C29             FORMAT equ 0x0147 ; Initialises mass-storage media like formatting of diskettes
0157+  8C29             ISFLIO equ 0x014A ; Tests if I/O to device is taking place
0158+  8C29             OUTDLP equ 0x014E ; Printer output
0159+  8C29             GETVCP equ 0x0150 ; Returns pointer to play queue
0160+  8C29             GETVC2 equ 0x0153 ; Returns pointer to variable in queue number VOICEN (byte op #FB38)
0161+  8C29             KILBUF equ 0x0156 ; Clear keyboard buffer
0162+  8C29             CALBAS equ 0x0159 ; Executes inter-slot call to the routine in BASIC interpreter
0163+  8C29             
0164+  8C29             
0165+  8C29             
0166+  8C29                     
0167+  8C29             
0532   8C29             	include "src/vars_msxSystem.asm"    
0001+  8C29             ;ver las instrucciones del z80
0002+  8C29             ;ver las instruciones del z80: http://clrhome.org/table/
0003+  8C29             ;variables del sistema
0004+  8C29             ;https://www.msx.org/wiki/System_variables_and_work_area
0005+  8C29             
0006+  8C29             ;TRANSPARENT  equ  0
0007+  8C29             ;BLACK        equ  1
0008+  8C29             ;GREEN        equ  2
0009+  8C29             ;LIGHT_GREEN  equ  3
0010+  8C29             ;DARK_BLUE    equ  4
0011+  8C29             ;LIGHT_BLUE   equ  5
0012+  8C29             ;DARK_RED     equ  6
0013+  8C29             ;CYAN         equ  7
0014+  8C29             ;RED          equ  8
0015+  8C29             ;LIGHT_RED    equ  9
0016+  8C29             ;DARK_YELLOW  equ 10
0017+  8C29             ;LIGHT_YELLOW equ 11
0018+  8C29             ;DARK_GREEN   equ 12
0019+  8C29             ;MAGENTA      equ 13
0020+  8C29             ;GRAY         equ 14
0021+  8C29             ;GREY         equ 14
0022+  8C29             ;WHITE        equ 15
0023+  8C29             
0024+  8C29             COLOR_TRASPARENTE:  equ 0
0025+  8C29             COLOR_NEGRO:  equ 1
0026+  8C29             COLOR_VERDE_MEDIO:  equ 2
0027+  8C29             COLOR_VERDE_CLARO:  equ 3
0028+  8C29             COLOR_AZUL_OSCURO:  equ 4
0029+  8C29             COLOR_AZUL_MEDIO:  equ 5
0030+  8C29             COLOR_ROJO_OSCURO:  equ 6
0031+  8C29             COLOR_AZUL_CLARO: equ 7
0032+  8C29             COLOR_ROJO_MEDIO:  equ 8
0033+  8C29             COLOR_ROSA:  equ 9
0034+  8C29             COLOR_AMARILLO:  equ 10
0035+  8C29             COLOR_AMBAR:  equ 11
0036+  8C29             COLOR_VERDE_OSCURO:  equ 12
0037+  8C29             COLOR_LILA:  equ 13
0038+  8C29             COLOR_GRIS:  equ 14
0039+  8C29             COLOR_BLANCO:  equ 15
0040+  8C29             
0041+  8C29             ;Slots
0042+  8C29             ;---------
0043+  8C29             
0044+  8C29             ;SLOTs
0045+  8C29             SLOT0 equ #FCC1
0046+  8C29             SLOT1 equ #FCC2
0047+  8C29             SLOT2 equ #FCC3
0048+  8C29             SLOT3 equ #FCC4
0049+  8C29             
0050+  8C29             ;Interruptions
0051+  8C29             ;-------------------
0052+  8C29             ;Contiene el valor del reloj del software, cada interrupción del VDP se incrementa en 1
0053+  8C29             ;El contenido se puede leer o cambiar mediante la función 'TIME' o la instrucción 'TIME'
0054+  8C29             JIFFY  equ 0xFC9E
0055+  8C29             
0056+  8C29             ;Graphics
0057+  8C29             ;-------------------
0058+  8C29             gxpos equ 0xfcb3
0059+  8C29             gypos equ 0xfcb5
0060+  8C29             bios_line equ 0x58C1
0061+  8C29             
0062+  8C29             
0063+  8C29             ;VDP registers
0064+  8C29             ;------------------- 
0065+  8C29             RG0SAV equ 0xF3DF   ;System saves here the byte written to the register R#00, Used by VDP(0)
0066+  8C29             RG1SAV equ 0xF3E0   ;System saves here the byte written to the register R#01, Used by VDP(1)
0067+  8C29             RG2SAV equ 0xF3E1   ;System saves here the byte written to the register R#02, Used by VDP(2)
0068+  8C29             RG3SAV equ 0xF3E2   ;System saves here the byte written to the register R#03, Used by VDP(3)
0069+  8C29             RG4SAV equ 0xF3E3   ;System saves here the byte written to the register R#04, Used by VDP(4)
0070+  8C29             RG5SAV equ 0xF3E4   ;System saves here the byte written to the register R#05, Used by VDP(5)
0071+  8C29             RG6SAV equ 0xF3E5   ;System saves here the byte written to the register R#06, Used by VDP(6)
0072+  8C29             RG7SAV equ 0xF3E6   ;System saves here the byte written to the register R#07.at start, Used by VDP(7)
0073+  8C29             STATFL equ 0xF3E7   ;System saves here the byte read from the status register R#00, Used by VDP(0)
0074+  8C29             
0075+  8C29             ;Screen Parameters
0076+  8C29             FORCLR equ 0xF3E9     ;Foreground colour
0077+  8C29             BAKCLR equ 0xF3EA     ;Background colour
0078+  8C29             BDRCLR equ 0xF3EB     ;Border colour
0079+  8C29             LINL40 equ 0xF3AE     ;Screen width per line in SCREEN 0 (Default 39)
0080+  8C29             LINL32 equ 0xF3AF     ;Screen width per line in SCREEN 1 (Default 29)
0081+  8C29             LINLEN equ 0xF3B0     ;Current screen width per line
0082+  8C29             CRTCNT equ 0xF3B1     ;Number of lines of current screen (default 24)
0083+  8C29             CLMLST equ 0xF3B2     ;X-location in the case that items are divided by commas in PRINT. (LINLEN-(LINLEN MOD 14)-14)
0084+  8C29             TXTNAM equ 0xF3B3     ;SCREEN 0 pattern name tabte address
0085+  8C29             TXTCOL equ 0xF3B5     ;SCREEN 0 color table address
0086+  8C29             TXTCGP equ 0xF3B7     ;SCREEN 0 Pattern generator table address
0087+  8C29             TXTATR equ 0xF3B9     ;Unused
0088+  8C29             TXTPAT equ 0xF3BB     ;Unused
0089+  8C29             T32NAM equ 0xF3BD     ;SCREEN 1 pattern name table address
0090+  8C29             T32COL equ 0xF3BF     ;SCREEN 1 color table address
0091+  8C29             T32CGP equ 0xF3C1     ;SCREEN 1 pattern ganarator table address
0092+  8C29             T32ATR equ 0xF3C3     ;SCREEN 1 sprite attribute table address
0093+  8C29             T32PAT equ 0xF3C5     ;SCREEN 1 sprite generator table address
0094+  8C29             GRPNAM equ 0xF3C7     ;SCREEN 2 pattern name table address
0095+  8C29             GRPCOL equ 0xF3C9     ;SCREEN 2 color table address
0096+  8C29             GRPCGP equ 0xF3CB     ;SCREEN 2 pattern generator table address
0097+  8C29             GRPATR equ 0xF3CD     ;SCREEN 2 sprite attribute table address
0098+  8C29             GRPPAT equ 0xF3CF     ;SCREEN 2 sprite generator table address
0099+  8C29             MLTNAM equ 0xF3D1     ;SCREEN 3 pattern name tabte address
0100+  8C29             MLTCOL equ 0xF3D3     ;SCREEN 3 color table address
0101+  8C29             MLTCGP equ 0xF3D5     ;SCREEN 3 pattern generator table address
0102+  8C29             MLTATR equ 0xF3D7     ;SCREEN 3 sprite attribute table address
0103+  8C29             MLTPAT equ 0xF3D9     ;SCREEN 3 sprite generator table address
0104+  8C29             TRCFLG equ 0xF7C4     ;Tracing flag. 0 = No tracing; Other = Tracing in progress
0105+  8C29             CGPNT  equ 0xF91F     ;Location of the character font used to initialise screen 
0106+  8C29                                   ;CGPNT = Slot ID
0107+  8C29                                   ;CGPNT+1 = Address
0108+  8C29             NAMBAS	equ 0xF922    ;Current pattern name table address
0109+  8C29             CGPBAS	equ 0xF924    ;Current pattern generator table address
0110+  8C29             PATBAS	equ 0xF926    ;Current sprite generator table address
0111+  8C29             ATRBAS	equ 0xF928    ;Current sprite attribute table address
0112+  8C29             CLOC	equ 0xF92A    ;Graphic cursor location
0113+  8C29             CMASK	equ 0xF92C    ;Graphic cursor mask (SCREEN 2 to 4) or ordinate (SCREEN 5 to 12)
0114+  8C29             DPPAGE	equ 0xFAF5    ;Displayed page number. (MSX2~)Modified by SETPAGE X
0115+  8C29             ACPAGE	equ 0xFAF6    ;Destination page number. (MSX2~)Modified by SETPAGE ,X
0116+  8C29             MODE	equ 0xFAFC    ;Flag for screen mode
0117+  8C29                                 ;bit 7: 1 = conversion to Katakana; 0 = conversion to Hiragana. (MSX2+~)
0118+  8C29                                 ;bit 6: 1 if Kanji ROM level 2. (MSX2+~)
0119+  8C29                                 ;bit 5: 0/1 to draw in RGB / YJK mode SCREEN 10 or 11. (MSX2+~)
0120+  8C29                                 ;bit 4: 0/1 to limit the Y coordinate to 211/255. (MSX2+~)
0121+  8C29                                 ;bit 3: 1 to apply the mask in SCREEN 0~3
0122+  8C29                                 ;bits 1-2: VRAM size
0123+  8C29                                 ;	   00 for 16kB
0124+  8C29                                 ;	   01 for 64kB
0125+  8C29                                 ;	   10 for 128kB
0126+  8C29                                 ;	   11 for 192kB
0127+  8C29                                 ;bit 0: 1 if the conversion of Romaji to Kana is possible. (MSX2~)
0128+  8C29             LINWRK	equ 0xFC18    ;40	Work area for screen management
0129+  8C29             PATWRK	equ 0xFC40    ;8	Returned character pattern by the routine GETPAT
0130+  8C29             GRPHED	equ 0xFCA6    ;1	Heading for the output of graphic characters
0131+  8C29             SCRMOD	equ 0xFCAF    ;1	Screen mode
0132+  8C29             OLDSCR	equ 0xFCB0    ;1	Old screen mode
0133+  8C29             NORUSE	equ 0xFAFD    ;1	Used by KANJI-ROM for rendering KANJI fonts in graphic modes. (MSX2~)
0134+  8C29                                 ;bit 7 Don't return to textmode
0135+  8C29                                 ;bit 6 if 1 and F7F4h (DECCNT)=0, read SHIFT status ???
0136+  8C29                                 ;bit 5 Disable some functinality
0137+  8C29                                 ;bit 4 Not in use	
0138+  8C29                                 ;bit 3 color 0 = Transparent
0139+  8C29                                 ;bit 0-2: Logical operation on kanji font draw
0140+  8C29                                 ;	  0 for PSET
0141+  8C29                                 ;	  1 for AND
0142+  8C29                                 ;	  2 for OR
0143+  8C29                                 ;	  3 for XOR
0144+  8C29                                 ;	  4 for NOT
0145+  8C29             LOGOPR  equ 0xFB02        ;1	Logical operation code. (MSX2~)
0146+  8C29             GXPOS	equ 0xFCB3        ;2	X-position of graphic cursor
0147+  8C29             GYPOS	equ 0xFCB5        ;2	Y-position of graphic cursor
0148+  8C29             GRPACX  equ 0xFCB7        ;2	X Graphics Accumulator, posicionar cursor en modo gráfico    
0149+  8C29             GRPACY  equ 0xFCB9        ;2	Y Graphics Accumulator, posicionar cursor en modo gráfico    
0150+  8C29             
0533   8C29             	include "src/MSXBasic/player.asm"    
0001+  8C29             ;player_atributes: ds 4,0
0002+  8C29             player_atributes: 
0003+  8C29                 struct player 
0004+  8C29~            y           db    0
0005+  8C29~            x           db    0
0006+  8C29~            pattern_def db    0; el player tendrá el patrón 0, el player 2*4=8, el enemy 1 el 3*12=12, estos patrones deben de coincidi con los dibujos de sprites que hemos dibujado
0007+  8C29~            color       db    0
0008+  8C29~            direction   db    0
0009+  8C29~            collision   db    0
0010+  8C29                 ends
0011+  8C29 00          tile0:  db 0
0012+  8C2A             
0013+  8C2A             
0014+  8C2A             create_player: 
0015+  8C2A DD 21 29 8C     ld ix, player_atributes
0016+  8C2E 3E 96           ld a,150
0017+  8C30 DD 77 00        ld (ix+player.y),a ;le ponemos a la posición y un 160
0018+  8C33 3E 08           ld a,8
0019+  8C35 DD 77 01        ld (ix+player.x),a ;le ponemos a la posición x 120
0020+  8C38 3E 00           ld a,0
0021+  8C3A DD 77 02        ld (ix+player.pattern_def),a ;Le ponemos el patrón 0
0022+  8C3D 3E 0B           ld a,11 ; el 11 es el color amarillo
0023+  8C3F DD 77 03        ld (ix+player.color),a 
0024+  8C42 C9              ret
0025+  8C43             render_player: 
0026+  8C43 21 29 8C        ld hl, player_atributes 
0027+  8C46 11 00 1B        ld de, 6912 ;#1b00 dirección tabla de atributos en VRAM    
0028+  8C49 01 04 00        ld bc, 4; 4 bytes para copiar
0029+  8C4C CD 5C 00        call  LDIRVM 
0030+  8C4F C9              ret
0031+  8C50             update_player: 
0032+  8C50 AF              xor a
0033+  8C51 CD D5 00        call GTSTCK
0034+  8C54                 ;call Readjoystick
0035+  8C54 FE 01           cp 1
0036+  8C56 CA D1 8C        jp z, move_player_up
0037+  8C59                 ;cp 2
0038+  8C59                 ;jp z, move_player_up_right
0039+  8C59 FE 03           cp 3
0040+  8C5B CA 69 8C        jp z, move_player_right
0041+  8C5E                 ;cp 4
0042+  8C5E                 ;jp z, move_player_down_right
0043+  8C5E FE 05           cp 5
0044+  8C60 CA 05 8D        jp z, move_player_down
0045+  8C63                 ;cp 6
0046+  8C63                 ;jp z, move_player_down_left
0047+  8C63 FE 07           cp 7
0048+  8C65 CA 9D 8C        jp z, move_player_left
0049+  8C68                 ;cp 8
0050+  8C68                 ;jp z, move_player_up_left
0051+  8C68                 ;ld a,(player.collision)
0052+  8C68                 ;cp 1
0053+  8C68                 ;jp z,HUD
0054+  8C68             .update_player_end: 
0055+  8C68 C9              ret
0056+  8C69             
0057+  8C69             
0058+  8C69             move_player_right: 
0059+  8C69                 ;Le metemos la dirección al player
0060+  8C69 3E 03           ld a,RIGHT
0061+  8C6B DD 77 04        ld (ix+player.direction),a
0062+  8C6E             
0063+  8C6E                 ;comprobamos los límites de la pantalla
0064+  8C6E DD 7E 01        ld a,(ix+player.x)
0065+  8C71 FE F0           cp 240
0066+  8C73 28 1C           jr z,.move_player_right_end
0067+  8C75             
0068+  8C75                 ;Comprobamos las colisones
0069+  8C75 CD 39 8D        call check_collision_player
0070+  8C78 DD 7E 05        ld a,(ix+player.collision)
0071+  8C7B FE 01           cp 1
0072+  8C7D 28 12           jr z, .move_player_right_end; si hay colisón saltamos la parte siguiente  hacemos que vaya al final
0073+  8C7F             
0074+  8C7F DD 7E 01        ld a,(ix+player.x); obtenemos el valor actual de la posicion x
0075+  8C82 C6 01           add 1; incrementamos en 1 el valor
0076+  8C84 DD 77 01        ld (ix+player.x), a ; se lo metemos al atributo posicion X
0077+  8C87 E6 01           and 1
0078+  8C89 CA 97 8C        jp z, right_es_impar
0079+  8C8C 3E 00           ld a, 0
0080+  8C8E DD 77 02        ld (ix+player.pattern_def),a ;le metemos el sprite que mira hacia la derecha 2
0081+  8C91             .move_player_right_end: 
0082+  8C91 3E 00           ld a,0
0083+  8C93 DD 77 05        ld (ix+player.collision),a
0084+  8C96 C9              ret
0085+  8C97             
0086+  8C97                 
0087+  8C97             right_es_impar: 
0088+  8C97 3E 04           ld a, 1*4
0089+  8C99 DD 77 02        ld (ix+player.pattern_def),a ;le metemos el sprite que mira hacia la derecha 2
0090+  8C9C             
0091+  8C9C C9              ret
0092+  8C9D             move_player_left: 
0093+  8C9D                 ;le ponemos la dirección
0094+  8C9D 3E 07           ld a,LEFT
0095+  8C9F DD 77 04        ld (ix+player.direction),a
0096+  8CA2             
0097+  8CA2                 ;comprobamos los límites de la pantalla
0098+  8CA2 DD 7E 01        ld a,(ix+player.x)
0099+  8CA5 FE 00           cp 0
0100+  8CA7 28 1C           jr z,.move_player_left_end
0101+  8CA9             
0102+  8CA9                 ;comprobamos las colisiones
0103+  8CA9 CD 39 8D        call check_collision_player
0104+  8CAC                 ;su hubo uno colisión saltamos y vamos a la parte final
0105+  8CAC DD 7E 05        ld a,(ix+player.collision)
0106+  8CAF FE 01           cp 1
0107+  8CB1 28 12           jr z, .move_player_left_end
0108+  8CB3 DD 7E 01        ld a,(ix+player.x)
0109+  8CB6 D6 01           sub 1  
0110+  8CB8 DD 77 01        ld (ix+player.x), a 
0111+  8CBB E6 01           and 1
0112+  8CBD CA CB 8C        jp z, left_es_impar
0113+  8CC0 3E 08           ld a, 2*4 
0114+  8CC2 DD 77 02        ld (ix+player.pattern_def),a
0115+  8CC5             .move_player_left_end: 
0116+  8CC5 3E 00           ld a,0
0117+  8CC7 DD 77 05        ld (ix+player.collision),a
0118+  8CCA C9              ret
0119+  8CCB             left_es_impar: 
0120+  8CCB 3E 0C           ld a, 3*4
0121+  8CCD DD 77 02        ld (ix+player.pattern_def),a 
0122+  8CD0 C9              ret
0123+  8CD1             move_player_up: 
0124+  8CD1                 ;le ponemos la dirección
0125+  8CD1 3E 01           ld a,UP
0126+  8CD3 DD 77 04        ld (ix+player.direction),a
0127+  8CD6             
0128+  8CD6                 ;comprobamos los límites de la pantalla
0129+  8CD6 DD 7E 00        ld a,(ix+player.y)
0130+  8CD9 FE 00           cp 0; 
0131+  8CDB 28 1C           jr z,.move_player_up_end
0132+  8CDD             
0133+  8CDD                 ;comprobamos las colisiones
0134+  8CDD CD 39 8D        call check_collision_player
0135+  8CE0                 ;si hubo uno colisión saltamos y vamos a la parte final
0136+  8CE0 DD 7E 05        ld a,(ix+player.collision)
0137+  8CE3 FE 01           cp 1
0138+  8CE5 28 12           jr z, .move_player_up_end
0139+  8CE7                 
0140+  8CE7                 ;actualizamos el player
0141+  8CE7 DD 7E 00        ld a,(ix+player.y)
0142+  8CEA D6 01           sub 1 
0143+  8CEC DD 77 00        ld (ix+player.y), a 
0144+  8CEF                 ;Ponemos el sprite correspondiente
0145+  8CEF E6 01           and 1
0146+  8CF1 CA FF 8C        jp z, up_es_impar
0147+  8CF4 3E 10           ld a, 4*4
0148+  8CF6 DD 77 02        ld (ix+player.pattern_def),a
0149+  8CF9             .move_player_up_end: 
0150+  8CF9 3E 00           ld a,0
0151+  8CFB DD 77 05        ld (ix+player.collision),a
0152+  8CFE C9              ret
0153+  8CFF             up_es_impar: 
0154+  8CFF 3E 14           ld a, 5*4
0155+  8D01 DD 77 02        ld (ix+player.pattern_def),a 
0156+  8D04 C9              ret
0157+  8D05             move_player_down: 
0158+  8D05                 ;le ponemos la dirección
0159+  8D05 3E 05           ld a,DOWN
0160+  8D07 DD 77 04        ld (ix+player.direction),a
0161+  8D0A             
0162+  8D0A                 ;comprobamos los límites de la pantalla
0163+  8D0A DD 7E 00        ld a,(ix+player.y)
0164+  8D0D FE 9F           cp 159; 192-8-8-16-2
0165+  8D0F 28 1C           jr z,.move_player_down_end
0166+  8D11             
0167+  8D11             
0168+  8D11 CD 39 8D        call check_collision_player
0169+  8D14                 ;si hubo uno colisión saltamos y vamos a la parte final
0170+  8D14 DD 7E 05        ld a,(ix+player.collision)
0171+  8D17 FE 01           cp 1
0172+  8D19 28 12           jr z, .move_player_down_end
0173+  8D1B             
0174+  8D1B DD 7E 00        ld a,(ix+player.y)
0175+  8D1E C6 01           add 1 
0176+  8D20 DD 77 00        ld (ix+player.y), a 
0177+  8D23 E6 01           and 1
0178+  8D25 CA 33 8D        jp z, down_es_impar
0179+  8D28 3E 18           ld a, 6*4
0180+  8D2A DD 77 02        ld (ix+player.pattern_def),a
0181+  8D2D             .move_player_down_end: 
0182+  8D2D 3E 00           ld a,0
0183+  8D2F DD 77 05        ld (ix+player.collision),a
0184+  8D32 C9              ret
0185+  8D33             down_es_impar: 
0186+  8D33 3E 1C           ld a, 7*4
0187+  8D35 DD 77 02        ld (ix+player.pattern_def),a 
0188+  8D38 C9              ret
0189+  8D39             
0190+  8D39             
0191+  8D39             ;;--------------------------------------
0192+  8D39             ;;  CHECKCOLISION
0193+  8D39             ;;      Output: si hay colsión mete en la variable player.colision=1
0194+  8D39             check_collision_player: 
0195+  8D39 21 29 8C        ld hl, player_atributes
0196+  8D3C 7E              ld a,(hl)
0197+  8D3D 5F              ld e,a;y
0198+  8D3E 23              inc hl
0199+  8D3F 7E              ld a,(hl)
0200+  8D40 57              ld d,a;x
0201+  8D41             
0202+  8D41 DD 7E 04        ld a,(ix+player.direction)
0203+  8D44 FE 03           cp RIGHT
0204+  8D46 28 0E           jr z,.get_block_right
0205+  8D48 FE 07           cp LEFT
0206+  8D4A 28 11           jr z,.get_block_left
0207+  8D4C FE 01           cp UP
0208+  8D4E 28 14           jr z,.get_block_up
0209+  8D50 FE 05           cp DOWN
0210+  8D52 28 17           jr z,.get_block_down
0211+  8D54             
0212+  8D54 18 19           jr .not_direction_found
0213+  8D56             .get_block_right: 
0214+  8D56 7A              ld a,d
0215+  8D57 C6 04           add 4
0216+  8D59 57              ld d,a
0217+  8D5A C3 6F 8D        jp .not_direction_found
0218+  8D5D             .get_block_left: 
0219+  8D5D 7A              ld a,d
0220+  8D5E D6 04           sub 4
0221+  8D60 57              ld d,a
0222+  8D61 C3 6F 8D        jp .not_direction_found
0223+  8D64             .get_block_up: 
0224+  8D64 7B              ld a,e
0225+  8D65 D6 08           sub 8
0226+  8D67 5F              ld e,a
0227+  8D68 C3 6F 8D        jp .not_direction_found
0228+  8D6B             .get_block_down: 
0229+  8D6B 7B              ld a,e
0230+  8D6C C6 01           add 1
0231+  8D6E 5F              ld e,a
0232+  8D6F             
0233+  8D6F             
0234+  8D6F             .not_direction_found: 
0235+  8D6F                 ;get_block necesita en el registro e la posición x y en d la posición y, devuelve el resultado en b
0236+  8D6F CD 88 86        call get_block
0237+  8D72 78              ld a,b
0238+  8D73 FE 37           cp TILE_DOOR
0239+  8D75 CA D3 87        jp z,increase_screen
0240+  8D78 FE 38           cp TILE_BOTTLE1 ;Si al restalo entre 32 da negatico se activará el flag de carry
0241+  8D7A 28 1D           jr Z, botella_cogida ; si al restarlo  es negativo y dará carry, si no hay está bien
0242+  8D7C FE 39           cp TILE_BOTTLE2 ;Si al restalo entre 32 da negatico se activará el flag de carry
0243+  8D7E 28 19           jr Z, botella_cogida ; si al restarlo  es negativo y dará carry, si no hay está bien
0244+  8D80 FE 20           cp TILE_SOLID ;Si al restalo entre 32 da negatico se activará el flag de carry
0245+  8D82 30 01           jr nc, colision_player ; si al restarlo  es negativo y dará carry, si no hay está bien
0246+  8D84             
0247+  8D84 C9              ret
0248+  8D85             
0249+  8D85             colision_player: 
0250+  8D85 CD C8 98        call efecto_golpe
0251+  8D88 3E 01           ld a,1
0252+  8D8A DD 77 05        ld (ix+player.collision),a
0253+  8D8D C9              ret
0254+  8D8E                 
0255+  8D8E             recolocate_player: 
0256+  8D8E 3E 96           ld a,150
0257+  8D90 DD 77 00        ld (ix+player.y),a
0258+  8D93 3E 08           ld a,8
0259+  8D95 DD 77 01        ld (ix+player.x),a
0260+  8D98                 ;call update_player
0261+  8D98 C9              ret
0262+  8D99             botella_cogida: 
0263+  8D99 CD DD 98        call efecto_coge_botella
0264+  8D9C                 ;ponemos en ese tile un tile negro
0265+  8D9C DD 7E 00        ld a,(ix+player.y) ;a=posicion y en pixeles
0266+  8D9F C6 10           add 16
0267+  8DA1                 ;con srl estas dividiendo entre 2,ya que corre a la derecha los bits. 
0268+  8DA1                 ;al hacerlo 3 veces es como dividir entre 8,a=y/8: 1.01001100, 2.00100110, 3.00010011
0269+  8DA1 CB 3F           srl a  
0270+  8DA3 CB 3F           srl a  
0271+  8DA5 CB 3F           srl a  
0272+  8DA7 26 00           ld h,0 ; en h le ponemos un 0 
0273+  8DA9 6F              ld l,a ;y en los 8 bytes de "l" le ponemos el valor que contiene a
0274+  8DAA                 ;;-----------------
0275+  8DAA                 ;Buscando la fila
0276+  8DAA 29              add hl, hl ;x32, sumar algo por si mismo es como multiplizarlo por 2, si lo repetivos 5 es como si o multiplixaramos por 32
0277+  8DAB 29              add hl, hl 
0278+  8DAC 29              add hl, hl 
0279+  8DAD 29              add hl, hl 
0280+  8DAE 29              add hl, hl 
0281+  8DAF             
0282+  8DAF             
0283+  8DAF DD 7E 01        ld a,(ix+player.x)
0284+  8DB2 C6 08           add 8
0285+  8DB4 CB 3F           srl a 
0286+  8DB6 CB 3F           srl a 
0287+  8DB8 CB 3F           srl a 
0288+  8DBA 16 00           ld d,0
0289+  8DBC 5F              ld e,a ;e=x
0290+  8DBD 19              add hl,de ;hl=(y/8)*32+(x/8)
0291+  8DBE             
0292+  8DBE                 ;actualizamos el buffer
0293+  8DBE E5              push hl
0294+  8DBF 11 60 89        ld de, map_buffer
0295+  8DC2 19              add hl,de
0296+  8DC3 EB              ex de,hl
0297+  8DC4 21 28 8C        ld hl, tile_negro
0298+  8DC7 01 01 00        ld bc, 1
0299+  8DCA ED B0           ldir
0300+  8DCC E1              pop hl
0301+  8DCD             
0302+  8DCD 11 00 18        ld de, 6144
0303+  8DD0 19              add hl, de
0304+  8DD1 EB              ex de,hl
0305+  8DD2                 
0306+  8DD2             
0307+  8DD2 21 28 8C        ld hl, tile_negro
0308+  8DD5 01 01 00        ld bc, 1
0309+  8DD8 CD 5C 00        call LDIRVM
0310+  8DDB             
0311+  8DDB                 ;actualizamos el score
0312+  8DDB 3A 03 85        ld a,(score)
0313+  8DDE C6 01           add 1
0314+  8DE0 32 03 85        ld (score),a
0315+  8DE3 CD AC 86        call hud
0316+  8DE6             
0317+  8DE6 C9              ret
0534   8DE7             	include "src/MSXBasic/enemies.asm"    
0001+  8DE7                 struct enemy 
0002+  8DE7~            y           db      0
0003+  8DE7~            x           db      0
0004+  8DE7~            pattern_def db      0; los patrones definicidos será el 0 para el player, el 4 para el player 2, el 8 para el enemy 1,etc
0005+  8DE7~            color       db      0
0006+  8DE7~            plane       db      0; como con 4 bytes se define un plano en la tabla de atributos de sprites, el player tiene el plano 0, el player 2 el plano 4, el enemy 1 el plano 8
0007+  8DE7~            direction   db      0; la dirección puede cambiar su el comportamiento dice que cambie
0008+  8DE7~            type        db      0; según el tipo le aplicaemos un comportamiento u otro
0009+  8DE7~            counter     db      0; nos ayuda con las animaciones
0010+  8DE7~            frame       db      0; nos auyda con las animaciones
0011+  8DE7                 ends
0012+  8DE7             
0013+  8DE7             template_enemy1: 
0014+  8DE7 3C              db 60
0015+  8DE8 A0              db 160
0016+  8DE9 20              db ENEMIGO_COLETA
0017+  8DEA 05              db COLOR_AZUL_MEDIO
0018+  8DEB 18              db 6*4; plano 4*4 bytes
0019+  8DEC 01              db UP;direction
0020+  8DED 02              db COMPORTAMIENTO_REBOTA_VERTICAL
0021+  8DEE 00              db 0
0022+  8DEF 00              db 0
0023+  8DF0             
0024+  8DF0             template_enemy2: 
0025+  8DF0 64              db 100
0026+  8DF1 8C              db 140
0027+  8DF2 70              db ENEMIGO_ENANO_DERECHA
0028+  8DF3 04              db COLOR_AZUL_OSCURO;color azul oscuro
0029+  8DF4 0C              db 3*4; plano 2*4 bytes
0030+  8DF5 03              db RIGHT;;direction
0031+  8DF6 03              db COMPORTAMIENTO_REBOTA_HORIZONTAL
0032+  8DF7 00              db 0
0033+  8DF8 00              db 0
0034+  8DF9             template_enemy3: 
0035+  8DF9 90              db 144
0036+  8DFA E6              db 230
0037+  8DFB 40              db ENEMIGO_CABEZON
0038+  8DFC 06              db COLOR_ROJO_OSCURO
0039+  8DFD 10              db 4*4; plano 3*4 bytes
0040+  8DFE 03              db RIGHT;;direction
0041+  8DFF 03              db COMPORTAMIENTO_REBOTA_HORIZONTAL
0042+  8E00 00              db 0
0043+  8E01 00              db 0
0044+  8E02             template_enemy4: 
0045+  8E02 98              db 152
0046+  8E03 BE              db 190
0047+  8E04 58              db ENEMIGO_PANZON+8
0048+  8E05 0A              db COLOR_AMARILLO
0049+  8E06 14              db 5*4; plano 4*4 bytes
0050+  8E07 03              db RIGHT;direction
0051+  8E08 00              db COMPORTAMIENTO_CORRE_DE_IZQUIERDA_A_DERCHA
0052+  8E09 00              db 0
0053+  8E0A 00              db 0
0054+  8E0B             template_enemy5: 
0055+  8E0B 82              db 130
0056+  8E0C EF              db 239; en la 1 pantalla empezará en la posición x 230, el límite derecho es 240
0057+  8E0D 50              db ENEMIGO_PANZON
0058+  8E0E 0C              db COLOR_VERDE_OSCURO
0059+  8E0F 08              db 2*4; plano 1*4 bytes
0060+  8E10 03              db RIGHT;direction
0061+  8E11 03              db COMPORTAMIENTO_REBOTA_HORIZONTAL;type
0062+  8E12 00              db 0
0063+  8E13 00              db 0
0064+  8E14             template_enemy6: 
0065+  8E14 78              db 120
0066+  8E15 78              db 120
0067+  8E16 30              db ENEMIGO_GORDO
0068+  8E17 08              db COLOR_ROJO_MEDIO
0069+  8E18 1C              db 7*4; plano 4*4 bytes
0070+  8E19 03              db RIGHT;direction
0071+  8E1A 03              db COMPORTAMIENTO_REBOTA_HORIZONTAL
0072+  8E1B 00              db 0
0073+  8E1C 00              db 0
0074+  8E1D             SIZE_OF_ENEMY equ 9
0075+  8E1D             MAX_ENEMIES equ 6
0076+  8E1D 00          enemy_active:  db 0; nos permite hacer el loop y en update_enemies y cuando llegue a MAX_EMIES salimos del update_enemies
0077+  8E1E             
0078+  8E1E             
0079+  8E1E             ;reservamos espacio para 10 enemigos
0080+  8E1E             ;max_enemies equ 10
0081+  8E1E             ;array_enimies: ds enemy*max_enemies ;son 7 bytes * 10 entidades de enemigos=70 bytes, si te fijas enemy vale el tamaño del struct
0082+  8E1E 00          counter_enemy:  db 0
0083+  8E1F             ;randData solo es utilizada por la rutina random
0084+  8E1F 00 00       randData:  db 0,0
0085+  8E21             MAX_RETARDO_REDIBUJADO equ 30
0086+  8E21             
0087+  8E21             
0088+  8E21             
0089+  8E21             ENEMIGO_COLETA:      equ 32;8 ,9,10 y 11*4 el octavo sprite
0090+  8E21             ENEMIGO_GORDO:       equ 48;el sprute 12, 13,14 y 15*4
0091+  8E21             ENEMIGO_CABEZON:     equ 64;sprite 16*4
0092+  8E21             ENEMIGO_PANZON:      equ 80;sprite 20*4
0093+  8E21             ENEMIGO_GORRA:       equ 96;sprite 24*4
0094+  8E21             ENEMIGO_ENANO_DERECHA:       equ 112;sprite 28*4
0095+  8E21             ENEMIGO_ENANO_DIZQUIERDA:       equ 120;sprite 28*4
0096+  8E21             ENEMIGO_VIRUS1:      equ 128;sprite 32*4
0097+  8E21             ENEMIGO_VIRUS2:      equ 144;sprite 36*4
0098+  8E21             ENEMIGO_VIRUS3:      equ 160;sprite 40*4
0099+  8E21             ENEMIGO_VIRUS4:      equ 176;sprite 44*4
0100+  8E21             
0101+  8E21             COMPORTAMIENTO_CORRE_DE_IZQUIERDA_A_DERCHA:  equ 0
0102+  8E21             COMPORTAMIENTO_CORRE_DE_DERECHA_A_IZQUIERDA:  equ 1
0103+  8E21             COMPORTAMIENTO_REBOTA_HORIZONTAL:  equ 3
0104+  8E21             COMPORTAMIENTO_REBOTA_VERTICAL:  equ 2
0105+  8E21             COMPORTAMIENTO_PERSIGUE:  equ 5
0106+  8E21             COMPORTAMIENTO_STATICO:  equ 6
0107+  8E21             COMPORTAMIENTO_BAILA:  equ 7
0108+  8E21             
0109+  8E21             
0110+  8E21             
0111+  8E21             initialize_enemy:  
0112+  8E21                 ;ld hl, template_enemy
0113+  8E21                 ;ld de, array_enimies*counter_enemy
0114+  8E21                 ;ld bc, (counter_enemy*enemy)
0115+  8E21                 ;ldir
0116+  8E21 C9              ret
0117+  8E22             
0118+  8E22             create_enemy: 
0119+  8E22                 ;ld iy, template_enemy0
0120+  8E22                 ;ld a,(counter_enemy)
0121+  8E22                 ;add SIZE_OF_ENEMY
0122+  8E22                 ;ld (counter_enemy),a    
0123+  8E22 C9              ret
0124+  8E23             
0125+  8E23             
0126+  8E23             update_enemies: 
0127+  8E23                 ;inicializamos la posición de la memoria donde empiezan nuestras entidades
0128+  8E23 FD 21 E7 8D     ld iy,template_enemy1
0129+  8E27                 ;ponemos a 0 la entidad activa
0130+  8E27 AF              xor a
0131+  8E28 32 1D 8E        ld (enemy_active),a
0132+  8E2B             ;blucle FOR:recorre las entidades desde 0 a MAX_ENTITIES-1
0133+  8E2B             .loop: 
0134+  8E2B                 ;Obtenemos la entidad activa
0135+  8E2B 3A 1D 8E        ld a,(enemy_active)
0136+  8E2E                 ;si ha llegado al final salimos
0137+  8E2E FE 06           cp MAX_ENEMIES
0138+  8E30 28 3C           jr z,.update_enemies_end
0139+  8E32                 ;Si no ha llegado al final incrementamos el contador de la entidad activa
0140+  8E32 3C              inc a
0141+  8E33 32 1D 8E        ld (enemy_active),a
0142+  8E36                 ;Obtenemos su tipo con el puntero iy
0143+  8E36 FD 7E 06        ld a,(iy+enemy.type)
0144+  8E39             
0145+  8E39                 ;Según el tipo le aplicamos un comportamiento
0146+  8E39 FE 00           cp COMPORTAMIENTO_CORRE_DE_IZQUIERDA_A_DERCHA
0147+  8E3B CC A9 8E            call z, move3_enemigo_corre_de_izquierda_a_derecha
0148+  8E3E FE 01           cp COMPORTAMIENTO_CORRE_DE_DERECHA_A_IZQUIERDA
0149+  8E40 CC C3 8E            call z, move1_enemigo_corre_de_derecha_a_izquierda
0150+  8E43 FE 02           cp COMPORTAMIENTO_REBOTA_VERTICAL
0151+  8E45 CC DD 8E            call z, move2_enemigo_rebota_vertical
0152+  8E48 FE 07           cp COMPORTAMIENTO_BAILA
0153+  8E4A CC 6F 8E            call z, move0_enemigo_baila
0154+  8E4D FE 05           cp COMPORTAMIENTO_PERSIGUE
0155+  8E4F CC 07 8F            call z, move4_enemigo_te_persigue
0156+  8E52 FE 03           cp COMPORTAMIENTO_REBOTA_HORIZONTAL
0157+  8E54 CC 5E 8F            call z, move5_enemigo_rebota_izquierda_derecha
0158+  8E57 FE 06           cp COMPORTAMIENTO_STATICO
0159+  8E59 CC 8E 8F            call z, move6_enemigo_estatico
0160+  8E5C                 ;comprobamos las colisiones
0161+  8E5C CD 25 90        call check_collision_enemy
0162+  8E5F CD AD 90        call check_colision_with_player
0163+  8E62                 ;aumentamos en la dirección el tamaña del enemigo, el bloque siguiente hace lo mismo que esto pero según el tamaño del enemigo:
0164+  8E62 AF              xor a
0165+  8E63             .loop_iy: 
0166+  8E63 FD 23           inc iy
0167+  8E65 3C              inc a
0168+  8E66 FE 09           cp SIZE_OF_ENEMY
0169+  8E68 28 C1           jr z,.loop
0170+  8E6A 18 F7           jr .loop_iy
0171+  8E6C             
0172+  8E6C 18 BD           jr .loop
0173+  8E6E             .update_enemies_end: 
0174+  8E6E C9              ret
0175+  8E6F             
0176+  8E6F             move0_enemigo_baila: 
0177+  8E6F FD 7E 07        ld a,(iy+enemy.counter)
0178+  8E72 C6 01           add 1
0179+  8E74 FD 77 07        ld (iy+enemy.counter),a
0180+  8E77 FE 1E           cp MAX_RETARDO_REDIBUJADO
0181+  8E79 C2 A8 8E        jp nz,.move0_end
0182+  8E7C             
0183+  8E7C FD 7E 08        ld a,(iy+enemy.frame); 
0184+  8E7F E6 01           and 1;si el frame es 1
0185+  8E81                      ;al hacer 0000 0000 (0) and 0000 0001 da 0 y se activa el flag Z. 
0186+  8E81                      ;al hacer 0000 0001 (1) and 0000 0001 da 1 y no se activa el flag Z. 
0187+  8E81 CA 95 8E        jp z, .move0_change_sprite
0188+  8E84 18 00           jr .move0_dibujar
0189+  8E86             .move0_dibujar: 
0190+  8E86 FD 7E 02        ld a, (iy+enemy.pattern_def)
0191+  8E89 D6 04           sub 4;hay que multiplicar por 4 ya que son sprites de 16x16 pixeles, es decir 4 sprites realmente
0192+  8E8B FD 77 02        ld (iy+enemy.pattern_def),a 
0193+  8E8E 3E 00           ld a,0
0194+  8E90 FD 77 08        ld (iy+enemy.frame),a;le ponemos el frame 0
0195+  8E93 18 0E           jr .reseteo
0196+  8E95             .move0_change_sprite: 
0197+  8E95 FD 7E 02        ld a, (iy+enemy.pattern_def);
0198+  8E98 C6 04           add 4;hay que multiplicar por 4 ya que son sprites de 16x16 pixeles, es decir 4 sprites realmente
0199+  8E9A FD 77 02        ld (iy+enemy.pattern_def),a ;será el byte 13*4=52-48=4
0200+  8E9D 3E 01           ld a,1;le ponemos el frame 1
0201+  8E9F FD 36 08 01     ld (iy+enemy.frame),1
0202+  8EA3             .reseteo: 
0203+  8EA3 3E 00           ld a,0
0204+  8EA5 FD 77 07        ld (iy+enemy.counter),a
0205+  8EA8             .move0_end: 
0206+  8EA8 C9              ret
0207+  8EA9             
0208+  8EA9             
0209+  8EA9             
0210+  8EA9             
0211+  8EA9             
0212+  8EA9             move3_enemigo_corre_de_izquierda_a_derecha: 
0213+  8EA9 CD AE 8F        call move_enemy_left
0214+  8EAC                 ;chequeo límite izquiedo
0215+  8EAC FD 7E 01        ld a,(iy+enemy.x)
0216+  8EAF                 ;si la posición x es 8
0217+  8EAF FE 08           cp 8
0218+  8EB1                 ;si al restar entre 8 no es igual a cero saltamos
0219+  8EB1 C2 C2 8E        jp nz, .end_move3_llega_al_borde_izquierdo
0220+  8EB4                 ;recolocar_enemy:
0221+  8EB4 CD 1E 91        call random
0222+  8EB7 3A 1F 8E        ld a,(randData)
0223+  8EBA FD 77 00        ld (iy+enemy.y),a
0224+  8EBD 3E FA           ld a,250
0225+  8EBF FD 77 01        ld (iy+enemy.x),a
0226+  8EC2             
0227+  8EC2             .end_move3_llega_al_borde_izquierdo: 
0228+  8EC2 C9              ret
0229+  8EC3             
0230+  8EC3             
0231+  8EC3             
0232+  8EC3             move1_enemigo_corre_de_derecha_a_izquierda: 
0233+  8EC3 CD 8F 8F        call move_enemy_right
0234+  8EC6                 ;Chekeo de límite derecho
0235+  8EC6                 ;obtenemos la posición x
0236+  8EC6 FD 7E 01        ld a,(iy+enemy.x)
0237+  8EC9                 ;si la posición x es 248
0238+  8EC9 FE F8           cp 248
0239+  8ECB                 ;si al restar entre 248 no es igual a cero saltamos
0240+  8ECB C2 DC 8E        jp nz, .end_move1
0241+  8ECE                 ;Si es igual a 248 recolocamos el enemigo:
0242+  8ECE CD 1E 91        call random
0243+  8ED1 3A 1F 8E        ld a,(randData)
0244+  8ED4 FD 77 00        ld (iy+enemy.y),a
0245+  8ED7 3E 08           ld a,8
0246+  8ED9 FD 77 01        ld (iy+enemy.x),a
0247+  8EDC             
0248+  8EDC             .end_move1: 
0249+  8EDC             
0250+  8EDC C9              ret
0251+  8EDD             
0252+  8EDD             
0253+  8EDD             
0254+  8EDD             move2_enemigo_rebota_vertical: 
0255+  8EDD FD 7E 05        ld a, (iy+enemy.direction)
0256+  8EE0 FE 01           cp 1
0257+  8EE2 CC CD 8F        call z, move_enemy_up
0258+  8EE5 FE 05           cp 5
0259+  8EE7 CC EC 8F        call z, move_enemy_down
0260+  8EEA FD 7E 00        ld a,(iy+enemy.y)
0261+  8EED FE A0           cp 160
0262+  8EEF CA FA 8E        jp z, .es_1
0263+  8EF2 FE 00           cp 0     
0264+  8EF4 CA 01 8F        jp z, .es_5
0265+  8EF7 C3 06 8F        jp .end_move2
0266+  8EFA             .es_1: 
0267+  8EFA 3E 01           ld a,1
0268+  8EFC FD 77 05        ld (iy+enemy.direction),a
0269+  8EFF                 ;call BEEP
0270+  8EFF 18 05           jr .end_move2
0271+  8F01             .es_5: 
0272+  8F01 3E 05           ld a,5
0273+  8F03 FD 77 05        ld (iy+enemy.direction),a
0274+  8F06                 ;call BEEP
0275+  8F06             .end_move2: 
0276+  8F06 C9              ret
0277+  8F07             
0278+  8F07             
0279+  8F07             
0280+  8F07             
0281+  8F07             move4_enemigo_te_persigue: 
0282+  8F07 FD 7E 07        ld a,(iy+enemy.counter)
0283+  8F0A C6 01           add 1
0284+  8F0C FD 77 07        ld (iy+enemy.counter),a
0285+  8F0F FE 1E           cp MAX_RETARDO_REDIBUJADO
0286+  8F11 D2 5D 8F        jp nc,.end_move4_enemigo_te_persigue
0287+  8F14             
0288+  8F14                 ;actuializamos el sprite según la dirección
0289+  8F14 FD 7E 05        ld a,(iy+enemy.direction)
0290+  8F17 FE 07           cp LEFT
0291+  8F19 28 07           jr z,.asignar_sprite_mirando_izquierda
0292+  8F1B 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0293+  8F1D FD 77 02        ld (iy+enemy.pattern_def),a
0294+  8F20 18 05           jr .next
0295+  8F22             .asignar_sprite_mirando_izquierda: 
0296+  8F22 3E 78           ld a,ENEMIGO_ENANO_DIZQUIERDA
0297+  8F24 FD 77 02        ld (iy+enemy.pattern_def),a
0298+  8F27             .next: 
0299+  8F27             
0300+  8F27 DD 7E 01        ld a,(ix+player.x)
0301+  8F2A FD 46 01        ld b,(iy+enemy.x)
0302+  8F2D 90              sub b
0303+  8F2E 38 0A           jr c, .el_player_esta_a_la_izquierda
0304+  8F30 FD 7E 01        ld a, (iy+enemy.x)
0305+  8F33 C6 01           add 1
0306+  8F35 FD 77 01        ld (iy+enemy.x),a
0307+  8F38 18 08           jr .next2
0308+  8F3A             .el_player_esta_a_la_izquierda: 
0309+  8F3A FD 7E 01        ld a, (iy+enemy.x)
0310+  8F3D D6 01           sub 1
0311+  8F3F FD 77 01        ld (iy+enemy.x),a
0312+  8F42             .next2
0313+  8F42 DD 7E 00        ld a, (ix+player.y)
0314+  8F45 FD 46 00        ld b, (iy+enemy.y)
0315+  8F48 90              sub b
0316+  8F49 38 0A           jr c, .el_player_esta_encima
0317+  8F4B FD 7E 00        ld a, (iy+enemy.y)
0318+  8F4E C6 01           add 1
0319+  8F50 FD 77 00        ld (iy+enemy.y),a
0320+  8F53 18 08           jr .reseteo
0321+  8F55             .el_player_esta_encima: 
0322+  8F55 FD 7E 00        ld a, (iy+enemy.y)
0323+  8F58 D6 01           sub 1
0324+  8F5A FD 77 00        ld (iy+enemy.y),a
0325+  8F5D             
0326+  8F5D             .reseteo: 
0327+  8F5D                 ;ld a,0
0328+  8F5D                 ;ld (iy+enemy.counter),a
0329+  8F5D             .end_move4_enemigo_te_persigue: 
0330+  8F5D C9              ret
0331+  8F5E             
0332+  8F5E             move5_enemigo_rebota_izquierda_derecha: 
0333+  8F5E FD 7E 05        ld a, (iy+enemy.direction)
0334+  8F61 FE 03           cp 3
0335+  8F63 CC 8F 8F        call z, move_enemy_right
0336+  8F66 FE 07           cp 7
0337+  8F68 CC AE 8F        call z, move_enemy_left
0338+  8F6B FD 7E 01        ld a,(iy+enemy.x)
0339+  8F6E FE F0           cp 240
0340+  8F70 CA 85 8F        jp z, .es_3
0341+  8F73 FE 00           cp 0     
0342+  8F75 CA 7B 8F        jp z, .es_7
0343+  8F78 C3 8D 8F        jp .end_move5
0344+  8F7B             .es_7: 
0345+  8F7B 3E 03           ld a,3
0346+  8F7D FD 77 05        ld (iy+enemy.direction),a
0347+  8F80 CD 0B 90        call change_sprite
0348+  8F83 18 08           jr .end_move5
0349+  8F85             .es_3: 
0350+  8F85 3E 07           ld a,7
0351+  8F87 FD 77 05        ld (iy+enemy.direction),a
0352+  8F8A CD 0B 90        call change_sprite
0353+  8F8D             .end_move5: 
0354+  8F8D C9              ret
0355+  8F8E             
0356+  8F8E             move6_enemigo_estatico: 
0357+  8F8E C9              ret
0358+  8F8F             
0359+  8F8F             
0360+  8F8F             
0361+  8F8F             move_enemy_right: 
0362+  8F8F FD 7E 01        ld a,(iy+enemy.x); 
0363+  8F92 C6 01           add 1  
0364+  8F94 FD 77 01        ld (iy+enemy.x), a 
0365+  8F97 E6 01           and 1
0366+  8F99 CA A5 8F        jp z, enemy_right_es_impar
0367+  8F9C FD 7E 02        ld a, (iy+enemy.pattern_def);
0368+  8F9F C6 04           add 4
0369+  8FA1 FD 77 02        ld (iy+enemy.pattern_def),a 
0370+  8FA4 C9              ret
0371+  8FA5             enemy_right_es_impar: 
0372+  8FA5 FD 7E 02        ld a, (iy+enemy.pattern_def);el aprite 12*4=es el byte 48 
0373+  8FA8 D6 04           sub 4;hay que multiplicar por 4 ya que son sprites de 16x16 pixeles, es decir 4 sprites realmente
0374+  8FAA FD 77 02        ld (iy+enemy.pattern_def),a 
0375+  8FAD C9              ret
0376+  8FAE             
0377+  8FAE             
0378+  8FAE             move_enemy_left: 
0379+  8FAE FD 7E 01        ld a,(iy+enemy.x); 
0380+  8FB1 D6 01           sub 1  
0381+  8FB3 FD 77 01        ld (iy+enemy.x), a 
0382+  8FB6 E6 01           and 1
0383+  8FB8 CA C4 8F        jp z, enemy_left_es_impar
0384+  8FBB FD 7E 02        ld a, (iy+enemy.pattern_def);
0385+  8FBE C6 04           add 4
0386+  8FC0 FD 77 02        ld (iy+enemy.pattern_def),a 
0387+  8FC3 C9              ret
0388+  8FC4             enemy_left_es_impar: 
0389+  8FC4 FD 7E 02        ld a, (iy+enemy.pattern_def);el aprite 12*4=es el byte 48 
0390+  8FC7 D6 04           sub 4;hay que multiplicar por 4 ya que son sprites de 16x16 pixeles, es decir 4 sprites realmente
0391+  8FC9 FD 77 02        ld (iy+enemy.pattern_def),a 
0392+  8FCC C9              ret
0393+  8FCD             
0394+  8FCD             
0395+  8FCD             move_enemy_up: 
0396+  8FCD FD 7E 00        ld a,(iy+enemy.y); 
0397+  8FD0 D6 01           sub 1  
0398+  8FD2 FD 77 00        ld (iy+enemy.y), a 
0399+  8FD5 E6 01           and 1
0400+  8FD7 CA E3 8F        jp z, enemy_up_es_impar
0401+  8FDA FD 7E 02        ld a, (iy+enemy.pattern_def);
0402+  8FDD C6 04           add 4
0403+  8FDF FD 77 02        ld (iy+enemy.pattern_def),a 
0404+  8FE2 C9              ret
0405+  8FE3             enemy_up_es_impar: 
0406+  8FE3 FD 7E 02        ld a, (iy+enemy.pattern_def);el aprite 12*4=es el byte 48 
0407+  8FE6 D6 04           sub 4;hay que multiplicar por 4 ya que son sprites de 16x16 pixeles, es decir 4 sprites realmente
0408+  8FE8 FD 77 02        ld (iy+enemy.pattern_def),a 
0409+  8FEB C9              ret
0410+  8FEC             
0411+  8FEC             
0412+  8FEC             move_enemy_down: 
0413+  8FEC FD 7E 00        ld a,(iy+enemy.y); 
0414+  8FEF C6 01           add 1  
0415+  8FF1 FD 77 00        ld (iy+enemy.y), a 
0416+  8FF4 E6 01           and 1
0417+  8FF6 CA 02 90        jp z, enemy_down_es_impar
0418+  8FF9 FD 7E 02        ld a, (iy+enemy.pattern_def);
0419+  8FFC C6 04           add 4
0420+  8FFE FD 77 02        ld (iy+enemy.pattern_def),a 
0421+  9001 C9              ret
0422+  9002             enemy_down_es_impar: 
0423+  9002 FD 7E 02        ld a, (iy+enemy.pattern_def);el aprite 12*4=es el byte 48 
0424+  9005 D6 04           sub 4;hay que multiplicar por 4 ya que son sprites de 16x16 pixeles, es decir 4 sprites realmente
0425+  9007 FD 77 02        ld (iy+enemy.pattern_def),a 
0426+  900A C9              ret
0427+  900B             
0428+  900B             change_sprite: 
0429+  900B FD 7E 05        ld a,(iy+enemy.direction)
0430+  900E FE 07           cp LEFT
0431+  9010 28 0A           jr z,.change_to_left
0432+  9012 FD 7E 02        ld a, (iy+enemy.pattern_def)
0433+  9015 D6 04           sub 4
0434+  9017 FD 77 02        ld (iy+enemy.pattern_def),a 
0435+  901A 18 08           jr .end_change_sprite
0436+  901C             .change_to_left: 
0437+  901C FD 7E 02        ld a, (iy+enemy.pattern_def)
0438+  901F C6 04           add 4
0439+  9021 FD 77 02        ld (iy+enemy.pattern_def),a 
0440+  9024             .end_change_sprite: 
0441+  9024 C9              ret
0442+  9025             
0443+  9025             ;;--------------------------------------
0444+  9025             ;;  CHECKCOLISION
0445+  9025             ;;        Input:
0446+  9025             ;;              iy=con la dirección del enemigo
0447+  9025             ;;                  ld iy, enemigo0+SIZE_OF_ENEMY*3
0448+  9025             ;;                  call check_collision_enemy
0449+  9025             
0450+  9025             check_collision_enemy: 
0451+  9025 FD 7E 00        ld a,(iy+enemy.y)
0452+  9028 5F              ld e,a;y
0453+  9029 FD 7E 01        ld a,(iy+enemy.x)
0454+  902C 57              ld d,a;x
0455+  902D             
0456+  902D             
0457+  902D FD 7E 05        ld a,(iy+enemy.direction)
0458+  9030 FE 03           cp RIGHT
0459+  9032 28 0E           jr z,.get_block_right
0460+  9034 FE 07           cp LEFT
0461+  9036 28 11           jr z,.get_block_left
0462+  9038 FE 01           cp UP
0463+  903A 28 14           jr z,.get_block_up
0464+  903C FE 05           cp DOWN
0465+  903E 28 17           jr z,.get_block_down
0466+  9040             
0467+  9040             
0468+  9040             
0469+  9040 18 19           jr .next
0470+  9042             .get_block_right: 
0471+  9042 7A              ld a,d
0472+  9043 C6 04           add 4
0473+  9045 57              ld d,a
0474+  9046 C3 5B 90        jp .next
0475+  9049             .get_block_left: 
0476+  9049 7A              ld a,d
0477+  904A D6 04           sub 4
0478+  904C 57              ld d,a
0479+  904D C3 5B 90        jp .next
0480+  9050             .get_block_up: 
0481+  9050 7B              ld a,e
0482+  9051 D6 08           sub 8
0483+  9053 5F              ld e,a
0484+  9054 C3 5B 90        jp .next
0485+  9057             .get_block_down: 
0486+  9057 7B              ld a,e
0487+  9058 C6 01           add 1
0488+  905A 5F              ld e,a
0489+  905B             
0490+  905B             
0491+  905B             .next: 
0492+  905B                 ;get_block necesita en el registro e la posición x y en d la posición y, devuelve el resultado en b
0493+  905B CD 88 86        call get_block
0494+  905E 78              ld a,b
0495+  905F FE 20           cp TILE_SOLID ;Si al restalo entre 32 da negatico se activará el flag de carry
0496+  9061 30 01           jr nc, colision_enemy 
0497+  9063 C9              ret
0498+  9064             
0499+  9064             colision_enemy: 
0500+  9064 FD 7E 05        ld a,(iy+enemy.direction)
0501+  9067 FE 07           cp LEFT
0502+  9069 28 0C           jr z, .is_LEFT
0503+  906B FE 03           cp RIGHT
0504+  906D 28 0C           jr z, .is_RIGHT
0505+  906F FE 01           cp UP
0506+  9071 28 0C           jr z, .is_UP
0507+  9073 FE 05           cp DOWN
0508+  9075 28 0C           jr z, .is_DOWN
0509+  9077             .is_LEFT: 
0510+  9077 3E 03           ld a,RIGHT
0511+  9079 18 0C           jr .next
0512+  907B             .is_RIGHT: 
0513+  907B 3E 07           ld a,LEFT
0514+  907D 18 08           jr .next
0515+  907F             .is_UP: 
0516+  907F 3E 05           ld a,DOWN
0517+  9081 18 04           jr .next
0518+  9083             .is_DOWN: 
0519+  9083 3E 01           ld a,UP
0520+  9085 18 00           jr .next
0521+  9087             
0522+  9087             
0523+  9087             .next: 
0524+  9087 FD 77 05        ld (iy+enemy.direction),a
0525+  908A FD 7E 06        ld a,(iy+enemy.type)
0526+  908D FE 00           cp COMPORTAMIENTO_CORRE_DE_IZQUIERDA_A_DERCHA
0527+  908F 28 13           jr z,.add_8_to_y
0528+  9091 FE 01           cp COMPORTAMIENTO_CORRE_DE_DERECHA_A_IZQUIERDA
0529+  9093 28 0F           jr z,.add_8_to_y
0530+  9095 FE 05           cp COMPORTAMIENTO_PERSIGUE
0531+  9097 28 0B           jr z,.add_8_to_y
0532+  9099 FE 02           cp COMPORTAMIENTO_REBOTA_VERTICAL
0533+  909B 28 0F           jr z, .end_colision_enemy
0534+  909D 28 05           jr z,.add_8_to_y
0535+  909F CD 0B 90        call change_sprite
0536+  90A2 18 08           jr .end_colision_enemy
0537+  90A4             .add_8_to_y: 
0538+  90A4 FD 7E 00        ld a,(iy+enemy.y)
0539+  90A7 C6 08           add 8
0540+  90A9 FD 77 00        ld (iy+enemy.y),a
0541+  90AC             .end_colision_enemy: 
0542+  90AC C9              ret
0543+  90AD             
0544+  90AD             check_colision_with_player: 
0545+  90AD                 ;if (enemy->x < player->x + player->w &&
0546+  90AD                 ;enemy->x + enemy->w > player->x && 
0547+  90AD                 ;enemy->y < player->y + player->h && 
0548+  90AD                 ;enemy->h + enemy->y > player->y
0549+  90AD             
0550+  90AD DD 7E 01        ld a,(ix+player.x)
0551+  90B0 06 10           ld b, 16
0552+  90B2 80              add b
0553+  90B3 FD 46 01        ld b, (iy+enemy.x)
0554+  90B6 B8              cp b ; le restamos la posición del enemigo en x al player para saber si el enemigo está denro del cuadrado del player
0555+  90B7 38 28           jr c, .end_check_colision_with_player; el_enemigo_no esta_dentro_del_ cuadrodpplayer
0556+  90B9 FD 7E 01        ld a,(iy+enemy.x)
0557+  90BC 06 10           ld b,16
0558+  90BE DD 46 01        ld b,(ix+player.x)
0559+  90C1 B8              cp b
0560+  90C2 38 1D           jr c, .end_check_colision_with_player; el enemigo no está en el cuadrado del player
0561+  90C4             
0562+  90C4             
0563+  90C4 DD 7E 00        ld a,(ix+player.y)
0564+  90C7 06 10           ld b, 16
0565+  90C9 80              add b
0566+  90CA FD 46 00        ld b, (iy+enemy.y)
0567+  90CD B8              cp b ; le restamos la posición del enemigo en x al player para saber si el enemigo está denro del cuadrado del player
0568+  90CE 38 11           jr c, .end_check_colision_with_player; el_enemigo_no esta_dentro_del_ cuadrodpplayer
0569+  90D0 FD 7E 00        ld a,(iy+enemy.y)
0570+  90D3 06 10           ld b,16
0571+  90D5 DD 46 00        ld b,(ix+player.y)
0572+  90D8 B8              cp b
0573+  90D9 38 06           jr c, .end_check_colision_with_player; el enemigo no está en el cuadrado del player
0574+  90DB             
0575+  90DB CD 6C 86        call kill_player;matamos al player
0576+  90DE CD 5B 91        call kill_enemy;recolocamos a los enemigos
0577+  90E1             
0578+  90E1             .end_check_colision_with_player: 
0579+  90E1 C9              ret
0580+  90E2             
0581+  90E2             
0582+  90E2             
0583+  90E2             
0584+  90E2             render_enemies: 
0585+  90E2 FD 21 E7 8D     ld iy, template_enemy1
0586+  90E6 21 00 1B        ld hl, 6912; aquí se podría poner la variable del sistema GRPATR
0587+  90E9 FD 6E 04        ld l,(iy+enemy.plane)
0588+  90EC                 ;intercambiamos los valores para que tengamos en el registro "de" la dirección de la memoria que necesita LDIRVM
0589+  90EC EB              ex de,hl
0590+  90ED 21 E7 8D        ld hl, template_enemy1
0591+  90F0 01 04 00        ld bc, 4; 4 bytes para copiar
0592+  90F3 D5              push de
0593+  90F4 E5              push hl
0594+  90F5 CD 5C 00        call  LDIRVM; ldirvm necesita en hl la dirección de memoria a copiar, en de la dirección de destino y en bc la cantidad ed bytes a copiar
0595+  90F8 E1              pop hl
0596+  90F9 D1              pop de
0597+  90FA 3E 06           ld a, MAX_ENEMIES
0598+  90FC             .loop: 
0599+  90FC D6 01           sub 1
0600+  90FE FE 00           cp 0
0601+  9100 28 1B           jr z, .end_render_enemies
0602+  9102 13              inc de
0603+  9103 13              inc de
0604+  9104 13              inc de
0605+  9105 13              inc de;6924,6928,etc
0606+  9106 23              inc hl
0607+  9107 23              inc hl
0608+  9108 23              inc hl
0609+  9109 23              inc hl
0610+  910A 23              inc hl
0611+  910B 23              inc hl
0612+  910C 23              inc hl
0613+  910D 23              inc hl
0614+  910E 23              inc hl;8b3c
0615+  910F 01 04 00        ld bc, 4; 4 bytes para copiar
0616+  9112 F5              push af
0617+  9113 D5              push de
0618+  9114 E5              push hl
0619+  9115 CD 5C 00        call  LDIRVM; ldirvm necesita en hl la dirección de memoria a copiar, en de la dirección de destino y en bc la cantidad ed bytes a copiar
0620+  9118 E1              pop hl
0621+  9119 D1              pop de
0622+  911A F1              pop af
0623+  911B 18 DF           jr .loop
0624+  911D             .end_render_enemies
0625+  911D C9              ret
0626+  911E             
0627+  911E             
0628+  911E             
0629+  911E             
0630+  911E             
0631+  911E             
0632+  911E             
0633+  911E             ;https://gist.github.com/JohnConnolly0/25c65425cf4f84954585
0634+  911E             ; El registro de refresco (R) en el Z80 es muy impredecible ya que se incrementa en cada ciclo.
0635+  911E             ; Debido a que puede tener cualquier valor cuando se llama a esta rutina, es muy bueno para números aleatorios.
0636+  911E             ; Esta rutina aumenta la aleatoriedad del número ya que forma una dirección basada en el
0637+  911E             ; actualiza el estado actual del contador y accede a la memoria en esa dirección.
0638+  911E             random: 
0639+  911E ED 5F           LD A,R			; Cargo el registro A con el registro r
0640+  9120 6F              LD L,A			; Copia el valor del registro a en l
0641+  9121 E6 3F           AND %00111111	; 63,#3f,Este enmascaramiento impide que la dirección que estamos formando acceda a la RAM
0642+  9123 67              LD H,A			; Copy register A into register H
0643+  9124 7E              LD A,(HL)		; Load the pseudo-random value into A
0644+  9125 FE 50           cp 80           ;le hacemos la resta con 100 si el resultado es menor que 0 se activará el flag de carry
0645+  9127 38 F5           jr c, random    
0646+  9129 FE A0           cp 160          ;si el resultado es menor de 160 no se acivará el flag de carry
0647+  912B 30 F1           jr nc, random
0648+  912D 32 1F 8E        ld (randData),a
0649+  9130 C9              ret
0650+  9131             
0651+  9131             sacar_sprites_de_pantalla: 
0652+  9131 FD 21 E7 8D     ld iy, template_enemy1
0653+  9135 AF              xor a
0654+  9136 32 1D 8E        ld (enemy_active),a
0655+  9139             
0656+  9139             .loop: 
0657+  9139 3A 1D 8E        ld a,(enemy_active)
0658+  913C FE 06           cp MAX_ENEMIES
0659+  913E 28 1A           jr z,.end_sacar_sprites_de_pantalla
0660+  9140 3C              inc a
0661+  9141 32 1D 8E        ld (enemy_active),a
0662+  9144 3E D4           ld a,212;y
0663+  9146 FD 77 00        ld (iy+enemy.y),a
0664+  9149 3E 00           ld a,0;x
0665+  914B FD 77 01        ld (iy+enemy.x),a
0666+  914E                 ;ld a, COMPORTAMIENTO_STATICO
0667+  914E                 ;ld (iy+enemy.type),a
0668+  914E AF              xor a
0669+  914F                 ;call update_enemies
0670+  914F             .loop_iy: 
0671+  914F FD 23           inc iy
0672+  9151 3C              inc a
0673+  9152 FE 09           cp SIZE_OF_ENEMY
0674+  9154 28 E3           jr z,.loop
0675+  9156 18 F7           jr .loop_iy
0676+  9158             
0677+  9158 18 DF           jr .loop
0678+  915A             .end_sacar_sprites_de_pantalla: 
0679+  915A             
0680+  915A C9              ret
0681+  915B             
0682+  915B             
0683+  915B             
0684+  915B             kill_enemy: 
0685+  915B 3E C0           ld a,24*8
0686+  915D FD 77 00        ld (iy+enemy.y),a
0687+  9160 3E 00           ld a,0
0688+  9162 FD 77 01        ld (iy+enemy.x),a
0689+  9165 3E 06           ld a,COMPORTAMIENTO_STATICO
0690+  9167 FD 77 06        ld (iy+enemy.type),a
0691+  916A C9              ret
0692+  916B             
0693+  916B             
0694+  916B             
0695+  916B             
0535   916B             	include "src/MSXBasic/recolocate_and_level.asm"    
0001+  916B             load_screens: 
0002+  916B             
0003+  916B 11 60 89        ld de, map_buffer 
0004+  916E 01 C0 02        ld bc, MAP_SIZE
0005+  9171 DD E5           push ix
0006+  9173 E5              push hl
0007+  9174 CD 76 AF        call depack_RAM
0008+  9177 E1              pop hl
0009+  9178 DD E1           pop ix  
0010+  917A                 ;ponemos el mapa en la VRAM
0011+  917A 21 60 89        ld hl, map_buffer
0012+  917D 11 00 18        ld de, 6144 
0013+  9180             	;Le quitamos 64 ya que keremos pintar el HUD en las últimas 2 líneas de la pantalla
0014+  9180 01 C0 02        ld bc, MAP_SIZE
0015+  9183 CD 5C 00        call  LDIRVM
0016+  9186 C9              ret
0017+  9187             
0018+  9187             
0019+  9187             
0020+  9187             
0021+  9187             
0022+  9187             recolocate_and_level_screen_1: 
0023+  9187 21 31 B0        ld hl, maps_tiled1
0024+  918A CD 6B 91        call load_screens
0025+  918D             
0026+  918D             
0027+  918D FD 21 E7 8D     ld iy, template_enemy1
0028+  9191 3E 38           ld a,7*8;y
0029+  9193 FD 77 00        ld (iy+enemy.y),a
0030+  9196 3E A0           ld a,20*8;x
0031+  9198 FD 77 01        ld (iy+enemy.x),a
0032+  919B 3E 02           ld a,COMPORTAMIENTO_REBOTA_VERTICAL
0033+  919D FD 77 06        ld (iy+enemy.type),a
0034+  91A0             
0035+  91A0 FD 21 F0 8D     ld iy, template_enemy2
0036+  91A4 3E 80           ld a,16*8;y
0037+  91A6 FD 77 00        ld (iy+enemy.y),a
0038+  91A9 3E C8           ld a,25*8;x
0039+  91AB FD 77 01        ld (iy+enemy.x),a
0040+  91AE 3E 05           ld a,COMPORTAMIENTO_PERSIGUE
0041+  91B0 FD 77 06        ld (iy+enemy.type),a
0042+  91B3             
0043+  91B3 FD 21 F9 8D     ld iy, template_enemy3
0044+  91B7 3E 90           ld a,18*8;y
0045+  91B9 FD 77 00        ld (iy+enemy.y),a
0046+  91BC 3E E0           ld a,28*8;x
0047+  91BE FD 77 01        ld (iy+enemy.x),a
0048+  91C1 3E 03           ld a,COMPORTAMIENTO_REBOTA_HORIZONTAL
0049+  91C3 FD 77 06        ld (iy+enemy.type),a
0050+  91C6             
0051+  91C6 FD 21 02 8E     ld iy, template_enemy4
0052+  91CA 3E A0           ld a,20*8;y
0053+  91CC FD 77 00        ld (iy+enemy.y),a
0054+  91CF 3E B8           ld a,23*8;x
0055+  91D1 FD 77 01        ld (iy+enemy.x),a
0056+  91D4             
0057+  91D4 FD 21 0B 8E     ld iy, template_enemy5
0058+  91D8 3E 80           ld a,16*8;y
0059+  91DA FD 77 00        ld (iy+enemy.y),a
0060+  91DD 3E C8           ld a,25*8;x
0061+  91DF FD 77 01        ld (iy+enemy.x),a
0062+  91E2             
0063+  91E2 FD 21 14 8E     ld iy, template_enemy6
0064+  91E6 3E 78           ld a,15*8;y
0065+  91E8 FD 77 00        ld (iy+enemy.y),a
0066+  91EB 3E 78           ld a,15*8;x
0067+  91ED FD 77 01        ld (iy+enemy.x),a
0068+  91F0             
0069+  91F0 C9              ret
0070+  91F1             ;en la pantalla 2 pondremos 2 que reboten horizonales junto a la puerta y otros 2 que eboten en el pasillo grande
0071+  91F1             recolocate_and_level_screen_2: 
0072+  91F1 21 D3 B0        ld hl, maps_tiled2
0073+  91F4 CD 6B 91        call load_screens
0074+  91F7             
0075+  91F7 FD 21 E7 8D     ld iy, template_enemy1
0076+  91FB 3E 90           ld a,18*8;y
0077+  91FD FD 77 00        ld (iy+enemy.y),a
0078+  9200 3E 58           ld a,11*8;x
0079+  9202 FD 77 01        ld (iy+enemy.x),a
0080+  9205 3E 20           ld a,ENEMIGO_COLETA
0081+  9207 FD 77 02        ld (iy+enemy.pattern_def),a
0082+  920A 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0083+  920C FD 77 06        ld (iy+enemy.type),a
0084+  920F             
0085+  920F FD 21 F0 8D     ld iy, template_enemy2
0086+  9213 3E 90           ld a,18*8;y
0087+  9215 FD 77 00        ld (iy+enemy.y),a
0088+  9218 3E A0           ld a,20*8;x
0089+  921A FD 77 01        ld (iy+enemy.x),a
0090+  921D 3E 30           ld a,ENEMIGO_GORDO
0091+  921F FD 77 02        ld (iy+enemy.pattern_def),a
0092+  9222 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0093+  9224 FD 77 06        ld (iy+enemy.type),a
0094+  9227             
0095+  9227 FD 21 F9 8D     ld iy, template_enemy3
0096+  922B 3E 50           ld a,10*8;y
0097+  922D FD 77 00        ld (iy+enemy.y),a
0098+  9230 3E 70           ld a,14*8;x
0099+  9232 FD 77 01        ld (iy+enemy.x),a
0100+  9235 3E 30           ld a,ENEMIGO_GORDO
0101+  9237 FD 77 02        ld (iy+enemy.pattern_def),a
0102+  923A 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0103+  923C FD 77 06        ld (iy+enemy.type),a
0104+  923F                 
0105+  923F FD 21 02 8E     ld iy, template_enemy4
0106+  9243 3E 60           ld a,12*8;y
0107+  9245 FD 77 00        ld (iy+enemy.y),a
0108+  9248 3E 80           ld a,16*8;x
0109+  924A FD 77 01        ld (iy+enemy.x),a
0110+  924D 3E 30           ld a,ENEMIGO_GORDO
0111+  924F FD 77 02        ld (iy+enemy.pattern_def),a
0112+  9252 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0113+  9254 FD 77 06        ld (iy+enemy.type),a
0114+  9257             
0115+  9257 FD 21 0B 8E     ld iy, template_enemy5
0116+  925B 3E 60           ld a,12*8;y
0117+  925D FD 77 00        ld (iy+enemy.y),a
0118+  9260 3E F0           ld a,30*8;x
0119+  9262 FD 77 01        ld (iy+enemy.x),a
0120+  9265 3E 30           ld a,ENEMIGO_GORDO
0121+  9267 FD 77 02        ld (iy+enemy.pattern_def),a
0122+  926A 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0123+  926C FD 77 06        ld (iy+enemy.type),a
0124+  926F             
0125+  926F C9              ret
0126+  9270             recolocate_and_level_screen_3: 
0127+  9270 21 61 B1        ld hl, maps_tiled3
0128+  9273 CD 6B 91        call load_screens
0129+  9276             
0130+  9276 FD 21 E7 8D     ld iy, template_enemy1
0131+  927A 3E 90           ld a,18*8;y
0132+  927C FD 77 00        ld (iy+enemy.y),a
0133+  927F 3E 58           ld a,11*8;x
0134+  9281 FD 77 01        ld (iy+enemy.x),a
0135+  9284 3E 20           ld a,ENEMIGO_COLETA
0136+  9286 FD 77 02        ld (iy+enemy.pattern_def),a
0137+  9289 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0138+  928B FD 77 06        ld (iy+enemy.type),a
0139+  928E             
0140+  928E FD 21 F0 8D     ld iy, template_enemy2
0141+  9292 3E 48           ld a,9*8;y
0142+  9294 FD 77 00        ld (iy+enemy.y),a
0143+  9297 3E 70           ld a,14*8;x
0144+  9299 FD 77 01        ld (iy+enemy.x),a
0145+  929C 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0146+  929E FD 77 02        ld (iy+enemy.pattern_def),a
0147+  92A1 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0148+  92A3 FD 77 06        ld (iy+enemy.type),a
0149+  92A6             
0150+  92A6 FD 21 F9 8D     ld iy, template_enemy3
0151+  92AA 3E 38           ld a,7*8;y
0152+  92AC FD 77 00        ld (iy+enemy.y),a
0153+  92AF 3E 70           ld a,14*8;x
0154+  92B1 FD 77 01        ld (iy+enemy.x),a
0155+  92B4 3E 60           ld a,ENEMIGO_GORRA
0156+  92B6 FD 77 02        ld (iy+enemy.pattern_def),a
0157+  92B9 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0158+  92BB FD 77 06        ld (iy+enemy.type),a
0159+  92BE                 
0160+  92BE FD 21 02 8E     ld iy, template_enemy4
0161+  92C2 3E 68           ld a,13*8;y
0162+  92C4 FD 77 00        ld (iy+enemy.y),a
0163+  92C7 3E 80           ld a,16*8;x
0164+  92C9 FD 77 01        ld (iy+enemy.x),a
0165+  92CC 3E 30           ld a,ENEMIGO_GORDO
0166+  92CE FD 77 02        ld (iy+enemy.pattern_def),a
0167+  92D1 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0168+  92D3 FD 77 06        ld (iy+enemy.type),a
0169+  92D6             
0170+  92D6 C9              ret
0171+  92D7             
0172+  92D7             recolocate_and_level_screen_4: 
0173+  92D7 21 05 B2        ld hl, maps_tiled4
0174+  92DA CD 6B 91        call load_screens
0175+  92DD                 
0176+  92DD FD 21 E7 8D     ld iy, template_enemy1
0177+  92E1 3E 60           ld a,12*8;y
0178+  92E3 FD 77 00        ld (iy+enemy.y),a
0179+  92E6 3E 40           ld a,8*8;x
0180+  92E8 FD 77 01        ld (iy+enemy.x),a
0181+  92EB 3E 20           ld a,ENEMIGO_COLETA
0182+  92ED FD 77 02        ld (iy+enemy.pattern_def),a
0183+  92F0 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0184+  92F2 FD 77 06        ld (iy+enemy.type),a
0185+  92F5             
0186+  92F5 FD 21 F0 8D     ld iy, template_enemy2
0187+  92F9 3E 48           ld a,9*8;y
0188+  92FB FD 77 00        ld (iy+enemy.y),a
0189+  92FE 3E 70           ld a,14*8;x
0190+  9300 FD 77 01        ld (iy+enemy.x),a
0191+  9303 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0192+  9305 FD 77 02        ld (iy+enemy.pattern_def),a
0193+  9308 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0194+  930A FD 77 06        ld (iy+enemy.type),a
0195+  930D             
0196+  930D FD 21 F9 8D     ld iy, template_enemy3
0197+  9311 3E 38           ld a,7*8;y
0198+  9313 FD 77 00        ld (iy+enemy.y),a
0199+  9316 3E 70           ld a,14*8;x
0200+  9318 FD 77 01        ld (iy+enemy.x),a
0201+  931B 3E 60           ld a,ENEMIGO_GORRA
0202+  931D FD 77 02        ld (iy+enemy.pattern_def),a
0203+  9320 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0204+  9322 FD 77 06        ld (iy+enemy.type),a
0205+  9325                 
0206+  9325 FD 21 02 8E     ld iy, template_enemy4
0207+  9329 3E 08           ld a,1*8;y
0208+  932B FD 77 00        ld (iy+enemy.y),a
0209+  932E 3E 40           ld a,8*8;x
0210+  9330 FD 77 01        ld (iy+enemy.x),a
0211+  9333 3E 80           ld a,ENEMIGO_VIRUS1
0212+  9335 FD 77 02        ld (iy+enemy.pattern_def),a
0213+  9338 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0214+  933A FD 77 06        ld (iy+enemy.type),a
0215+  933D             
0216+  933D FD 21 0B 8E     ld iy, template_enemy5
0217+  9341 3E 08           ld a,1*8;y
0218+  9343 FD 77 00        ld (iy+enemy.y),a
0219+  9346 3E C0           ld a,24*8;x
0220+  9348 FD 77 01        ld (iy+enemy.x),a
0221+  934B 3E 30           ld a,ENEMIGO_GORDO
0222+  934D FD 77 02        ld (iy+enemy.pattern_def),a
0223+  9350 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0224+  9352 FD 77 06        ld (iy+enemy.type),a
0225+  9355             
0226+  9355 FD 21 14 8E     ld iy, template_enemy6
0227+  9359 3E 60           ld a,12*8;y
0228+  935B FD 77 00        ld (iy+enemy.y),a
0229+  935E 3E C0           ld a,24*8;x
0230+  9360 FD 77 01        ld (iy+enemy.x),a
0231+  9363 3E 30           ld a,ENEMIGO_GORDO
0232+  9365 FD 77 02        ld (iy+enemy.pattern_def),a
0233+  9368 3E 01           ld a, UP
0234+  936A FD 77 05        ld (iy+enemy.direction),a
0235+  936D 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0236+  936F FD 77 06        ld (iy+enemy.type),a
0237+  9372             
0238+  9372 C9              ret
0239+  9373             ;-------------------------------------------------------------------------
0240+  9373             ;-------------------------------------------------------------------------
0241+  9373             ;------------------------- Screen 5 --------------------------------------
0242+  9373             ;-------------------------------------------------------------------------
0243+  9373             ;-------------------------------------------------------------------------
0244+  9373             recolocate_and_level_screen_5: 
0245+  9373 21 9F B2        ld hl, maps_tiled5
0246+  9376 CD 6B 91        call load_screens
0247+  9379             
0248+  9379                 
0249+  9379 FD 21 E7 8D     ld iy, template_enemy1
0250+  937D 3E 70           ld a,14*8;y
0251+  937F FD 77 00        ld (iy+enemy.y),a
0252+  9382 3E 70           ld a,14*8;x
0253+  9384 FD 77 01        ld (iy+enemy.x),a
0254+  9387 3E 20           ld a,ENEMIGO_COLETA
0255+  9389 FD 77 02        ld (iy+enemy.pattern_def),a
0256+  938C 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0257+  938E FD 77 06        ld (iy+enemy.type),a
0258+  9391             
0259+  9391 FD 21 F0 8D     ld iy, template_enemy2
0260+  9395 3E 48           ld a,9*8;y
0261+  9397 FD 77 00        ld (iy+enemy.y),a
0262+  939A 3E 60           ld a,12*8;x
0263+  939C FD 77 01        ld (iy+enemy.x),a
0264+  939F 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0265+  93A1 FD 77 02        ld (iy+enemy.pattern_def),a
0266+  93A4 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0267+  93A6 FD 77 06        ld (iy+enemy.type),a
0268+  93A9             
0269+  93A9 FD 21 F9 8D     ld iy, template_enemy3
0270+  93AD 3E 38           ld a,7*8;y
0271+  93AF FD 77 00        ld (iy+enemy.y),a
0272+  93B2 3E 70           ld a,14*8;x
0273+  93B4 FD 77 01        ld (iy+enemy.x),a
0274+  93B7 3E 90           ld a,ENEMIGO_VIRUS2
0275+  93B9 FD 77 02        ld (iy+enemy.pattern_def),a
0276+  93BC 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0277+  93BE FD 77 06        ld (iy+enemy.type),a
0278+  93C1                 
0279+  93C1 FD 21 02 8E     ld iy, template_enemy4
0280+  93C5 3E 68           ld a,13*8;y
0281+  93C7 FD 77 00        ld (iy+enemy.y),a
0282+  93CA 3E 80           ld a,16*8;x
0283+  93CC FD 77 01        ld (iy+enemy.x),a
0284+  93CF 3E 30           ld a,ENEMIGO_GORDO
0285+  93D1 FD 77 02        ld (iy+enemy.pattern_def),a
0286+  93D4 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0287+  93D6 FD 77 06        ld (iy+enemy.type),a
0288+  93D9             
0289+  93D9 FD 21 02 8E     ld iy, template_enemy4
0290+  93DD 3E 60           ld a,12*8;y
0291+  93DF FD 77 00        ld (iy+enemy.y),a
0292+  93E2 3E 70           ld a,14*8;x
0293+  93E4 FD 77 01        ld (iy+enemy.x),a
0294+  93E7 3E 30           ld a,ENEMIGO_GORDO
0295+  93E9 FD 77 02        ld (iy+enemy.pattern_def),a
0296+  93EC 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0297+  93EE FD 77 06        ld (iy+enemy.type),a
0298+  93F1             
0299+  93F1 FD 21 0B 8E     ld iy, template_enemy5
0300+  93F5 3E 38           ld a,7*8;y
0301+  93F7 FD 77 00        ld (iy+enemy.y),a
0302+  93FA 3E 90           ld a,18*8;x
0303+  93FC FD 77 01        ld (iy+enemy.x),a
0304+  93FF 3E 30           ld a,ENEMIGO_GORDO
0305+  9401 FD 77 02        ld (iy+enemy.pattern_def),a
0306+  9404 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0307+  9406 FD 77 06        ld (iy+enemy.type),a
0308+  9409             
0309+  9409 FD 21 14 8E     ld iy, template_enemy6
0310+  940D 3E A0           ld a,20*8;y
0311+  940F FD 77 00        ld (iy+enemy.y),a
0312+  9412 3E 50           ld a,10*8;x
0313+  9414 FD 77 01        ld (iy+enemy.x),a
0314+  9417 3E 30           ld a,ENEMIGO_GORDO
0315+  9419 FD 77 02        ld (iy+enemy.pattern_def),a
0316+  941C 3E 07           ld a, LEFT
0317+  941E FD 77 05        ld (iy+enemy.direction),a
0318+  9421 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0319+  9423 FD 77 06        ld (iy+enemy.type),a
0320+  9426 C9              ret
0321+  9427             ;-------------------------------------------------------------------------
0322+  9427             ;-------------------------------------------------------------------------
0323+  9427             ;------------------------- Screen 6 --------------------------------------
0324+  9427             ;-------------------------------------------------------------------------
0325+  9427             ;-------------------------------------------------------------------------
0326+  9427             recolocate_and_level_screen_6: 
0327+  9427 21 4C B3        ld hl, maps_tiled6
0328+  942A CD 6B 91        call load_screens
0329+  942D             
0330+  942D FD 21 E7 8D     ld iy, template_enemy1
0331+  9431 3E 10           ld a,2*8;y
0332+  9433 FD 77 00        ld (iy+enemy.y),a
0333+  9436 3E 20           ld a,4*8;x
0334+  9438 FD 77 01        ld (iy+enemy.x),a
0335+  943B 3E 20           ld a,ENEMIGO_COLETA
0336+  943D FD 77 02        ld (iy+enemy.pattern_def),a
0337+  9440 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0338+  9442 FD 77 06        ld (iy+enemy.type),a
0339+  9445             
0340+  9445 FD 21 F0 8D     ld iy, template_enemy2
0341+  9449 3E 08           ld a,1*8;y
0342+  944B FD 77 00        ld (iy+enemy.y),a
0343+  944E 3E 10           ld a,2*8;x
0344+  9450 FD 77 01        ld (iy+enemy.x),a
0345+  9453 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0346+  9455 FD 77 02        ld (iy+enemy.pattern_def),a
0347+  9458 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0348+  945A FD 77 06        ld (iy+enemy.type),a
0349+  945D             
0350+  945D FD 21 F9 8D     ld iy, template_enemy3
0351+  9461 3E 30           ld a,6*8;y
0352+  9463 FD 77 00        ld (iy+enemy.y),a
0353+  9466 3E 70           ld a,14*8;x
0354+  9468 FD 77 01        ld (iy+enemy.x),a
0355+  946B 3E 60           ld a,ENEMIGO_GORRA
0356+  946D FD 77 02        ld (iy+enemy.pattern_def),a
0357+  9470 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0358+  9472 FD 77 06        ld (iy+enemy.type),a
0359+  9475                 
0360+  9475 FD 21 02 8E     ld iy, template_enemy4
0361+  9479 3E 68           ld a,13*8;y
0362+  947B FD 77 00        ld (iy+enemy.y),a
0363+  947E 3E 80           ld a,16*8;x
0364+  9480 FD 77 01        ld (iy+enemy.x),a
0365+  9483 3E 30           ld a,ENEMIGO_GORDO
0366+  9485 FD 77 02        ld (iy+enemy.pattern_def),a
0367+  9488 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0368+  948A FD 77 06        ld (iy+enemy.type),a
0369+  948D             
0370+  948D FD 21 0B 8E     ld iy, template_enemy5
0371+  9491 3E 18           ld a,3*8;y
0372+  9493 FD 77 00        ld (iy+enemy.y),a
0373+  9496 3E 80           ld a,16*8;x
0374+  9498 FD 77 01        ld (iy+enemy.x),a
0375+  949B 3E A0           ld a,ENEMIGO_VIRUS3
0376+  949D FD 77 02        ld (iy+enemy.pattern_def),a
0377+  94A0 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0378+  94A2 FD 77 06        ld (iy+enemy.type),a
0379+  94A5             
0380+  94A5 FD 21 14 8E     ld iy, template_enemy6
0381+  94A9 3E 90           ld a,18*8;y
0382+  94AB FD 77 00        ld (iy+enemy.y),a
0383+  94AE 3E 80           ld a,16*8;x
0384+  94B0 FD 77 01        ld (iy+enemy.x),a
0385+  94B3 3E 80           ld a,ENEMIGO_VIRUS1
0386+  94B5 FD 77 02        ld (iy+enemy.pattern_def),a
0387+  94B8 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0388+  94BA FD 77 06        ld (iy+enemy.type),a
0389+  94BD C9              ret
0390+  94BE             
0391+  94BE             ;-------------------------------------------------------------------------
0392+  94BE             ;-------------------------------------------------------------------------
0393+  94BE             ;------------------------- Screen 7 --------------------------------------
0394+  94BE             ;-------------------------------------------------------------------------
0395+  94BE             ;-------------------------------------------------------------------------   
0396+  94BE             recolocate_and_level_screen_7: 
0397+  94BE 21 D9 B3        ld hl, maps_tiled7
0398+  94C1 CD 6B 91        call load_screens
0399+  94C4             
0400+  94C4 FD 21 E7 8D     ld iy, template_enemy1
0401+  94C8 3E 70           ld a,14*8;y
0402+  94CA FD 77 00        ld (iy+enemy.y),a
0403+  94CD 3E A0           ld a,20*8;x
0404+  94CF FD 77 01        ld (iy+enemy.x),a
0405+  94D2 3E 20           ld a,ENEMIGO_COLETA
0406+  94D4 FD 77 02        ld (iy+enemy.pattern_def),a
0407+  94D7 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0408+  94D9 FD 77 06        ld (iy+enemy.type),a
0409+  94DC             
0410+  94DC FD 21 F0 8D     ld iy, template_enemy2
0411+  94E0 3E 48           ld a,9*8;y
0412+  94E2 FD 77 00        ld (iy+enemy.y),a
0413+  94E5 3E 70           ld a,14*8;x
0414+  94E7 FD 77 01        ld (iy+enemy.x),a
0415+  94EA 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0416+  94EC FD 77 02        ld (iy+enemy.pattern_def),a
0417+  94EF 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0418+  94F1 FD 77 06        ld (iy+enemy.type),a
0419+  94F4             
0420+  94F4 FD 21 F9 8D     ld iy, template_enemy3
0421+  94F8 3E 38           ld a,7*8;y
0422+  94FA FD 77 00        ld (iy+enemy.y),a
0423+  94FD 3E 70           ld a,14*8;x
0424+  94FF FD 77 01        ld (iy+enemy.x),a
0425+  9502 3E 60           ld a,ENEMIGO_GORRA
0426+  9504 FD 77 02        ld (iy+enemy.pattern_def),a
0427+  9507 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0428+  9509 FD 77 06        ld (iy+enemy.type),a
0429+  950C                 
0430+  950C FD 21 02 8E     ld iy, template_enemy4
0431+  9510 3E 20           ld a,4*8;y
0432+  9512 FD 77 00        ld (iy+enemy.y),a
0433+  9515 3E 18           ld a,3*8;x
0434+  9517 FD 77 01        ld (iy+enemy.x),a
0435+  951A 3E 80           ld a,ENEMIGO_VIRUS1
0436+  951C FD 77 02        ld (iy+enemy.pattern_def),a
0437+  951F 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0438+  9521 FD 77 06        ld (iy+enemy.type),a
0439+  9524             
0440+  9524 FD 21 0B 8E     ld iy, template_enemy5
0441+  9528 3E 70           ld a,14*8;y
0442+  952A FD 77 00        ld (iy+enemy.y),a
0443+  952D 3E 30           ld a,6*8;x
0444+  952F FD 77 01        ld (iy+enemy.x),a
0445+  9532 3E 90           ld a,ENEMIGO_VIRUS2
0446+  9534 FD 77 02        ld (iy+enemy.pattern_def),a
0447+  9537 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0448+  9539 FD 77 06        ld (iy+enemy.type),a
0449+  953C             
0450+  953C FD 21 14 8E     ld iy, template_enemy6
0451+  9540 3E 30           ld a,6*8;y
0452+  9542 FD 77 00        ld (iy+enemy.y),a
0453+  9545 3E C8           ld a,25*8;x
0454+  9547 FD 77 01        ld (iy+enemy.x),a
0455+  954A 3E A0           ld a,ENEMIGO_VIRUS3
0456+  954C FD 77 02        ld (iy+enemy.pattern_def),a
0457+  954F 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0458+  9551 FD 77 06        ld (iy+enemy.type),a
0459+  9554 C9              ret
0460+  9555             
0461+  9555             ;-------------------------------------------------------------------------
0462+  9555             ;-------------------------------------------------------------------------
0463+  9555             ;------------------------- Screen 8 --------------------------------------
0464+  9555             ;-------------------------------------------------------------------------
0465+  9555             ;-------------------------------------------------------------------------   
0466+  9555             recolocate_and_level_screen_8: 
0467+  9555 21 8B B4        ld hl, maps_tiled8
0468+  9558 CD 6B 91        call load_screens
0469+  955B             
0470+  955B FD 21 E7 8D     ld iy, template_enemy1
0471+  955F 3E 50           ld a,10*8;y
0472+  9561 FD 77 00        ld (iy+enemy.y),a
0473+  9564 3E 70           ld a,14*8;x
0474+  9566 FD 77 01        ld (iy+enemy.x),a
0475+  9569 3E 20           ld a,ENEMIGO_COLETA
0476+  956B FD 77 02        ld (iy+enemy.pattern_def),a
0477+  956E 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0478+  9570 FD 77 06        ld (iy+enemy.type),a
0479+  9573             
0480+  9573 FD 21 F0 8D     ld iy, template_enemy2
0481+  9577 3E 48           ld a,9*8;y
0482+  9579 FD 77 00        ld (iy+enemy.y),a
0483+  957C 3E 70           ld a,14*8;x
0484+  957E FD 77 01        ld (iy+enemy.x),a
0485+  9581 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0486+  9583 FD 77 02        ld (iy+enemy.pattern_def),a
0487+  9586 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0488+  9588 FD 77 06        ld (iy+enemy.type),a
0489+  958B             
0490+  958B FD 21 F9 8D     ld iy, template_enemy3
0491+  958F 3E 28           ld a,5*8;y
0492+  9591 FD 77 00        ld (iy+enemy.y),a
0493+  9594 3E 70           ld a,14*8;x
0494+  9596 FD 77 01        ld (iy+enemy.x),a
0495+  9599 3E 60           ld a,ENEMIGO_GORRA
0496+  959B FD 77 02        ld (iy+enemy.pattern_def),a
0497+  959E 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0498+  95A0 FD 77 06        ld (iy+enemy.type),a
0499+  95A3                 
0500+  95A3 FD 21 02 8E     ld iy, template_enemy4
0501+  95A7 3E 68           ld a,13*8;y
0502+  95A9 FD 77 00        ld (iy+enemy.y),a
0503+  95AC 3E 88           ld a,17*8;x
0504+  95AE FD 77 01        ld (iy+enemy.x),a
0505+  95B1 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0506+  95B3 FD 77 02        ld (iy+enemy.pattern_def),a
0507+  95B6 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0508+  95B8 FD 77 06        ld (iy+enemy.type),a
0509+  95BB             
0510+  95BB FD 21 0B 8E     ld iy, template_enemy5
0511+  95BF 3E 80           ld a,16*8;y
0512+  95C1 FD 77 00        ld (iy+enemy.y),a
0513+  95C4 3E 80           ld a,16*8;x
0514+  95C6 FD 77 01        ld (iy+enemy.x),a
0515+  95C9 3E B0           ld a,ENEMIGO_VIRUS4
0516+  95CB FD 77 02        ld (iy+enemy.pattern_def),a
0517+  95CE 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0518+  95D0 FD 77 06        ld (iy+enemy.type),a
0519+  95D3             
0520+  95D3 FD 21 14 8E     ld iy, template_enemy6
0521+  95D7 3E 80           ld a,16*8;y
0522+  95D9 FD 77 00        ld (iy+enemy.y),a
0523+  95DC 3E 70           ld a,14*8;x
0524+  95DE FD 77 01        ld (iy+enemy.x),a
0525+  95E1 3E A0           ld a,ENEMIGO_VIRUS3
0526+  95E3 FD 77 02        ld (iy+enemy.pattern_def),a
0527+  95E6 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0528+  95E8 FD 77 06        ld (iy+enemy.type),a
0529+  95EB C9              ret
0530+  95EC             
0531+  95EC             
0532+  95EC             ;-------------------------------------------------------------------------
0533+  95EC             ;-------------------------------------------------------------------------
0534+  95EC             ;------------------------- Screen 9 --------------------------------------
0535+  95EC             ;-------------------------------------------------------------------------
0536+  95EC             ;-------------------------------------------------------------------------   
0537+  95EC             
0538+  95EC             recolocate_and_level_screen_9: 
0539+  95EC 21 31 B5        ld hl, maps_tiled9
0540+  95EF CD 6B 91        call load_screens
0541+  95F2             
0542+  95F2 FD 21 E7 8D     ld iy, template_enemy1
0543+  95F6 3E 70           ld a,14*8;y
0544+  95F8 FD 77 00        ld (iy+enemy.y),a
0545+  95FB 3E B8           ld a,23*8;x
0546+  95FD FD 77 01        ld (iy+enemy.x),a
0547+  9600 3E 20           ld a,ENEMIGO_COLETA
0548+  9602 FD 77 02        ld (iy+enemy.pattern_def),a
0549+  9605 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0550+  9607 FD 77 06        ld (iy+enemy.type),a
0551+  960A             
0552+  960A FD 21 F0 8D     ld iy, template_enemy2
0553+  960E 3E 08           ld a,1*8;y
0554+  9610 FD 77 00        ld (iy+enemy.y),a
0555+  9613 3E 70           ld a,14*8;x
0556+  9615 FD 77 01        ld (iy+enemy.x),a
0557+  9618 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0558+  961A FD 77 02        ld (iy+enemy.pattern_def),a
0559+  961D 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0560+  961F FD 77 06        ld (iy+enemy.type),a
0561+  9622             
0562+  9622 FD 21 F9 8D     ld iy, template_enemy3
0563+  9626 3E 28           ld a,5*8;y
0564+  9628 FD 77 00        ld (iy+enemy.y),a
0565+  962B 3E 90           ld a,18*8;x
0566+  962D FD 77 01        ld (iy+enemy.x),a
0567+  9630 3E 60           ld a,ENEMIGO_GORRA
0568+  9632 FD 77 02        ld (iy+enemy.pattern_def),a
0569+  9635 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0570+  9637 FD 77 06        ld (iy+enemy.type),a
0571+  963A                 
0572+  963A FD 21 02 8E     ld iy, template_enemy4
0573+  963E 3E 58           ld a,11*8;y
0574+  9640 FD 77 00        ld (iy+enemy.y),a
0575+  9643 3E A0           ld a,20*8;x
0576+  9645 FD 77 01        ld (iy+enemy.x),a
0577+  9648 3E 30           ld a,ENEMIGO_GORDO
0578+  964A FD 77 02        ld (iy+enemy.pattern_def),a
0579+  964D 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0580+  964F FD 77 06        ld (iy+enemy.type),a
0581+  9652             
0582+  9652             
0583+  9652 FD 21 0B 8E     ld iy, template_enemy5
0584+  9656 3E 88           ld a,17*8;y
0585+  9658 FD 77 00        ld (iy+enemy.y),a
0586+  965B 3E 80           ld a,16*8;x
0587+  965D FD 77 01        ld (iy+enemy.x),a
0588+  9660 3E B0           ld a,ENEMIGO_VIRUS4
0589+  9662 FD 77 02        ld (iy+enemy.pattern_def),a
0590+  9665 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0591+  9667 FD 77 06        ld (iy+enemy.type),a
0592+  966A             
0593+  966A FD 21 14 8E     ld iy, template_enemy6
0594+  966E 3E 10           ld a,2*8;y
0595+  9670 FD 77 00        ld (iy+enemy.y),a
0596+  9673 3E 70           ld a,14*8;x
0597+  9675 FD 77 01        ld (iy+enemy.x),a
0598+  9678 3E A0           ld a,ENEMIGO_VIRUS3
0599+  967A FD 77 02        ld (iy+enemy.pattern_def),a
0600+  967D 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0601+  967F FD 77 06        ld (iy+enemy.type),a
0602+  9682 C9              ret
0603+  9683             
0604+  9683             ;-------------------------------------------------------------------------
0605+  9683             ;-------------------------------------------------------------------------
0606+  9683             ;------------------------- Screen 10 --------------------------------------
0607+  9683             ;-------------------------------------------------------------------------
0608+  9683             ;-------------------------------------------------------------------------   
0609+  9683             
0610+  9683             recolocate_and_level_screen_10: 
0611+  9683 21 BA B5        ld hl, maps_tiled10
0612+  9686 CD 6B 91        call load_screens
0613+  9689             
0614+  9689 FD 21 E7 8D     ld iy, template_enemy1
0615+  968D 3E 70           ld a,14*8;y
0616+  968F FD 77 00        ld (iy+enemy.y),a
0617+  9692 3E A0           ld a,20*8;x
0618+  9694 FD 77 01        ld (iy+enemy.x),a
0619+  9697 3E 20           ld a,ENEMIGO_COLETA
0620+  9699 FD 77 02        ld (iy+enemy.pattern_def),a
0621+  969C 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0622+  969E FD 77 06        ld (iy+enemy.type),a
0623+  96A1             
0624+  96A1 FD 21 F0 8D     ld iy, template_enemy2
0625+  96A5 3E 48           ld a,9*8;y
0626+  96A7 FD 77 00        ld (iy+enemy.y),a
0627+  96AA 3E 58           ld a,11*8;x
0628+  96AC FD 77 01        ld (iy+enemy.x),a
0629+  96AF 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0630+  96B1 FD 77 02        ld (iy+enemy.pattern_def),a
0631+  96B4 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0632+  96B6 FD 77 06        ld (iy+enemy.type),a
0633+  96B9             
0634+  96B9 FD 21 F9 8D     ld iy, template_enemy3
0635+  96BD 3E 58           ld a,11*8;y
0636+  96BF FD 77 00        ld (iy+enemy.y),a
0637+  96C2 3E 48           ld a,9*8;x
0638+  96C4 FD 77 01        ld (iy+enemy.x),a
0639+  96C7 3E 60           ld a,ENEMIGO_GORRA
0640+  96C9 FD 77 02        ld (iy+enemy.pattern_def),a
0641+  96CC 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0642+  96CE FD 77 06        ld (iy+enemy.type),a
0643+  96D1                 
0644+  96D1 FD 21 02 8E     ld iy, template_enemy4
0645+  96D5 3E 28           ld a,5*8;y
0646+  96D7 FD 77 00        ld (iy+enemy.y),a
0647+  96DA 3E 68           ld a,13*8;x
0648+  96DC FD 77 01        ld (iy+enemy.x),a
0649+  96DF 3E 30           ld a,ENEMIGO_GORDO
0650+  96E1 FD 77 02        ld (iy+enemy.pattern_def),a
0651+  96E4 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0652+  96E6 FD 77 06        ld (iy+enemy.type),a
0653+  96E9             
0654+  96E9 FD 21 0B 8E     ld iy, template_enemy5
0655+  96ED 3E 30           ld a,6*8;y
0656+  96EF FD 77 00        ld (iy+enemy.y),a
0657+  96F2 3E C0           ld a,24*8;x
0658+  96F4 FD 77 01        ld (iy+enemy.x),a
0659+  96F7 3E 90           ld a,ENEMIGO_VIRUS2
0660+  96F9 FD 77 02        ld (iy+enemy.pattern_def),a
0661+  96FC 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0662+  96FE FD 77 06        ld (iy+enemy.type),a
0663+  9701             
0664+  9701 FD 21 14 8E     ld iy, template_enemy6
0665+  9705 3E 90           ld a,18*8;y
0666+  9707 FD 77 00        ld (iy+enemy.y),a
0667+  970A 3E 78           ld a,15*8;x
0668+  970C FD 77 01        ld (iy+enemy.x),a
0669+  970F 3E A0           ld a,ENEMIGO_VIRUS3
0670+  9711 FD 77 02        ld (iy+enemy.pattern_def),a
0671+  9714 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0672+  9716 FD 77 06        ld (iy+enemy.type),a
0673+  9719 C9              ret
0674+  971A             
0675+  971A             
0676+  971A             
0677+  971A             recolocate_and_level_screen_11: 
0678+  971A 21 82 B6        ld hl, maps_tiled11
0679+  971D CD 6B 91        call load_screens
0680+  9720             
0681+  9720 FD 21 E7 8D     ld iy, template_enemy1
0682+  9724 3E 30           ld a,6*8;y
0683+  9726 FD 77 00        ld (iy+enemy.y),a
0684+  9729 3E 78           ld a,15*8;x
0685+  972B FD 77 01        ld (iy+enemy.x),a
0686+  972E 3E 90           ld a,ENEMIGO_VIRUS2
0687+  9730 FD 77 02        ld (iy+enemy.pattern_def),a
0688+  9733 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0689+  9735 FD 77 06        ld (iy+enemy.type),a
0690+  9738             
0691+  9738 FD 21 F0 8D     ld iy, template_enemy2
0692+  973C 3E 28           ld a,5*8;y
0693+  973E FD 77 00        ld (iy+enemy.y),a
0694+  9741 3E 70           ld a,14*8;x
0695+  9743 FD 77 01        ld (iy+enemy.x),a
0696+  9746 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0697+  9748 FD 77 02        ld (iy+enemy.pattern_def),a
0698+  974B 3E 05           ld a, COMPORTAMIENTO_PERSIGUE
0699+  974D FD 77 06        ld (iy+enemy.type),a
0700+  9750             
0701+  9750 FD 21 F9 8D     ld iy, template_enemy3
0702+  9754 3E 18           ld a,3*8;y
0703+  9756 FD 77 00        ld (iy+enemy.y),a
0704+  9759 3E 80           ld a,16*8;x
0705+  975B FD 77 01        ld (iy+enemy.x),a
0706+  975E 3E 60           ld a,ENEMIGO_GORRA
0707+  9760 FD 77 02        ld (iy+enemy.pattern_def),a
0708+  9763 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0709+  9765 FD 77 06        ld (iy+enemy.type),a
0710+  9768                 
0711+  9768 FD 21 02 8E     ld iy, template_enemy4
0712+  976C 3E 20           ld a,4*8;y
0713+  976E FD 77 00        ld (iy+enemy.y),a
0714+  9771 3E 60           ld a,12*8;x
0715+  9773 FD 77 01        ld (iy+enemy.x),a
0716+  9776 3E 30           ld a,ENEMIGO_GORDO
0717+  9778 FD 77 02        ld (iy+enemy.pattern_def),a
0718+  977B 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0719+  977D FD 77 06        ld (iy+enemy.type),a
0720+  9780             
0721+  9780 FD 21 0B 8E     ld iy, template_enemy5
0722+  9784 3E 70           ld a,14*8;y
0723+  9786 FD 77 00        ld (iy+enemy.y),a
0724+  9789 3E A8           ld a,21*8;x
0725+  978B FD 77 01        ld (iy+enemy.x),a
0726+  978E 3E B0           ld a,ENEMIGO_VIRUS4
0727+  9790 FD 77 02        ld (iy+enemy.pattern_def),a
0728+  9793 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0729+  9795 FD 77 06        ld (iy+enemy.type),a
0730+  9798             
0731+  9798             
0732+  9798 FD 21 14 8E     ld iy, template_enemy6
0733+  979C 3E 88           ld a,17*8;y
0734+  979E FD 77 00        ld (iy+enemy.y),a
0735+  97A1 3E 80           ld a,16*8;x
0736+  97A3 FD 77 01        ld (iy+enemy.x),a
0737+  97A6 3E 90           ld a,ENEMIGO_VIRUS2
0738+  97A8 FD 77 02        ld (iy+enemy.pattern_def),a
0739+  97AB 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0740+  97AD FD 77 06        ld (iy+enemy.type),a
0741+  97B0 C9              ret
0742+  97B1             recolocate_and_level_screen_12: 
0743+  97B1 21 19 B7        ld hl, maps_tiled12
0744+  97B4 CD 6B 91        call load_screens
0745+  97B7             
0746+  97B7 FD 21 E7 8D     ld iy, template_enemy1
0747+  97BB 3E 70           ld a,14*8;y
0748+  97BD FD 77 00        ld (iy+enemy.y),a
0749+  97C0 3E D0           ld a,26*8;x
0750+  97C2 FD 77 01        ld (iy+enemy.x),a
0751+  97C5 3E 20           ld a,ENEMIGO_COLETA
0752+  97C7 FD 77 02        ld (iy+enemy.pattern_def),a
0753+  97CA 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0754+  97CC FD 77 06        ld (iy+enemy.type),a
0755+  97CF             
0756+  97CF FD 21 F0 8D     ld iy, template_enemy2
0757+  97D3 3E 28           ld a,5*8;y
0758+  97D5 FD 77 00        ld (iy+enemy.y),a
0759+  97D8 3E 50           ld a,10*8;x
0760+  97DA FD 77 01        ld (iy+enemy.x),a
0761+  97DD 3E 70           ld a,ENEMIGO_ENANO_DERECHA
0762+  97DF FD 77 02        ld (iy+enemy.pattern_def),a
0763+  97E2 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0764+  97E4 FD 77 06        ld (iy+enemy.type),a
0765+  97E7             
0766+  97E7 FD 21 F9 8D     ld iy, template_enemy3
0767+  97EB 3E 10           ld a,2*8;y
0768+  97ED FD 77 00        ld (iy+enemy.y),a
0769+  97F0 3E 70           ld a,14*8;x
0770+  97F2 FD 77 01        ld (iy+enemy.x),a
0771+  97F5 3E A0           ld a,ENEMIGO_VIRUS3
0772+  97F7 FD 77 02        ld (iy+enemy.pattern_def),a
0773+  97FA 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0774+  97FC FD 77 06        ld (iy+enemy.type),a
0775+  97FF                 
0776+  97FF FD 21 02 8E     ld iy, template_enemy4
0777+  9803 3E 58           ld a,11*8;y
0778+  9805 FD 77 00        ld (iy+enemy.y),a
0779+  9808 3E 80           ld a,16*8;x
0780+  980A FD 77 01        ld (iy+enemy.x),a
0781+  980D 3E 01           ld a,UP
0782+  980F FD 77 05        ld (iy+enemy.direction),a
0783+  9812 3E 30           ld a,ENEMIGO_GORDO
0784+  9814 FD 77 02        ld (iy+enemy.pattern_def),a
0785+  9817 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0786+  9819 FD 77 06        ld (iy+enemy.type),a
0787+  981C             
0788+  981C FD 21 0B 8E     ld iy, template_enemy5
0789+  9820 3E 38           ld a,7*8;y
0790+  9822 FD 77 00        ld (iy+enemy.y),a
0791+  9825 3E 20           ld a,4*8;x
0792+  9827 FD 77 01        ld (iy+enemy.x),a
0793+  982A 3E 80           ld a,ENEMIGO_VIRUS1
0794+  982C FD 77 02        ld (iy+enemy.pattern_def),a
0795+  982F 3E 01           ld a,UP
0796+  9831 FD 77 05        ld (iy+enemy.direction),a
0797+  9834 3E 02           ld a, COMPORTAMIENTO_REBOTA_VERTICAL
0798+  9836 FD 77 06        ld (iy+enemy.type),a
0799+  9839             
0800+  9839 FD 21 14 8E     ld iy, template_enemy6
0801+  983D 3E 88           ld a,17*8;y
0802+  983F FD 77 00        ld (iy+enemy.y),a
0803+  9842 3E 98           ld a,19*8;x
0804+  9844 FD 77 01        ld (iy+enemy.x),a
0805+  9847 3E 90           ld a,ENEMIGO_VIRUS2
0806+  9849 FD 77 02        ld (iy+enemy.pattern_def),a
0807+  984C 3E 03           ld a, COMPORTAMIENTO_REBOTA_HORIZONTAL
0808+  984E FD 77 06        ld (iy+enemy.type),a
0809+  9851 C9              ret
0536   9852                 include "src/musicint.asm"
0001+  9852             
0002+  9852             HKEYI equ #FD9A
0003+  9852             HTIMI equ #FD9F ;Vblank
0004+  9852             MAX_CONTADOR equ 50
0005+  9852             rutina_previa equ #f202      
0006+  9852             ;rutina_previa: ds 5      
0007+  9852             musica_activa:  equ #8504
0008+  9852             efecto_activo:  equ #8505
0009+  9852             inicilizar_tracker: 
0010+  9852 DD E5           push ix
0011+  9854                 ;Deactivamos las interrupciones
0012+  9854 F3              di	
0013+  9855                 ; hemos puesto a mano a 1 para que siempre se repita la canción en la variable PT3_SETUP
0014+  9855                 ;LD		 A, (PT3_SETUP)
0015+  9855                 ;AND		11111110b
0016+  9855                 ;LD		(PT3_SETUP), A
0017+  9855             
0018+  9855 3A 04 85        ld a,(musica_activa)
0019+  9858 FE 01           cp 1;Si es 1 es la música del menu
0020+  985A 28 0A           jr z,.musica_menu
0021+  985C FE 02           cp 2
0022+  985E 28 10           jr z,.musica_ingame
0023+  9860 FE 03           cp 3
0024+  9862 28 07           jr z,.musica_final
0025+  9864 18 0D           jr .inicializa_cancion
0026+  9866             .musica_menu: ;https://zxart.ee/spa/autores/c/cj-echo/wild-quaker3/
0027+  9866 21 CD A0        ld hl, menu-99
0028+  9869 18 08           jr .inicializa_cancion
0029+  986B             .musica_final: 
0030+  986B 21 96 A3    	ld hl, final-99	
0031+  986E 18 03           jr .inicializa_cancion
0032+  9870             .musica_ingame: 
0033+  9870 21 96 9E    	ld hl, ingame-99		; hl vale la direccion donde se encuentra la cancion - 99
0034+  9873             
0035+  9873             
0036+  9873             .inicializa_cancion: 
0037+  9873 CD 0A 99    	call PT3_INIT			; Inicia el reproductor de PT3
0038+  9876                 
0039+  9876                 ;Salvamos la rutina ISR(Interrupt service routine) si hubiese alguna.Son 5 bytes
0040+  9876 21 9F FD        ld hl,HTIMI
0041+  9879 11 02 F2        ld de,rutina_previa
0042+  987C 01 05 00        ld bc,5
0043+  987F ED B0           ldir
0044+  9881             
0045+  9881                 ;instalamos nuestra rutina
0046+  9881 3E C3           ld a,#c3
0047+  9883 32 9F FD        ld (HTIMI),a
0048+  9886 21 96 98        ld hl, reproducir_bloque_musica
0049+  9889 22 A0 FD        ld (HTIMI+1), hl
0050+  988C                 ;Activamos las interrupciones
0051+  988C FB          	ei 
0052+  988D                 
0053+  988D                 ;inicializacion del reproductor de efectos sonoros
0054+  988D                 ;ld a,(efecto_activo)
0055+  988D                 ;or a ; si el efecto está activo nos activará el flag z
0056+  988D                 ;jp z, reproducir_bloque_musica
0057+  988D 21 5E AB        LD		HL, sfx_bank
0058+  9890 CD 81 AA        CALL	ayFX_SETUP
0059+  9893                 ;Volvemos al basic
0060+  9893 DD E1           pop ix
0061+  9895 C9              ret
0062+  9896             
0063+  9896             reproducir_bloque_musica: 
0064+  9896                 ;------------------Reproducir Bloque de múscia--------
0065+  9896                 ;halt						;sincronizacion
0066+  9896             	;di
0067+  9896             
0068+  9896 3A 04 85        ld a,(musica_activa)
0069+  9899 B7              or a
0070+  989A CA AE 98        jp z,.end_reproducir_bloque_musica
0071+  989D CD 4F 9E    	call	PT3_ROUT			;Borrar el valor anterior
0072+  98A0 CD 57 9D    	call	PT3_PLAY			;Reproduce el siguiente trozo de canción
0073+  98A3             
0074+  98A3 3A 05 85        ld a,(efecto_activo)
0075+  98A6 B7              or a  ; si el efecto está activo nos activará el flag z
0076+  98A7 CA AE 98        jp z,.end_reproducir_bloque_musica
0077+  98AA C3 C9 AA        JP		ayFX_PLAY	
0078+  98AD                 ;ei
0079+  98AD                 ;--------------Fin de reproducir bloque de música-----
0080+  98AD                 ;lanzamos la rutina que había
0081+  98AD                 ;jp rutina_previa
0082+  98AD                 ;Volvemos al basic
0083+  98AD C9              ret
0084+  98AE             .end_reproducir_bloque_musica: 
0085+  98AE                 ;call PT3_MUTE
0086+  98AE 3E 01           ld a ,1
0087+  98B0 32 05 85        ld (efecto_activo),a
0088+  98B3 C9              ret
0089+  98B4             para_cancion: 
0090+  98B4                 ;volvemos a poner los 5 bytes que tenía
0091+  98B4 F3              di
0092+  98B5                 ;ld hl,rutina_previa
0093+  98B5                 ;ld de,HTIMI
0094+  98B5                 ;ld bc,5
0095+  98B5                 ;ldir
0096+  98B5 CD FE 98        call PT3_MUTE
0097+  98B8                 ;xor a
0098+  98B8                 ;ld (musica_activa),a
0099+  98B8 FB              ei
0100+  98B9 C9              ret
0101+  98BA             
0102+  98BA             sigue_musica: 
0103+  98BA 3E 01           ld a,1
0104+  98BC 32 04 85        ld (musica_activa),a
0105+  98BF C9              ret
0106+  98C0             efecto_toque: 
0107+  98C0 3E 00           LD			A, 0; 
0108+  98C2 0E 01           LD			C, 1
0109+  98C4 CD 93 AA        CALL		ayFX_INIT
0110+  98C7 C9              ret
0111+  98C8             efecto_golpe: 
0112+  98C8 3E 00           ld a,0
0113+  98CA 32 05 85        ld (efecto_activo),a
0114+  98CD 3E 01           LD			A, 1; 
0115+  98CF 0E 01           LD			C, 1
0116+  98D1 CD 93 AA        CALL		ayFX_INIT
0117+  98D4 C9              ret
0118+  98D5             efecto_romper: 
0119+  98D5 3E 06           LD			A, 6; 
0120+  98D7 0E 01           LD			C, 1
0121+  98D9 CD 93 AA        CALL		ayFX_INIT
0122+  98DC C9              ret
0123+  98DD             
0124+  98DD             efecto_coge_botella: 
0125+  98DD 3E 0A           LD			A, 10; 
0126+  98DF 0E 01           LD			C, 1
0127+  98E1 CD 93 AA        CALL		ayFX_INIT
0128+  98E4 C9              ret
0129+  98E5             efecto_mata_player: 
0130+  98E5 3E 0D           LD			A, 13; 
0131+  98E7 0E 01           LD			C, 1
0132+  98E9 CD 93 AA        CALL		ayFX_INIT
0133+  98EC C9              ret
0134+  98ED             
0135+  98ED             ;includes para sjasmplus
0136+  98ED             ;tracker:
0137+  98ED             ;	include	"./src/PT3_player.asm"					
0138+  98ED             ;ingame:
0139+  98ED             ;	incbin "./src/dd.pt3"	
0140+  98ED             ;menu:
0141+  98ED             ;    incbin "./src/musicdisc.pt3"		
0142+  98ED             ;fx_player:
0143+  98ED             ;    include	"./src/ayFX_player.asm"	
0144+  98ED             ;sfx_bank:
0145+  98ED             ;	incbin "./src/sfx.afb"
0146+  98ED             
0147+  98ED             tracker: 
0148+  98ED             	include	"PT3_player.asm"			
0001++ 98ED             		; --- PT3 REPLAYER WORKING ON ROM ---
0002++ 98ED             		; --- Can be assembled with asMSX ---
0003++ 98ED             		; --- ROM version: MSX-KUN        ---
0004++ 98ED             		; --- asMSX version 2: SapphiRe   ---
0005++ 98ED             
0006++ 98ED             ; Based on MSX full version of PT3 by Dioniso
0007++ 98ED             ;
0008++ 98ED             ; This version of the replayer can be used with any note table
0009++ 98ED             ; This version also allows the use of PT3 commands
0010++ 98ED             ; First 99 bytes of each PT3 module should be stripped off
0011++ 98ED             ;
0012++ 98ED             ; PLAY and PSG WRITE routines seperated to allow independent calls
0013++ 98ED             ;
0014++ 98ED             ; ROM LENGTH: 1549 bytes
0015++ 98ED             ; RAM LENGTH:  576 bytes
0016++ 98ED             
0017++ 98ED             
0018++ 98ED             
0019++ 98ED             ;SJASM version by BTV 2016
0020++ 98ED             
0021++ 98ED             
0022++ 98ED             		; --- CONSTANT VALUES DEFINITION ---
0023++ 98ED             
0024++ 98ED             ;ChannelsVars
0025++ 98ED             ;struc	CHNPRM
0026++ 98ED             ;reset group
0027++ 98ED             CHNPRM_PsInOr	equ 0	;RESB 1
0028++ 98ED             CHNPRM_PsInSm	equ 1	;RESB 1
0029++ 98ED             CHNPRM_CrAmSl	equ 2	;RESB 1
0030++ 98ED             CHNPRM_CrNsSl	equ 3	;RESB 1
0031++ 98ED             CHNPRM_CrEnSl	equ 4	;RESB 1
0032++ 98ED             CHNPRM_TSlCnt	equ 5	;RESB 1
0033++ 98ED             CHNPRM_CrTnSl	equ 6	;RESW 1
0034++ 98ED             CHNPRM_TnAcc	equ 8	;RESW 1
0035++ 98ED             CHNPRM_COnOff	equ 10	;RESB 1
0036++ 98ED             ;reset group
0037++ 98ED             
0038++ 98ED             CHNPRM_OnOffD	equ 11	;RESB 1
0039++ 98ED             
0040++ 98ED             ;IX for PTDECOD here [+12]
0041++ 98ED             CHNPRM_OffOnD	equ 12	;RESB 1
0042++ 98ED             CHNPRM_OrnPtr	equ 13	;RESW 1
0043++ 98ED             CHNPRM_SamPtr	equ 15	;RESW 1
0044++ 98ED             CHNPRM_NNtSkp	equ 17	;RESB 1
0045++ 98ED             CHNPRM_Note	equ 18	;RESB 1
0046++ 98ED             CHNPRM_SlToNt	equ 19	;RESB 1
0047++ 98ED             CHNPRM_Env_En	equ 20	;RESB 1
0048++ 98ED             CHNPRM_Flags	equ 21	;RESB 1
0049++ 98ED              ;Enabled - 0,SimpleGliss - 2
0050++ 98ED             CHNPRM_TnSlDl	equ 22	;RESB 1
0051++ 98ED             CHNPRM_TSlStp	equ 23	;RESW 1
0052++ 98ED             CHNPRM_TnDelt	equ 25	;RESW 1
0053++ 98ED             CHNPRM_NtSkCn	equ 27	;RESB 1
0054++ 98ED             CHNPRM_Volume	equ 28	;RESB 1
0055++ 98ED             CHNPRM_Size	equ 29	;RESB 1
0056++ 98ED             ;endstruc
0057++ 98ED             
0058++ 98ED             ;struc	AR
0059++ 98ED             AR_TonA		equ 0	;RESW 1
0060++ 98ED             AR_TonB		equ 2	;RESW 1
0061++ 98ED             AR_TonC		equ 4	;RESW 1
0062++ 98ED             AR_Noise	equ 6	;RESB 1
0063++ 98ED             AR_Mixer	equ 7	;RESB 1
0064++ 98ED             AR_AmplA	equ 8	;RESB 1
0065++ 98ED             AR_AmplB	equ 9	;RESB 1
0066++ 98ED             AR_AmplC	equ 10	;RESB 1
0067++ 98ED             AR_Env		equ 11	;RESW 1
0068++ 98ED             AR_EnvTp	equ 13	;RESB 1
0069++ 98ED             ;endstruc
0070++ 98ED              
0071++ 98ED             		; --- CODE STARTS HERE ---
0072++ 98ED             
0073++ 98ED 21 00 F0    CHECKLP: 	LD	HL,PT3_SETUP
0074++ 98F0 CB FE       		SET	7,[HL]
0075++ 98F2 CB 46       		BIT	0,[HL]
0076++ 98F4 C8          		RET	Z
0077++ 98F5 E1          		POP	HL
0078++ 98F6 21 7A F0    		LD	HL,DelyCnt
0079++ 98F9 34          		INC	[HL]
0080++ 98FA 21 3E F0    		LD	HL,ChanA+CHNPRM_NtSkCn
0081++ 98FD 34          		INC	[HL]
0082++ 98FE AF          PT3_MUTE: 	XOR	A
0083++ 98FF 67          		LD	H,A
0084++ 9900 6F          		LD	L,A
0085++ 9901 32 48 F1    		LD	[AYREGS+AR_AmplA],A
0086++ 9904 22 49 F1    		LD	[AYREGS+AR_AmplB],HL
0087++ 9907 C3 50 9E    		JP	ROUT_A0
0088++ 990A             
0089++ 990A             PT3_INIT: 	;HL - AddressOfModule - 100
0090++ 990A 22 01 F0    		LD [PT3_MODADDR],HL
0091++ 990D E5          		PUSH HL
0092++ 990E 11 64 00    		LD DE,100
0093++ 9911 19          		ADD HL,DE
0094++ 9912 7E          		LD A,[HL]
0095++ 9913 32 1C F0    		LD [PT3_Delay],A
0096++ 9916 E5          		PUSH HL
0097++ 9917 DD E1       		POP IX
0098++ 9919 19          		ADD HL,DE
0099++ 991A 22 03 F0    		LD [PT3_CrPsPtr],HL
0100++ 991D DD 5E 02    		LD E,[IX+102-100]
0101++ 9920 19          		ADD HL,DE
0102++ 9921 23          		INC HL
0103++ 9922 22 18 F0    		LD [PT3_LPosPtr],HL
0104++ 9925 D1          		POP DE
0105++ 9926 DD 6E 03    		LD L,[IX+103-100]
0106++ 9929 DD 66 04    		LD H,[IX+104-100]
0107++ 992C 19          		ADD HL,DE
0108++ 992D 22 1A F0    		LD [PT3_PatsPtr],HL
0109++ 9930 21 A9 00    		LD HL,169
0110++ 9933 19          		ADD HL,DE
0111++ 9934 22 07 F0    		LD [PT3_OrnPtrs],HL
0112++ 9937 21 69 00    		LD HL,105
0113++ 993A 19          		ADD HL,DE
0114++ 993B 22 05 F0    		LD [PT3_SAMPTRS],HL
0115++ 993E 21 00 F0    		LD HL,PT3_SETUP
0116++ 9941 CB BE       		RES 7,[HL]
0117++ 9943             
0118++ 9943             		; --- note table data depacker ---
0119++ 9943             		; Depacks first 12 tones of each tone table
0120++ 9943             
0121++ 9943 11 C4 9E    		LD DE,T_PACK
0122++ 9946 01 B1 F1    		LD BC,T1_+(2*49)-1
0123++ 9949 1A          .TP_0: 		LD A,[DE]
0124++ 994A 13          		INC DE
0125++ 994B FE 1E       		CP 15*2
0126++ 994D 30 06       		JR NC,.TP_1
0127++ 994F 67          		LD H,A
0128++ 9950 1A          		LD A,[DE]
0129++ 9951 6F          		LD L,A
0130++ 9952 13          		INC DE
0131++ 9953 18 07       		JR .TP_2
0132++ 9955 D5          .TP_1: 		PUSH DE
0133++ 9956 16 00       		LD D,0
0134++ 9958 5F          		LD E,A
0135++ 9959 19          		ADD HL,DE
0136++ 995A 19          		ADD HL,DE
0137++ 995B D1          		POP DE
0138++ 995C 7C          .TP_2: 		LD A,H
0139++ 995D 02          		LD [BC],A
0140++ 995E 0B          		DEC BC
0141++ 995F 7D          		LD A,L
0142++ 9960 02          		LD [BC],A
0143++ 9961 0B          		DEC BC
0144++ 9962 D6 F0       		SUB $F0
0145++ 9964 20 E3       		JR NZ,.TP_0
0146++ 9966             
0147++ 9966             		; --- INITIALIZE PT3 VARIABLES ---
0148++ 9966 21 23 F0    		LD HL,VARS
0149++ 9969 77          		LD [HL],A
0150++ 996A 11 24 F0    		LD DE,VARS+1
0151++ 996D 01 2C 01    		LD BC,VAR0END-VARS-1
0152++ 9970 ED B0       		LDIR
0153++ 9972             
0154++ 9972 3C          		INC A
0155++ 9973 32 7A F0    		LD [DelyCnt],A
0156++ 9976 21 01 F0    		LD HL,$F001 ;H - CHNPRM_Volume, L - CHNPRM_NtSkCn
0157++ 9979 22 3E F0    		LD [ChanA+CHNPRM_NtSkCn],HL
0158++ 997C 22 5B F0    		LD [ChanB+CHNPRM_NtSkCn],HL
0159++ 997F 22 78 F0    		LD [ChanC+CHNPRM_NtSkCn],HL
0160++ 9982             
0161++ 9982 21 C0 9E    		LD HL,EMPTYSAMORN
0162++ 9985 22 12 F0    		LD [PT3_AdInPtA],HL ;ptr to zero
0163++ 9988 22 30 F0    		LD [ChanA+CHNPRM_OrnPtr],HL ;ornament 0 is "0,1,0"
0164++ 998B 22 4D F0    		LD [ChanB+CHNPRM_OrnPtr],HL ;in all versions from
0165++ 998E 22 6A F0    		LD [ChanC+CHNPRM_OrnPtr],HL ;3.xx to 3.6x and VTII
0166++ 9991             
0167++ 9991 22 32 F0    		LD [ChanA+CHNPRM_SamPtr],HL ;S1 There is no default
0168++ 9994 22 4F F0    		LD [ChanB+CHNPRM_SamPtr],HL ;S2 sample in PT3, so, you
0169++ 9997 22 6C F0    		LD [ChanC+CHNPRM_SamPtr],HL ;S3 can comment S1,2,3; see
0170++ 999A             					    ;also EMPTYSAMORN comment
0171++ 999A             
0172++ 999A             		; --- NOTE TABLE CREATOR (c) Ivan Roshin, adapted by SapphiRe ---
0173++ 999A DD 7E FF    		LD A,[IX+99-100] ;TONE TABLE NUMBER
0174++ 999D 17          		RLA
0175++ 999E E6 07       		AND 7
0176++ 99A0 21 70 9E    		LD HL,NT_DATA
0177++ 99A3 D5          		PUSH DE
0178++ 99A4 50          		LD D,B		; ld d,0 (bc is 0000 after LDIR)
0179++ 99A5 87          		ADD A,A
0180++ 99A6 5F          		LD E,A
0181++ 99A7 19          		ADD HL,DE	; hl -> init of correct note table data
0182++ 99A8 5E          		LD E,[HL]
0183++ 99A9 23          		INC HL
0184++ 99AA CB 3B       		SRL E
0185++ 99AC 9F          		SBC A,A
0186++ 99AD E6 A7       		AND $A7			;$00 (NOP) or $A7 (AND A)
0187++ 99AF 32 21 F0    		LD [PT3_NTL3],A		; CORRECT INSTRUCTION, DEPENDS OF SELECTED TABLE
0188++ 99B2 3E C9       		LD A,$C9		; RET CODE
0189++ 99B4 32 22 F0    		LD [PT3_NTL3+1],A	; RET PLACED
0190++ 99B7 EB          		EX DE,HL
0191++ 99B8 C1          		POP BC ;BC=T1_
0192++ 99B9 09          		ADD HL,BC
0193++ 99BA             
0194++ 99BA 1A          		LD A,[DE]                           
0195++ 99BB             
0196++ 99BB 01 80 9E    		LD BC,T_
0197++ 99BE 81          		ADD A,C
0198++ 99BF 4F          		LD C,A
0199++ 99C0 88          		ADC A,B
0200++ 99C1             
0201++ 99C1 91          		SUB C
0202++ 99C2 47          		LD B,A
0203++ 99C3 C5          		PUSH BC
0204++ 99C4 11 80 F0    		LD DE,NT_
0205++ 99C7 D5          		PUSH DE
0206++ 99C8             
0207++ 99C8 06 0C       		LD B,12
0208++ 99CA C5          .L1: 		PUSH BC
0209++ 99CB 4E          		LD C,[HL]
0210++ 99CC 23          		INC HL
0211++ 99CD E5          		PUSH HL
0212++ 99CE 46          		LD B,[HL]
0213++ 99CF             
0214++ 99CF D5          		PUSH DE
0215++ 99D0 EB          		EX DE,HL
0216++ 99D1 11 17 00    		LD DE,23
0217++ 99D4 DD 26 08    		db $DD,$26,$08	;LD XH,8
0218++ 99D7             
0219++ 99D7 CB 38       .L2: 		SRL B
0220++ 99D9 CB 19       		RR C
0221++ 99DB CD 21 F0    .L3: 		CALL PT3_NTL3	;AND A or NOP
0222++ 99DE 79          		LD A,C
0223++ 99DF 8A          		ADC A,D	;=ADC 0
0224++ 99E0 77          		LD [HL],A
0225++ 99E1 23          		INC HL
0226++ 99E2 78          		LD A,B
0227++ 99E3 8A          		ADC A,D
0228++ 99E4 77          		LD [HL],A
0229++ 99E5 19          		ADD HL,DE
0230++ 99E6 DD 25       		db $DD,$25	;DEC XH
0231++ 99E8 20 ED       		JR NZ,.L2
0232++ 99EA             
0233++ 99EA D1          		POP DE
0234++ 99EB 13          		INC DE
0235++ 99EC 13          		INC DE
0236++ 99ED E1          		POP HL
0237++ 99EE 23          		INC HL
0238++ 99EF C1          		POP BC
0239++ 99F0 10 D8       		DJNZ .L1
0240++ 99F2             
0241++ 99F2 E1          		POP HL
0242++ 99F3 D1          		POP DE
0243++ 99F4             
0244++ 99F4 7B          		LD A,E
0245++ 99F5 D5          		PUSH DE
0246++ 99F6 11 8C 9E    		LD DE,TCOLD_1
0247++ 99F9 BB          		CP E
0248++ 99FA D1          		POP DE
0249++ 99FB 20 05       		JR NZ,.CORR_1
0250++ 99FD 3E FD       		LD A,$FD
0251++ 99FF 32 AE F0    		LD [NT_+$2E],A
0252++ 9A02             
0253++ 9A02 1A          .CORR_1: 	LD A,[DE]
0254++ 9A03 A7          		AND A
0255++ 9A04 28 11       		JR Z,.TC_EXIT
0256++ 9A06 1F          		RRA
0257++ 9A07 F5          		PUSH AF
0258++ 9A08 87          		ADD A,A
0259++ 9A09 4F          		LD C,A
0260++ 9A0A 09          		ADD HL,BC
0261++ 9A0B F1          		POP AF
0262++ 9A0C 30 02       		JR NC,.CORR_2
0263++ 9A0E 35          		DEC [HL]
0264++ 9A0F 35          		DEC [HL]
0265++ 9A10 34          .CORR_2: 	INC [HL]
0266++ 9A11 A7          		AND A
0267++ 9A12 ED 42       		SBC HL,BC
0268++ 9A14 13          		INC DE
0269++ 9A15 18 EB       		JR .CORR_1
0270++ 9A17             
0271++ 9A17             .TC_EXIT: 	;POP AF
0272++ 9A17             
0273++ 9A17             		; --- CREATE PT3 VOLUME TABLE (c) Ivan Roshin, adapted by SapphiRe ---
0274++ 9A17 21 11 00    		ld	hl,$11
0275++ 9A1A 54          		ld	d,h
0276++ 9A1B 5C          		ld	e,h
0277++ 9A1C DD 21 50 F1 		ld	IX,VT_+16
0278++ 9A20 06 0F       		ld	b,15
0279++ 9A22 E5          .INITV1: 	push	hl
0280++ 9A23 19          		add	hl,de
0281++ 9A24 EB          		ex	de,hl
0282++ 9A25 ED 62       		sbc	hl,hl
0283++ 9A27 48          		ld	c,b
0284++ 9A28 06 10       		ld	b,16
0285++ 9A2A 7D          .INITV2: 	ld	a,l
0286++ 9A2B 17          		rla
0287++ 9A2C 7C          		ld	a,h
0288++ 9A2D CE 00       		adc	a,0
0289++ 9A2F DD 77 00    		ld	[ix],a
0290++ 9A32 DD 23       		inc	ix
0291++ 9A34 19          		add	hl,de
0292++ 9A35 10 F3       		djnz	.INITV2
0293++ 9A37 E1          		pop	hl
0294++ 9A38 7B          		ld	a,e
0295++ 9A39 FE 77       		cp	$77
0296++ 9A3B 20 01       		jr	nz,.INITV3
0297++ 9A3D 1C          		inc	e
0298++ 9A3E 41          .INITV3: 	ld	b,c
0299++ 9A3F 10 E1       		djnz	.INITV1
0300++ 9A41             
0301++ 9A41 C9          		RET
0302++ 9A42             
0303++ 9A42             		;pattern decoder
0304++ 9A42 DD 36 08 00 PD_OrSm: 	LD [IX+(CHNPRM_Env_En-12)],0
0305++ 9A46 CD CC 9B    		CALL SETORN
0306++ 9A49 0A          		LD A,[BC]
0307++ 9A4A 03          		INC BC
0308++ 9A4B 0F          		RRCA
0309++ 9A4C             
0310++ 9A4C 87          PD_SAM: 		ADD A,A
0311++ 9A4D 5F          PD_SAM_: 	LD E,A
0312++ 9A4E 16 00       		LD D,0
0313++ 9A50 2A 05 F0    		LD HL,[PT3_SAMPTRS]
0314++ 9A53 19          		ADD HL,DE
0315++ 9A54 5E          		LD E,[HL]
0316++ 9A55 23          		INC HL
0317++ 9A56 56          		LD D,[HL]
0318++ 9A57 2A 01 F0    		LD HL,[PT3_MODADDR]
0319++ 9A5A 19          		ADD HL,DE
0320++ 9A5B DD 75 03    		LD [IX+(CHNPRM_SamPtr-12)],L
0321++ 9A5E DD 74 04    		LD [IX+(CHNPRM_SamPtr+1-12)],H
0322++ 9A61 18 41       		JR PD_LOOP
0323++ 9A63             
0324++ 9A63 07          PD_VOL: 		RLCA
0325++ 9A64 07          		RLCA
0326++ 9A65 07          		RLCA
0327++ 9A66 07          		RLCA
0328++ 9A67 DD 77 10    		LD [IX+(CHNPRM_Volume-12)],A
0329++ 9A6A 18 3B       		JR PD_LP2
0330++ 9A6C             	
0331++ 9A6C DD 77 08    PD_EOff: 	LD [IX+(CHNPRM_Env_En-12)],A
0332++ 9A6F DD 77 F4    		LD [IX+(CHNPRM_PsInOr-12)],A
0333++ 9A72 18 33       		JR PD_LP2
0334++ 9A74             
0335++ 9A74 3D          PD_SorE: 	DEC A
0336++ 9A75 20 07       		JR NZ,PD_ENV
0337++ 9A77 0A          		LD A,[BC]
0338++ 9A78 03          		INC BC
0339++ 9A79 DD 77 05    		LD [IX+(CHNPRM_NNtSkp-12)],A
0340++ 9A7C 18 29       		JR PD_LP2
0341++ 9A7E             
0342++ 9A7E CD B0 9B    PD_ENV: 		CALL SETENV
0343++ 9A81 18 24       		JR PD_LP2
0344++ 9A83             
0345++ 9A83 CD CC 9B    PD_ORN: 		CALL SETORN
0346++ 9A86 18 1C       		JR PD_LOOP
0347++ 9A88                    
0348++ 9A88 DD 77 08    PD_ESAM: 	LD [IX+(CHNPRM_Env_En-12)],A
0349++ 9A8B DD 77 F4    		LD [IX+(CHNPRM_PsInOr-12)],A
0350++ 9A8E C4 B0 9B    		CALL NZ,SETENV
0351++ 9A91 0A          		LD A,[BC]
0352++ 9A92 03          		INC BC
0353++ 9A93 18 B8       		JR PD_SAM_
0354++ 9A95             
0355++ 9A95 DD 7E 06    PTDECOD: 	LD A,[IX+(CHNPRM_Note-12)]
0356++ 9A98 32 0F F0    		LD [PT3_PrNote],A
0357++ 9A9B DD 6E FA    		LD L,[IX+(CHNPRM_CrTnSl-12)]
0358++ 9A9E DD 66 FB    		LD H,[IX+(CHNPRM_CrTnSl+1-12)]
0359++ 9AA1 22 10 F0    		LD [PT3_PrSlide],HL
0360++ 9AA4             
0361++ 9AA4 11 10 20    PD_LOOP: 	LD DE,$2010
0362++ 9AA7 0A          PD_LP2: 		LD A,[BC]
0363++ 9AA8 03          		INC BC
0364++ 9AA9 83          		ADD A,E
0365++ 9AAA 38 96       		JR C,PD_OrSm
0366++ 9AAC 82          		ADD A,D
0367++ 9AAD 28 4A       		JR Z,PD_FIN
0368++ 9AAF 38 9B       		JR C,PD_SAM
0369++ 9AB1 83          		ADD A,E
0370++ 9AB2 28 25       		JR Z,PD_REL
0371++ 9AB4 38 AD       		JR C,PD_VOL
0372++ 9AB6 83          		ADD A,E
0373++ 9AB7 28 B3       		JR Z,PD_EOff
0374++ 9AB9 38 B9       		JR C,PD_SorE
0375++ 9ABB C6 60       		ADD A,96
0376++ 9ABD 38 20       		JR C,PD_NOTE
0377++ 9ABF 83          		ADD A,E
0378++ 9AC0 38 C1       		JR C,PD_ORN
0379++ 9AC2 82          		ADD A,D
0380++ 9AC3 38 0F       		JR C,PD_NOIS
0381++ 9AC5 83          		ADD A,E
0382++ 9AC6 38 C0       		JR C,PD_ESAM
0383++ 9AC8 87          		ADD A,A
0384++ 9AC9 5F          		LD E,A
0385++ 9ACA 21 05 7B    		LD HL,(SPCCOMS+$DF20) % 65536	; Adapted from original Speccy version (saves 6 bytes)
0386++ 9ACD 19          		ADD HL,DE
0387++ 9ACE 5E          		LD E,[HL]
0388++ 9ACF 23          		INC HL
0389++ 9AD0 56          		LD D,[HL]
0390++ 9AD1 D5          		PUSH DE
0391++ 9AD2 18 D0       		JR PD_LOOP
0392++ 9AD4             
0393++ 9AD4 32 7E F0    PD_NOIS: 	LD [Ns_Base],A
0394++ 9AD7 18 CE       		JR PD_LP2
0395++ 9AD9             
0396++ 9AD9 DD CB 09 86 PD_REL: 		RES 0,[IX+(CHNPRM_Flags-12)]
0397++ 9ADD 18 08       		JR PD_RES
0398++ 9ADF             	
0399++ 9ADF DD 77 06    PD_NOTE: 	LD [IX+(CHNPRM_Note-12)],A
0400++ 9AE2 DD CB 09 C6 		SET 0,[IX+(CHNPRM_Flags-12)]
0401++ 9AE6 AF          		XOR A
0402++ 9AE7             
0403++ 9AE7 ED 73 09 F0 PD_RES: 		LD [PT3_PDSP],SP
0404++ 9AEB DD F9       		LD SP,IX
0405++ 9AED 67          		LD H,A
0406++ 9AEE 6F          		LD L,A
0407++ 9AEF E5          		PUSH HL
0408++ 9AF0 E5          		PUSH HL
0409++ 9AF1 E5          		PUSH HL
0410++ 9AF2 E5          		PUSH HL
0411++ 9AF3 E5          		PUSH HL
0412++ 9AF4 E5          		PUSH HL
0413++ 9AF5 ED 7B 09 F0 		LD SP,[PT3_PDSP]
0414++ 9AF9             
0415++ 9AF9 DD 7E 05    PD_FIN: 		LD A,[IX+(CHNPRM_NNtSkp-12)]
0416++ 9AFC DD 77 0F    		LD [IX+(CHNPRM_NtSkCn-12)],A
0417++ 9AFF C9          		RET
0418++ 9B00             
0419++ 9B00 DD CB 09 96 C_PORTM: 	RES 2,[IX+(CHNPRM_Flags-12)]
0420++ 9B04 0A          		LD A,[BC]
0421++ 9B05 03          		INC BC
0422++ 9B06             		;SKIP PRECALCULATED TONE DELTA [BECAUSE
0423++ 9B06             		;CANNOT BE RIGHT AFTER PT3 COMPILATION]
0424++ 9B06 03          		INC BC
0425++ 9B07 03          		INC BC
0426++ 9B08 DD 77 0A    		LD [IX+(CHNPRM_TnSlDl-12)],A
0427++ 9B0B DD 77 F9    		LD [IX+(CHNPRM_TSlCnt-12)],A
0428++ 9B0E 11 80 F0    		LD DE,NT_
0429++ 9B11 DD 7E 06    		LD A,[IX+(CHNPRM_Note-12)]
0430++ 9B14 DD 77 07    		LD [IX+(CHNPRM_SlToNt-12)],A
0431++ 9B17 87          		ADD A,A
0432++ 9B18 6F          		LD L,A
0433++ 9B19 26 00       		LD H,0
0434++ 9B1B 19          		ADD HL,DE
0435++ 9B1C 7E          		LD A,[HL]
0436++ 9B1D 23          		INC HL
0437++ 9B1E 66          		LD H,[HL]
0438++ 9B1F 6F          		LD L,A
0439++ 9B20 E5          		PUSH HL
0440++ 9B21 3A 0F F0    		LD A,[PT3_PrNote]
0441++ 9B24 DD 77 06    		LD [IX+(CHNPRM_Note-12)],A
0442++ 9B27 87          		ADD A,A
0443++ 9B28 6F          		LD L,A
0444++ 9B29 26 00       		LD H,0
0445++ 9B2B 19          		ADD HL,DE
0446++ 9B2C 5E          		LD E,[HL]
0447++ 9B2D 23          		INC HL
0448++ 9B2E 56          		LD D,[HL]
0449++ 9B2F E1          		POP HL
0450++ 9B30 ED 52       		SBC HL,DE
0451++ 9B32 DD 75 0D    		LD [IX+(CHNPRM_TnDelt-12)],L
0452++ 9B35 DD 74 0E    		LD [IX+(CHNPRM_TnDelt+1-12)],H
0453++ 9B38 ED 5B 10 F0 		LD DE,[PT3_PrSlide]
0454++ 9B3C DD 73 FA    		LD [IX+(CHNPRM_CrTnSl-12)],E
0455++ 9B3F DD 72 FB    		LD [IX+(CHNPRM_CrTnSl+1-12)],D
0456++ 9B42 0A          		LD A,[BC] ;SIGNED TONE STEP
0457++ 9B43 03          		INC BC
0458++ 9B44 08          		EX AF,AF'
0459++ 9B45 0A          		LD A,[BC]
0460++ 9B46 03          		INC BC
0461++ 9B47 A7          		AND A
0462++ 9B48 28 01       		JR Z,.NOSIG
0463++ 9B4A EB          		EX DE,HL
0464++ 9B4B ED 52       .NOSIG: 	SBC HL,DE
0465++ 9B4D F2 55 9B    		JP P,SET_STP
0466++ 9B50 2F          		CPL
0467++ 9B51 08          		EX AF,AF'
0468++ 9B52 ED 44       		NEG
0469++ 9B54 08          		EX AF,AF'
0470++ 9B55 DD 77 0C    SET_STP: 	LD [IX+(CHNPRM_TSlStp+1-12)],A
0471++ 9B58 08          		EX AF,AF'
0472++ 9B59 DD 77 0B    		LD [IX+(CHNPRM_TSlStp-12)],A
0473++ 9B5C DD 36 FE 00 		LD [IX+(CHNPRM_COnOff-12)],0
0474++ 9B60 C9          		RET
0475++ 9B61             
0476++ 9B61 DD CB 09 D6 C_GLISS: 	SET 2,[IX+(CHNPRM_Flags-12)]
0477++ 9B65 0A          		LD A,[BC]
0478++ 9B66 03          		INC BC
0479++ 9B67 DD 77 0A    		LD [IX+(CHNPRM_TnSlDl-12)],A
0480++ 9B6A DD 77 F9    		LD [IX+(CHNPRM_TSlCnt-12)],A
0481++ 9B6D 0A          		LD A,[BC]
0482++ 9B6E 03          		INC BC
0483++ 9B6F 08          		EX AF,AF'
0484++ 9B70 0A          		LD A,[BC]
0485++ 9B71 03          		INC BC
0486++ 9B72 18 E1       		JR SET_STP
0487++ 9B74             
0488++ 9B74 0A          C_SMPOS: 	LD A,[BC]
0489++ 9B75 03          		INC BC
0490++ 9B76 DD 77 F5    		LD [IX+(CHNPRM_PsInSm-12)],A
0491++ 9B79 C9          		RET
0492++ 9B7A             
0493++ 9B7A 0A          C_ORPOS: 	LD A,[BC]
0494++ 9B7B 03          		INC BC
0495++ 9B7C DD 77 F4    		LD [IX+(CHNPRM_PsInOr-12)],A
0496++ 9B7F C9          		RET
0497++ 9B80             
0498++ 9B80 0A          C_VIBRT: 	LD A,[BC]
0499++ 9B81 03          		INC BC
0500++ 9B82 DD 77 FF    		LD [IX+(CHNPRM_OnOffD-12)],A
0501++ 9B85 DD 77 FE    		LD [IX+(CHNPRM_COnOff-12)],A
0502++ 9B88 0A          		LD A,[BC]
0503++ 9B89 03          		INC BC
0504++ 9B8A DD 77 00    		LD [IX+(CHNPRM_OffOnD-12)],A
0505++ 9B8D AF          		XOR A
0506++ 9B8E DD 77 F9    		LD [IX+(CHNPRM_TSlCnt-12)],A
0507++ 9B91 DD 77 FA    		LD [IX+(CHNPRM_CrTnSl-12)],A
0508++ 9B94 DD 77 FB    		LD [IX+(CHNPRM_CrTnSl+1-12)],A
0509++ 9B97 C9          		RET
0510++ 9B98             
0511++ 9B98 0A          C_ENGLS: 	LD A,[BC]
0512++ 9B99 03          		INC BC
0513++ 9B9A 32 1E F0    		LD [PT3_Env_Del],A
0514++ 9B9D 32 7D F0    		LD [CurEDel],A
0515++ 9BA0 0A          		LD A,[BC]
0516++ 9BA1 03          		INC BC
0517++ 9BA2 6F          		LD L,A
0518++ 9BA3 0A          		LD A,[BC]
0519++ 9BA4 03          		INC BC
0520++ 9BA5 67          		LD H,A
0521++ 9BA6 22 1F F0    		LD [PT3_ESldAdd],HL
0522++ 9BA9 C9          		RET
0523++ 9BAA             
0524++ 9BAA 0A          C_DELAY: 	LD A,[BC]
0525++ 9BAB 03          		INC BC
0526++ 9BAC 32 1C F0    		LD [PT3_Delay],A
0527++ 9BAF C9          		RET
0528++ 9BB0             	
0529++ 9BB0 DD 73 08    SETENV: 		LD [IX+(CHNPRM_Env_En-12)],E
0530++ 9BB3 32 4D F1    		LD [AYREGS+AR_EnvTp],A
0531++ 9BB6 0A          		LD A,[BC]
0532++ 9BB7 03          		INC BC
0533++ 9BB8 67          		LD H,A
0534++ 9BB9 0A          		LD A,[BC]
0535++ 9BBA 03          		INC BC
0536++ 9BBB 6F          		LD L,A
0537++ 9BBC 22 4E F1    		LD [EnvBase],HL
0538++ 9BBF AF          		XOR A
0539++ 9BC0 DD 77 F4    		LD [IX+(CHNPRM_PsInOr-12)],A
0540++ 9BC3 32 7D F0    		LD [CurEDel],A
0541++ 9BC6 67          		LD H,A
0542++ 9BC7 6F          		LD L,A
0543++ 9BC8 22 7B F0    		LD [CurESld],HL
0544++ 9BCB C9          C_NOP: 		RET
0545++ 9BCC             
0546++ 9BCC 87          SETORN: 		ADD A,A
0547++ 9BCD 5F          		LD E,A
0548++ 9BCE 16 00       		LD D,0
0549++ 9BD0 DD 72 F4    		LD [IX+(CHNPRM_PsInOr-12)],D
0550++ 9BD3 2A 07 F0    		LD HL,[PT3_OrnPtrs]
0551++ 9BD6 19          		ADD HL,DE
0552++ 9BD7 5E          		LD E,[HL]
0553++ 9BD8 23          		INC HL
0554++ 9BD9 56          		LD D,[HL]
0555++ 9BDA 2A 01 F0    		LD HL,[PT3_MODADDR]
0556++ 9BDD 19          		ADD HL,DE
0557++ 9BDE DD 75 01    		LD [IX+(CHNPRM_OrnPtr-12)],L
0558++ 9BE1 DD 74 02    		LD [IX+(CHNPRM_OrnPtr+1-12)],H
0559++ 9BE4 C9          		RET
0560++ 9BE5             
0561++ 9BE5             		;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
0562++ 9BE5 CB 9B       SPCCOMS: 	dw C_NOP
0563++ 9BE7 61 9B       		dw C_GLISS
0564++ 9BE9 00 9B       		dw C_PORTM
0565++ 9BEB 74 9B       		dw C_SMPOS
0566++ 9BED 7A 9B       		dw C_ORPOS
0567++ 9BEF 80 9B       		dw C_VIBRT
0568++ 9BF1 CB 9B       		dw C_NOP
0569++ 9BF3 CB 9B       		dw C_NOP
0570++ 9BF5 98 9B       		dw C_ENGLS
0571++ 9BF7 AA 9B       		dw C_DELAY
0572++ 9BF9 CB 9B       		dw C_NOP
0573++ 9BFB CB 9B       		dw C_NOP
0574++ 9BFD CB 9B       		dw C_NOP
0575++ 9BFF CB 9B       		dw C_NOP
0576++ 9C01 CB 9B       		dw C_NOP
0577++ 9C03 CB 9B       		dw C_NOP
0578++ 9C05             
0579++ 9C05 AF          CHREGS: 		XOR A
0580++ 9C06 32 4A F1    		LD [AYREGS+AR_AmplC],A
0581++ 9C09 DD CB 15 46 		BIT 0,[IX+CHNPRM_Flags]
0582++ 9C0D E5          		PUSH HL
0583++ 9C0E CA 34 9D    		JP Z,.CH_EXIT
0584++ 9C11 ED 73 0B F0 		LD [PT3_CSP],SP
0585++ 9C15 DD 6E 0D    		LD L,[IX+CHNPRM_OrnPtr]
0586++ 9C18 DD 66 0E    		LD H,[IX+CHNPRM_OrnPtr+1]
0587++ 9C1B F9          		LD SP,HL
0588++ 9C1C D1          		POP DE
0589++ 9C1D 67          		LD H,A
0590++ 9C1E DD 7E 00    		LD A,[IX+CHNPRM_PsInOr]
0591++ 9C21 6F          		LD L,A
0592++ 9C22 39          		ADD HL,SP
0593++ 9C23 3C          		INC A
0594++ 9C24 BA          		CP D
0595++ 9C25 38 01       		JR C,.CH_ORPS
0596++ 9C27 7B          		LD A,E
0597++ 9C28 DD 77 00    .CH_ORPS: 	LD [IX+CHNPRM_PsInOr],A
0598++ 9C2B DD 7E 12    		LD A,[IX+CHNPRM_Note]
0599++ 9C2E 86          		ADD A,[HL]
0600++ 9C2F F2 33 9C    		JP P,.CH_NTP
0601++ 9C32 AF          		XOR A
0602++ 9C33 FE 60       .CH_NTP: 	CP 96
0603++ 9C35 38 02       		JR C,.CH_NOK
0604++ 9C37 3E 5F       		LD A,95
0605++ 9C39 87          .CH_NOK: 	ADD A,A
0606++ 9C3A 08          		EX AF,AF'
0607++ 9C3B DD 6E 0F    		LD L,[IX+CHNPRM_SamPtr]
0608++ 9C3E DD 66 10    		LD H,[IX+CHNPRM_SamPtr+1]
0609++ 9C41 F9          		LD SP,HL
0610++ 9C42 D1          		POP DE
0611++ 9C43 26 00       		LD H,0
0612++ 9C45 DD 7E 01    		LD A,[IX+CHNPRM_PsInSm]
0613++ 9C48 47          		LD B,A
0614++ 9C49 87          		ADD A,A
0615++ 9C4A 87          		ADD A,A
0616++ 9C4B 6F          		LD L,A
0617++ 9C4C 39          		ADD HL,SP
0618++ 9C4D F9          		LD SP,HL
0619++ 9C4E 78          		LD A,B
0620++ 9C4F 3C          		INC A
0621++ 9C50 BA          		CP D
0622++ 9C51 38 01       		JR C,.CH_SMPS
0623++ 9C53 7B          		LD A,E
0624++ 9C54 DD 77 01    .CH_SMPS: 	LD [IX+CHNPRM_PsInSm],A
0625++ 9C57 C1          		POP BC
0626++ 9C58 E1          		POP HL
0627++ 9C59 DD 5E 08    		LD E,[IX+CHNPRM_TnAcc]
0628++ 9C5C DD 56 09    		LD D,[IX+CHNPRM_TnAcc+1]
0629++ 9C5F 19          		ADD HL,DE
0630++ 9C60 CB 70       		BIT 6,B
0631++ 9C62 28 06       		JR Z,.CH_NOAC
0632++ 9C64 DD 75 08    		LD [IX+CHNPRM_TnAcc],L
0633++ 9C67 DD 74 09    		LD [IX+CHNPRM_TnAcc+1],H
0634++ 9C6A EB          .CH_NOAC: 	EX DE,HL
0635++ 9C6B 08          		EX AF,AF'
0636++ 9C6C 6F          		LD L,A
0637++ 9C6D 26 00       		LD H,0
0638++ 9C6F 31 80 F0    		LD SP,NT_
0639++ 9C72 39          		ADD HL,SP
0640++ 9C73 F9          		LD SP,HL
0641++ 9C74 E1          		POP HL
0642++ 9C75 19          		ADD HL,DE
0643++ 9C76 DD 5E 06    		LD E,[IX+CHNPRM_CrTnSl]
0644++ 9C79 DD 56 07    		LD D,[IX+CHNPRM_CrTnSl+1]
0645++ 9C7C 19          		ADD HL,DE
0646++ 9C7D ED 7B 0B F0 		LD SP,[PT3_CSP]
0647++ 9C81 E3          		EX [SP],HL
0648++ 9C82 AF          		XOR A
0649++ 9C83 DD B6 05    		OR [IX+CHNPRM_TSlCnt]
0650++ 9C86 28 3E       		JR Z,.CH_AMP
0651++ 9C88 DD 35 05    		DEC [IX+CHNPRM_TSlCnt]
0652++ 9C8B 20 39       		JR NZ,.CH_AMP
0653++ 9C8D DD 7E 16    		LD A,[IX+CHNPRM_TnSlDl]
0654++ 9C90 DD 77 05    		LD [IX+CHNPRM_TSlCnt],A
0655++ 9C93 DD 6E 17    		LD L,[IX+CHNPRM_TSlStp]
0656++ 9C96 DD 66 18    		LD H,[IX+CHNPRM_TSlStp+1]
0657++ 9C99 7C          		LD A,H
0658++ 9C9A 19          		ADD HL,DE
0659++ 9C9B DD 75 06    		LD [IX+CHNPRM_CrTnSl],L
0660++ 9C9E DD 74 07    		LD [IX+CHNPRM_CrTnSl+1],H
0661++ 9CA1 DD CB 15 56 		BIT 2,[IX+CHNPRM_Flags]
0662++ 9CA5 20 1F       		JR NZ,.CH_AMP
0663++ 9CA7 DD 5E 19    		LD E,[IX+CHNPRM_TnDelt]
0664++ 9CAA DD 56 1A    		LD D,[IX+CHNPRM_TnDelt+1]
0665++ 9CAD A7          		AND A
0666++ 9CAE 28 01       		JR Z,.CH_STPP
0667++ 9CB0 EB          		EX DE,HL
0668++ 9CB1 ED 52       .CH_STPP: 	SBC HL,DE
0669++ 9CB3 FA C6 9C    		JP M,.CH_AMP
0670++ 9CB6 DD 7E 13    		LD A,[IX+CHNPRM_SlToNt]
0671++ 9CB9 DD 77 12    		LD [IX+CHNPRM_Note],A
0672++ 9CBC AF          		XOR A
0673++ 9CBD DD 77 05    		LD [IX+CHNPRM_TSlCnt],A
0674++ 9CC0 DD 77 06    		LD [IX+CHNPRM_CrTnSl],A
0675++ 9CC3 DD 77 07    		LD [IX+CHNPRM_CrTnSl+1],A
0676++ 9CC6 DD 7E 02    .CH_AMP: 	LD A,[IX+CHNPRM_CrAmSl]
0677++ 9CC9 CB 79       		BIT 7,C
0678++ 9CCB 28 13       		JR Z,.CH_NOAM
0679++ 9CCD CB 71       		BIT 6,C
0680++ 9CCF 28 07       		JR Z,.CH_AMIN
0681++ 9CD1 FE 0F       		CP 15
0682++ 9CD3 28 0B       		JR Z,.CH_NOAM
0683++ 9CD5 3C          		INC A
0684++ 9CD6 18 05       		JR .CH_SVAM
0685++ 9CD8 FE F1       .CH_AMIN: 	CP -15
0686++ 9CDA 28 04       		JR Z,.CH_NOAM
0687++ 9CDC 3D          		DEC A
0688++ 9CDD DD 77 02    .CH_SVAM: 	LD [IX+CHNPRM_CrAmSl],A
0689++ 9CE0 6F          .CH_NOAM: 	LD L,A
0690++ 9CE1 78          		LD A,B
0691++ 9CE2 E6 0F       		AND 15
0692++ 9CE4 85          		ADD A,L
0693++ 9CE5 F2 E9 9C    		JP P,.CH_APOS
0694++ 9CE8 AF          		XOR A
0695++ 9CE9 FE 10       .CH_APOS: 	CP 16
0696++ 9CEB 38 02       		JR C,.CH_VOL
0697++ 9CED 3E 0F       		LD A,15
0698++ 9CEF DD B6 1C    .CH_VOL: 	OR [IX+CHNPRM_Volume]
0699++ 9CF2 6F          		LD L,A
0700++ 9CF3 26 00       		LD H,0
0701++ 9CF5 11 40 F1    		LD DE,VT_
0702++ 9CF8 19          		ADD HL,DE
0703++ 9CF9 7E          		LD A,[HL]
0704++ 9CFA CB 41       .CH_ENV: 	BIT 0,C
0705++ 9CFC 20 03       		JR NZ,.CH_NOEN
0706++ 9CFE DD B6 14    		OR [IX+CHNPRM_Env_En]
0707++ 9D01 32 4A F1    .CH_NOEN: 	LD [AYREGS+AR_AmplC],A
0708++ 9D04 CB 78       		BIT 7,B
0709++ 9D06 79          		LD A,C
0710++ 9D07 28 19       		JR Z,.NO_ENSL
0711++ 9D09 17          		RLA
0712++ 9D0A 17          		RLA
0713++ 9D0B CB 2F       		SRA A
0714++ 9D0D CB 2F       		SRA A
0715++ 9D0F CB 2F       		SRA A
0716++ 9D11 DD 86 04    		ADD A,[IX+CHNPRM_CrEnSl] ;SEE COMMENT BELOW
0717++ 9D14 CB 68       		BIT 5,B
0718++ 9D16 28 03       		JR Z,.NO_ENAC
0719++ 9D18 DD 77 04    		LD [IX+CHNPRM_CrEnSl],A
0720++ 9D1B 21 1D F0    .NO_ENAC: 	LD HL,PT3_AddToEn
0721++ 9D1E 86          		ADD A,[HL] ;BUG IN PT3 - NEED WORD HERE.
0722++ 9D1F             			   ;FIX IT IN NEXT VERSION?
0723++ 9D1F 77          		LD [HL],A
0724++ 9D20 18 0E       		JR .CH_MIX
0725++ 9D22 1F          .NO_ENSL: 	RRA
0726++ 9D23 DD 86 03    		ADD A,[IX+CHNPRM_CrNsSl]
0727++ 9D26 32 7F F0    		LD [AddToNs],A
0728++ 9D29 CB 68       		BIT 5,B
0729++ 9D2B 28 03       		JR Z,.CH_MIX
0730++ 9D2D DD 77 03    		LD [IX+CHNPRM_CrNsSl],A
0731++ 9D30 78          .CH_MIX: 	LD A,B
0732++ 9D31 1F          		RRA
0733++ 9D32 E6 48       		AND $48
0734++ 9D34 21 47 F1    .CH_EXIT: 	LD HL,AYREGS+AR_Mixer
0735++ 9D37 B6          		OR [HL]
0736++ 9D38 0F          		RRCA
0737++ 9D39 77          		LD [HL],A
0738++ 9D3A E1          		POP HL
0739++ 9D3B AF          		XOR A
0740++ 9D3C DD B6 0A    		OR [IX+CHNPRM_COnOff]
0741++ 9D3F C8          		RET Z
0742++ 9D40 DD 35 0A    		DEC [IX+CHNPRM_COnOff]
0743++ 9D43 C0          		RET NZ
0744++ 9D44 DD AE 15    		XOR [IX+CHNPRM_Flags]
0745++ 9D47 DD 77 15    		LD [IX+CHNPRM_Flags],A
0746++ 9D4A 1F          		RRA
0747++ 9D4B DD 7E 0B    		LD A,[IX+CHNPRM_OnOffD]
0748++ 9D4E 38 03       		JR C,.CH_ONDL
0749++ 9D50 DD 7E 0C    		LD A,[IX+CHNPRM_OffOnD]
0750++ 9D53 DD 77 0A    .CH_ONDL: 	LD [IX+CHNPRM_COnOff],A
0751++ 9D56 C9          		RET
0752++ 9D57             
0753++ 9D57 AF          PT3_PLAY: 	XOR A
0754++ 9D58 32 1D F0    		LD [PT3_AddToEn],A
0755++ 9D5B 32 47 F1    		LD [AYREGS+AR_Mixer],A
0756++ 9D5E 3D          		DEC A
0757++ 9D5F 32 4D F1    		LD [AYREGS+AR_EnvTp],A
0758++ 9D62 21 7A F0    		LD HL,DelyCnt
0759++ 9D65 35          		DEC [HL]
0760++ 9D66 C2 ED 9D    		JP NZ,.PL2
0761++ 9D69 21 3E F0    		LD HL,ChanA+CHNPRM_NtSkCn
0762++ 9D6C 35          		DEC [HL]
0763++ 9D6D 20 4E       		JR NZ,.PL1B
0764++ 9D6F ED 4B 12 F0 		LD BC,[PT3_AdInPtA]
0765++ 9D73 0A          		LD A,[BC]
0766++ 9D74 A7          		AND A
0767++ 9D75 20 3B       		JR NZ,.PL1A
0768++ 9D77 57          		LD D,A
0769++ 9D78 32 7E F0    		LD [Ns_Base],A
0770++ 9D7B 2A 03 F0    		LD HL,[PT3_CrPsPtr]
0771++ 9D7E 23          		INC HL
0772++ 9D7F 7E          		LD A,[HL]
0773++ 9D80 3C          		INC A
0774++ 9D81 20 08       		JR NZ,.PLNLP
0775++ 9D83 CD ED 98    		CALL CHECKLP
0776++ 9D86 2A 18 F0    		LD HL,[PT3_LPosPtr]
0777++ 9D89 7E          		LD A,[HL]
0778++ 9D8A 3C          		INC A
0779++ 9D8B 22 03 F0    .PLNLP: 	LD [PT3_CrPsPtr],HL
0780++ 9D8E 3D          		DEC A
0781++ 9D8F 87          		ADD A,A
0782++ 9D90 5F          		LD E,A
0783++ 9D91 CB 12       		RL D
0784++ 9D93 2A 1A F0    		LD HL,[PT3_PatsPtr]
0785++ 9D96 19          		ADD HL,DE
0786++ 9D97 ED 5B 01 F0 		LD DE,[PT3_MODADDR]
0787++ 9D9B ED 73 0D F0 		LD [PT3_PSP],SP
0788++ 9D9F F9          		LD SP,HL
0789++ 9DA0 E1          		POP HL
0790++ 9DA1 19          		ADD HL,DE
0791++ 9DA2 44          		LD B,H
0792++ 9DA3 4D          		LD C,L
0793++ 9DA4 E1          		POP HL
0794++ 9DA5 19          		ADD HL,DE
0795++ 9DA6 22 14 F0    		LD [PT3_AdInPtB],HL
0796++ 9DA9 E1          		POP HL
0797++ 9DAA 19          		ADD HL,DE
0798++ 9DAB 22 16 F0    		LD [PT3_AdInPtC],HL
0799++ 9DAE ED 7B 0D F0 		LD SP,[PT3_PSP]
0800++ 9DB2             
0801++ 9DB2 DD 21 2F F0 .PL1A: 		LD IX,ChanA+12
0802++ 9DB6 CD 95 9A    		CALL PTDECOD
0803++ 9DB9 ED 43 12 F0 		LD [PT3_AdInPtA],BC
0804++ 9DBD             
0805++ 9DBD 21 5B F0    .PL1B: 		LD HL,ChanB+CHNPRM_NtSkCn
0806++ 9DC0 35          		DEC [HL]
0807++ 9DC1 20 0F       		JR NZ,.PL1C
0808++ 9DC3 DD 21 4C F0 		LD IX,ChanB+12
0809++ 9DC7 ED 4B 14 F0 		LD BC,[PT3_AdInPtB]
0810++ 9DCB CD 95 9A    		CALL PTDECOD
0811++ 9DCE ED 43 14 F0 		LD [PT3_AdInPtB],BC
0812++ 9DD2             
0813++ 9DD2 21 78 F0    .PL1C: 		LD HL,ChanC+CHNPRM_NtSkCn
0814++ 9DD5 35          		DEC [HL]
0815++ 9DD6 20 0F       		JR NZ,.PL1D
0816++ 9DD8 DD 21 69 F0 		LD IX,ChanC+12
0817++ 9DDC ED 4B 16 F0 		LD BC,[PT3_AdInPtC]
0818++ 9DE0 CD 95 9A    		CALL PTDECOD
0819++ 9DE3 ED 43 16 F0 		LD [PT3_AdInPtC],BC
0820++ 9DE7             
0821++ 9DE7 3A 1C F0    .PL1D: 		LD A,[PT3_Delay]
0822++ 9DEA 32 7A F0    		LD [DelyCnt],A
0823++ 9DED             
0824++ 9DED DD 21 23 F0 .PL2: 		LD IX,ChanA
0825++ 9DF1 2A 40 F1    		LD HL,[AYREGS+AR_TonA]
0826++ 9DF4 CD 05 9C    		CALL CHREGS
0827++ 9DF7 22 40 F1    		LD [AYREGS+AR_TonA],HL
0828++ 9DFA 3A 4A F1    		LD A,[AYREGS+AR_AmplC]
0829++ 9DFD 32 48 F1    		LD [AYREGS+AR_AmplA],A
0830++ 9E00 DD 21 40 F0 		LD IX,ChanB
0831++ 9E04 2A 42 F1    		LD HL,[AYREGS+AR_TonB]
0832++ 9E07 CD 05 9C    		CALL CHREGS
0833++ 9E0A 22 42 F1    		LD [AYREGS+AR_TonB],HL
0834++ 9E0D 3A 4A F1    		LD A,[AYREGS+AR_AmplC]
0835++ 9E10 32 49 F1    		LD [AYREGS+AR_AmplB],A
0836++ 9E13 DD 21 5D F0 		LD IX,ChanC
0837++ 9E17 2A 44 F1    		LD HL,[AYREGS+AR_TonC]
0838++ 9E1A CD 05 9C    		CALL CHREGS
0839++ 9E1D 22 44 F1    		LD [AYREGS+AR_TonC],HL
0840++ 9E20             
0841++ 9E20 2A 7E F0    		LD HL,[Ns_Base_AddToNs]
0842++ 9E23 7C          		LD A,H
0843++ 9E24 85          		ADD A,L
0844++ 9E25 32 46 F1    		LD [AYREGS+AR_Noise],A
0845++ 9E28             
0846++ 9E28 3A 1D F0    		LD A,[PT3_AddToEn]
0847++ 9E2B 5F          		LD E,A
0848++ 9E2C 87          		ADD A,A
0849++ 9E2D 9F          		SBC A,A
0850++ 9E2E 57          		LD D,A
0851++ 9E2F 2A 4E F1    		LD HL,[EnvBase]
0852++ 9E32 19          		ADD HL,DE
0853++ 9E33 ED 5B 7B F0 		LD DE,[CurESld]
0854++ 9E37 19          		ADD HL,DE
0855++ 9E38 22 4B F1    		LD [AYREGS+AR_Env],HL
0856++ 9E3B             
0857++ 9E3B AF          		XOR A
0858++ 9E3C 21 7D F0    		LD HL,CurEDel
0859++ 9E3F B6          		OR [HL]
0860++ 9E40 C8          		RET Z
0861++ 9E41 35          		DEC [HL]
0862++ 9E42 C0          		RET NZ
0863++ 9E43 3A 1E F0    		LD A,[PT3_Env_Del]
0864++ 9E46 77          		LD [HL],A
0865++ 9E47 2A 1F F0    		LD HL,[PT3_ESldAdd]
0866++ 9E4A 19          		ADD HL,DE
0867++ 9E4B 22 7B F0    		LD [CurESld],HL
0868++ 9E4E C9          		RET
0869++ 9E4F             
0870++ 9E4F AF          PT3_ROUT: 	XOR A
0871++ 9E50             	
0872++ 9E50             ROUT_A0: 	; --- FIXES BITS 6 AND 7 OF MIXER ---
0873++ 9E50 21 47 F1    		LD	HL,AYREGS+AR_Mixer
0874++ 9E53 CB FE       		set	7,[hl]
0875++ 9E55 CB B6       		res	6,[hl]
0876++ 9E57             
0877++ 9E57 0E A0       		LD C,$A0
0878++ 9E59 21 40 F1    		LD HL,AYREGS
0879++ 9E5C ED 79       .LOUT: 		OUT [C],A
0880++ 9E5E 0C          		INC C
0881++ 9E5F ED A3       		OUTI 
0882++ 9E61 0D          		DEC C
0883++ 9E62 3C          		INC A
0884++ 9E63 FE 0D       		CP 13
0885++ 9E65 20 F5       		JR NZ,.LOUT
0886++ 9E67 ED 79       		OUT [C],A
0887++ 9E69 7E          		LD A,[HL]
0888++ 9E6A A7          		AND A
0889++ 9E6B F8          		RET M
0890++ 9E6C 0C          		INC C
0891++ 9E6D ED 79       		OUT [C],A
0892++ 9E6F C9          		RET
0893++ 9E70             
0894++ 9E70 64          NT_DATA: 	db (T_NEW_0-T1_)*2
0895++ 9E71 2A          		db TCNEW_0-T_
0896++ 9E72 65          		db (T_OLD_0-T1_)*2+1
0897++ 9E73 00          		db TCOLD_0-T_
0898++ 9E74 01          		db (T_NEW_1-T1_)*2+1
0899++ 9E75 0C          		db TCNEW_1-T_
0900++ 9E76 01          		db (T_OLD_1-T1_)*2+1
0901++ 9E77 0C          		db TCOLD_1-T_
0902++ 9E78 94          		db (T_NEW_2-T1_)*2
0903++ 9E79 35          		db TCNEW_2-T_
0904++ 9E7A 30          		db (T_OLD_2-T1_)*2
0905++ 9E7B 0E          		db TCOLD_2-T_
0906++ 9E7C 60          		db (T_NEW_3-T1_)*2
0907++ 9E7D 20          		db TCNEW_3-T_
0908++ 9E7E 60          		db (T_OLD_3-T1_)*2
0909++ 9E7F 21          		db TCOLD_3-T_
0910++ 9E80             
0911++ 9E80             T_: 
0912++ 9E80             
0913++ 9E80             TCOLD_0: 	db $00+1,$04+1,$08+1,$0A+1,$0C+1,$0E+1,$12+1,$14+1
0913++ 9E80 0105090B0D0F1315
0914++ 9E88 19 25 3D 00 		db $18+1,$24+1,$3C+1,0
0915++ 9E8C             TCNEW_1: 	
0916++ 9E8C 5D 00       TCOLD_1: 	db $5C+1,0
0917++ 9E8E             TCOLD_2: 	db $30+1,$36+1,$4C+1,$52+1,$5E+1,$70+1,$82,$8C,$9C
0917++ 9E8E 31374D535F71828C9C
0918++ 9E97             		db $9E,$A0,$A6,$A8,$AA,$AC,$AE,$AE,0
0918++ 9E97 9EA0A6A8AAACAEAE00
0919++ 9EA0 57          TCNEW_3: 	db $56+1
0920++ 9EA1             TCOLD_3: 	db $1E+1,$22+1,$24+1,$28+1,$2C+1,$2E+1,$32+1,$BE+1,0
0920++ 9EA1 1F2325292D2F33BF00
0921++ 9EAA             TCNEW_0: 	db $1C+1,$20+1,$22+1,$26+1,$2A+1,$2C+1,$30+1,$54+1
0921++ 9EAA 1D2123272B2D3155
0922++ 9EB2 BD BF 00    		db $BC+1,$BE+1,0
0923++ 9EB5             TCNEW_2: 	db $1A+1,$20+1,$24+1,$28+1,$2A+1,$3A+1,$4C+1,$5E+1
0923++ 9EB5 1B2125292B3B4D5F
0924++ 9EBD BB BD BF    		db $BA+1,$BC+1,$BE+1
0925++ 9EC0             
0926++ 9EC0 00 01 00 90 EMPTYSAMORN:  	db 0,1,0,$90 ;delete $90 if you don't need default sample
0927++ 9EC4             
0928++ 9EC4             T_PACK: 		; First 12 values of tone tables (packed)
0929++ 9EC4 0D          		db ($06EC*2)/256
0930++ 9EC5 D8          		db #d8
0931++ 9EC6 69          		db $0755-$06EC
0932++ 9EC7 70          		db $07C5-$0755
0933++ 9EC8 76          		db $083B-$07C5
0934++ 9EC9 7D          		db $08B8-$083B
0935++ 9ECA 85          		db $093D-$08B8
0936++ 9ECB 8D          		db $09CA-$093D
0937++ 9ECC 95          		db $0A5F-$09CA
0938++ 9ECD 9D          		db $0AFC-$0A5F
0939++ 9ECE A8          		db $0BA4-$0AFC
0940++ 9ECF B1          		db $0C55-$0BA4
0941++ 9ED0 BB          		db $0D10-$0C55
0942++ 9ED1 0C          		db ($066D*2)/256
0943++ 9ED2 DA          		db #da
0944++ 9ED3 62          		db $06CF-$066D
0945++ 9ED4 68          		db $0737-$06CF
0946++ 9ED5 6D          		db $07A4-$0737
0947++ 9ED6 75          		db $0819-$07A4
0948++ 9ED7 7B          		db $0894-$0819
0949++ 9ED8 83          		db $0917-$0894
0950++ 9ED9 8A          		db $09A1-$0917
0951++ 9EDA 92          		db $0A33-$09A1
0952++ 9EDB 9C          		db $0ACF-$0A33
0953++ 9EDC A4          		db $0B73-$0ACF
0954++ 9EDD AF          		db $0C22-$0B73
0955++ 9EDE B8          		db $0CDA-$0C22
0956++ 9EDF 0E          		db ($0704*2)/256
0957++ 9EE0 08          		db #08
0958++ 9EE1 6A          		db $076E-$0704
0959++ 9EE2 72          		db $07E0-$076E
0960++ 9EE3 78          		db $0858-$07E0
0961++ 9EE4 7E          		db $08D6-$0858
0962++ 9EE5 86          		db $095C-$08D6
0963++ 9EE6 90          		db $09EC-$095C
0964++ 9EE7 96          		db $0A82-$09EC
0965++ 9EE8 A0          		db $0B22-$0A82
0966++ 9EE9 AA          		db $0BCC-$0B22
0967++ 9EEA B4          		db $0C80-$0BCC
0968++ 9EEB BE          		db $0D3E-$0C80
0969++ 9EEC 0F          		db ($07E0*2)/256
0970++ 9EED C0          		db #c0
0971++ 9EEE 78          		db $0858-$07E0
0972++ 9EEF 88          		db $08E0-$0858
0973++ 9EF0 80          		db $0960-$08E0
0974++ 9EF1 90          		db $09F0-$0960
0975++ 9EF2 98          		db $0A88-$09F0
0976++ 9EF3 A0          		db $0B28-$0A88
0977++ 9EF4 B0          		db $0BD8-$0B28
0978++ 9EF5 A8          		db $0C80-$0BD8
0979++ 9EF6 E0          		db $0D60-$0C80
0980++ 9EF7 B0          		db $0E10-$0D60
0981++ 9EF8 E8          		db $0EF8-$0E10
0982++ 9EF9             
0983++ 9EF9             	;Variables del replayer... las coloco desde aqui.
0984++ 9EF9             	;mirar que hace la directiva MAP del SJASM
0985++ 9EF9             	map		#f000
0986++ 9EF9             
0987++ 9EF9             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;PT3 REPLAYER
0988++ 9EF9             PT3_SETUP: 		#1	;set bit0 to 1, if you want to play without looping
0989++ 9EF9             					;bit7 is set each time, when loop point is passed
0990++ 9EF9             PT3_MODADDR: 	#2
0991++ 9EF9             PT3_CrPsPtr: 		#2
0992++ 9EF9             PT3_SAMPTRS: 		#2
0993++ 9EF9             PT3_OrnPtrs: 		#2
0994++ 9EF9             PT3_PDSP: 		#2
0995++ 9EF9             PT3_CSP: 		#2 
0996++ 9EF9             PT3_PSP: 		#2
0997++ 9EF9             PT3_PrNote: 		#1
0998++ 9EF9             PT3_PrSlide: 		#2
0999++ 9EF9             PT3_AdInPtA: 		#2
1000++ 9EF9             PT3_AdInPtB: 		#2
1001++ 9EF9             PT3_AdInPtC: 		#2
1002++ 9EF9             PT3_LPosPtr: 		#2
1003++ 9EF9             PT3_PatsPtr: 		#2
1004++ 9EF9             PT3_Delay: 		#1
1005++ 9EF9             PT3_AddToEn: 		#1
1006++ 9EF9             PT3_Env_Del: 		#1
1007++ 9EF9             PT3_ESldAdd: 		#2
1008++ 9EF9             PT3_NTL3: 		#2	; AND A / NOP (note table creator)
1009++ 9EF9             
1010++ 9EF9             VARS: 			#0
1011++ 9EF9             
1012++ 9EF9             ChanA: 			#29			;CHNPRM_Size
1013++ 9EF9             ChanB: 			#29			;CHNPRM_Size
1014++ 9EF9             ChanC: 			#29			;CHNPRM_Size
1015++ 9EF9             
1016++ 9EF9             ;GlobalVars
1017++ 9EF9             DelyCnt: 		#1
1018++ 9EF9             CurESld: 		#2
1019++ 9EF9             CurEDel: 		#1
1020++ 9EF9             Ns_Base_AddToNs: 	#0
1021++ 9EF9             Ns_Base: 		#1
1022++ 9EF9             AddToNs: 		#1
1023++ 9EF9             
1024++ 9EF9             NT_: 			#192	; Puntero a/tabla de frecuencias
1025++ 9EF9             
1026++ 9EF9             AYREGS: 			#0
1027++ 9EF9             VT_: 			#14
1028++ 9EF9             EnvBase: 		#2
1029++ 9EF9             VAR0END: 		#0
1030++ 9EF9             
1031++ 9EF9             T1_: 			#0		
1032++ 9EF9             T_NEW_1: 		#0
1033++ 9EF9             T_OLD_1: 		#24
1034++ 9EF9             T_OLD_2: 		#24
1035++ 9EF9             T_NEW_3: 		#0
1036++ 9EF9             T_OLD_3: 		#2
1037++ 9EF9             T_OLD_0: 		#0
1038++ 9EF9             T_NEW_0: 		#24
1039++ 9EF9             T_NEW_2: 		#166
1040++ 9EF9             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;PT3 REPLAYER END
1041++ 9EF9             
1042++ 9EF9             
1043++ 9EF9             
1044++ 9EF9             
1045++ 9EF9             
1046++ 9EF9             
1047++ 9EF9             
1048++ 9EF9             
1049++ 9EF9             
1050++ 9EF9             
1051++ 9EF9             
1052++ 9EF9             
0149+  9EF9             ingame: 
0150+  9EF9             	incbin "dd.pt3"	
0151+  A130             menu: 
0152+  A130                 incbin "musicdisc.pt3"	
0153+  A3F9             final: 
0154+  A3F9                 incbin "final.pt3"		
0155+  AA81             fx_player: 
0156+  AA81                 include	"ayFX_player.asm"	;efectos de https://github.com/Threetwosevensixseven/ayfxedit-improved
0001++ AA81             		; --- ayFX REPLAYER v1.31 ---
0002++ AA81             
0003++ AA81             		; --- v1.31	Fixed bug on previous version, only PSG channel C worked
0004++ AA81             		; --- v1.3	Fixed volume and Relative volume versions on the same file, conditional compilation
0005++ AA81             		; ---		Support for dynamic or fixed channel allocation
0006++ AA81             		; --- v1.2f/r	ayFX bank support
0007++ AA81             		; --- v1.11f/r	If a frame volume is zero then no AYREGS update
0008++ AA81             		; --- v1.1f/r	Fixed volume for all ayFX streams
0009++ AA81             		; --- v1.1	Explicit priority (as suggested by AR)
0010++ AA81             		; --- v1.0f	Bug fixed (error when using noise)
0011++ AA81             		; --- v1.0	Initial release
0012++ AA81             
0013++ AA81             		; --- DEFINE AYFXRELATIVE AS 0 FOR FIXED VOLUME VERSION ---
0014++ AA81             		; --- DEFINE AYFXRELATIVE AS 1 FOR RELATIVE VOLUME VERSION ---
0015++ AA81             AYFXRELATIVE equ 0
0016++ AA81             
0017++ AA81             ayFX_SETUP: 	; ---          ayFX replayer setup          ---
0018++ AA81             		; --- INPUT: HL -> pointer to the ayFX bank ---
0019++ AA81 22 41 F2    		ld	[ayFX_BANK],hl			; Current ayFX bank
0020++ AA84 3E 01       		ld	a,1				; a:=0
0021++ AA86 32 40 F2    		ld	[ayFX_MODE],a			; Initial mode: fixed channel
0022++ AA89 3C          		inc	a				; Starting channel (=1)
0023++ AA8A 32 4A F2    		ld	[ayFX_CHANNEL],a		; Updated
0024++ AA8D             ayFX_END: 	; --- End of an ayFX stream ---
0025++ AA8D 3E FF       		ld	a,255				; Lowest ayFX priority
0026++ AA8F 32 43 F2    		ld	[ayFX_PRIORITY],a		; Priority saved (not playing ayFX stream)
0027++ AA92 C9          		ret					; Return
0028++ AA93             
0029++ AA93             ayFX_INIT: 	; ---     INIT A NEW ayFX STREAM     ---
0030++ AA93             		; --- INPUT: A -> sound to be played ---
0031++ AA93             		; ---        C -> sound priority     ---
0032++ AA93 C5          		push	bc				; Store bc in stack
0033++ AA94 D5          		push	de				; Store de in stack
0034++ AA95 E5          		push	hl				; Store hl in stack
0035++ AA96             		; --- Check if the index is in the bank ---
0036++ AA96 47          		ld	b,a				; b:=a (new ayFX stream index)
0037++ AA97 2A 41 F2    		ld	hl,[ayFX_BANK]			; Current ayFX BANK
0038++ AA9A 7E          		ld	a,[hl]				; Number of samples in the bank
0039++ AA9B B7          		or	a				; If zero (means 256 samples)...
0040++ AA9C 28 06       		jr	z,.CHECK_PRI			; ...goto .CHECK_PRI
0041++ AA9E             		; The bank has less than 256 samples
0042++ AA9E 78          		ld	a,b				; a:=b (new ayFX stream index)
0043++ AA9F BE          		cp	[hl]				; If new index is not in the bank...
0044++ AAA0 3E 02       		ld	a,2				; a:=2 (error 2: Sample not in the bank)
0045++ AAA2 30 21       		jr	nc,.INIT_END			; ...we can't init it
0046++ AAA4             .CHECK_PRI: 	; --- Check if the new priority is lower than the current one ---
0047++ AAA4             		; ---   Remember: 0 = highest priority, 15 = lowest priority  ---
0048++ AAA4 78          		ld	a,b				; a:=b (new ayFX stream index)
0049++ AAA5 3A 43 F2    		ld	a,[ayFX_PRIORITY]		; a:=Current ayFX stream priority
0050++ AAA8 B9          		cp	c				; If new ayFX stream priority is lower than current one...
0051++ AAA9 3E 01       		ld	a,1				; a:=1 (error 1: A sample with higher priority is being played)
0052++ AAAB 38 18       		jr	c,.INIT_END			; ...we don't start the new ayFX stream
0053++ AAAD             		; --- Set new priority ---
0054++ AAAD 79          		ld	a,c				; a:=New priority
0055++ AAAE E6 0F       		and	$0F				; We mask the priority
0056++ AAB0 32 43 F2    		ld	[ayFX_PRIORITY],a		; new ayFX stream priority saved in RAM
0057++ AAB3             
0058++ AAB3             		IF ( AYFXRELATIVE == 1 )
0059++ AAB3~            			; --- Volume adjust using PT3 volume table ---
0060++ AAB3~            			ld	c,a				; c:=New priority (fixed)
0061++ AAB3~            			ld	a,15				; a:=15
0062++ AAB3~            			sub	c				; a:=15-New priority = relative volume
0063++ AAB3~            			jr	z,.INIT_NOSOUND		; If priority is 15 -> no sound output (volume is zero)
0064++ AAB3~            			add	a,a				; a:=a*2
0065++ AAB3~            			add	a,a				; a:=a*4
0066++ AAB3~            			add	a,a				; a:=a*8
0067++ AAB3~            			add	a,a				; a:=a*16
0068++ AAB3~            			ld	e,a				; e:=a
0069++ AAB3~            			ld	d,0				; de:=a
0070++ AAB3~            			ld	hl,VT_				; hl:=PT3 volume table
0071++ AAB3~            			add	hl,de				; hl is a pointer to the relative volume table
0072++ AAB3~            			ld	[ayFX_VT],hl			; Save pointer
0073++ AAB3             		ENDIF
0074++ AAB3             
0075++ AAB3             		; --- Calculate the pointer to the new ayFX stream ---
0076++ AAB3 ED 5B 41 F2 		ld	de,[ayFX_BANK]			; de:=Current ayFX bank
0077++ AAB7 13          		inc	de				; de points to the increments table of the bank
0078++ AAB8 68          		ld	l,b				; l:=b (new ayFX stream index)
0079++ AAB9 26 00       		ld	h,0				; hl:=b (new ayFX stream index)
0080++ AABB 29          		add	hl,hl				; hl:=hl*2
0081++ AABC 19          		add	hl,de				; hl:=hl+de (hl points to the correct increment)
0082++ AABD 5E          		ld	e,[hl]				; e:=lower byte of the increment
0083++ AABE 23          		inc	hl				; hl points to the higher byte of the correct increment
0084++ AABF 56          		ld	d,[hl]				; de:=increment
0085++ AAC0 19          		add	hl,de				; hl:=hl+de (hl points to the new ayFX stream)
0086++ AAC1 22 44 F2    		ld	[ayFX_POINTER],hl		; Pointer saved in RAM
0087++ AAC4 AF          		xor	a				; a:=0 (no errors)
0088++ AAC5 E1          .INIT_END: 	pop	hl				; Retrieve hl from stack
0089++ AAC6 D1          		pop	de				; Retrieve de from stack
0090++ AAC7 C1          		pop	bc				; Retrieve bc from stack
0091++ AAC8 C9          		ret					; Return
0092++ AAC9             
0093++ AAC9             		IF ( AYFXRELATIVE == 1 )
0094++ AAC9~            .INIT_NOSOUND: 	; --- Init a sample with relative volume zero -> no sound output ---
0095++ AAC9~            			ld	a,255				; Lowest ayFX priority
0096++ AAC9~            			ld	[ayFX_PRIORITY],a		; Priority saved (not playing ayFX stream)
0097++ AAC9~            			jr	.INIT_END			; Jumps to .INIT_END
0098++ AAC9             		ENDIF
0099++ AAC9             
0100++ AAC9             ayFX_PLAY: 	; --- PLAY A FRAME OF AN ayFX STREAM ---
0101++ AAC9 3A 43 F2    		ld	a,[ayFX_PRIORITY]		; a:=Current ayFX stream priority
0102++ AACC B7          		or	a				; If priority has bit 7 on...
0103++ AACD F8          		ret	m				; ...return
0104++ AACE             		; --- Calculate next ayFX channel (if needed) ---
0105++ AACE 3A 40 F2    		ld	a,[ayFX_MODE]			; ayFX mode
0106++ AAD1 E6 01       		and	1				; If bit0=0 (fixed channel)...
0107++ AAD3 28 08       		jr	z,.TAKECB			; ...skip channel changing
0108++ AAD5 21 4A F2    		ld	hl,ayFX_CHANNEL			; Old ayFX playing channel
0109++ AAD8 35          		dec	[hl]				; New ayFX playing channel
0110++ AAD9 20 02       		jr	nz,.TAKECB			; If not zero jump to .TAKECB
0111++ AADB 36 03       		ld	[hl],3				; If zero -> set channel 3
0112++ AADD             .TAKECB: 	; --- Extract control byte from stream ---
0113++ AADD 2A 44 F2    		ld	hl,[ayFX_POINTER]		; Pointer to the current ayFX stream
0114++ AAE0 4E          		ld	c,[hl]				; c:=Control byte
0115++ AAE1 23          		inc	hl				; Increment pointer
0116++ AAE2             		; --- Check if there's new tone on stream ---
0117++ AAE2 CB 69       		bit	5,c				; If bit 5 c is off...
0118++ AAE4 28 08       		jr	z,.CHECK_NN			; ...jump to .CHECK_NN (no new tone)
0119++ AAE6             		; --- Extract new tone from stream ---
0120++ AAE6 5E          		ld	e,[hl]				; e:=lower byte of new tone
0121++ AAE7 23          		inc	hl				; Increment pointer
0122++ AAE8 56          		ld	d,[hl]				; d:=higher byte of new tone
0123++ AAE9 23          		inc	hl				; Increment pointer
0124++ AAEA ED 53 46 F2 		ld	[ayFX_TONE],de			; ayFX tone updated
0125++ AAEE             .CHECK_NN: 	; --- Check if there's new noise on stream ---
0126++ AAEE CB 71       		bit	6,c				; if bit 6 c is off...
0127++ AAF0 28 09       		jr	z,.SETPOINTER			; ...jump to .SETPOINTER (no new noise)
0128++ AAF2             		; --- Extract new noise from stream ---
0129++ AAF2 7E          		ld	a,[hl]				; a:=New noise
0130++ AAF3 23          		inc	hl				; Increment pointer
0131++ AAF4 FE 20       		cp	$20				; If it's an illegal value of noise (used to mark end of stream)...
0132++ AAF6 28 95       		jr	z,ayFX_END			; ...jump to ayFX_END
0133++ AAF8 32 48 F2    		ld	[ayFX_NOISE],a			; ayFX noise updated
0134++ AAFB             .SETPOINTER: 	; --- Update ayFX pointer ---
0135++ AAFB 22 44 F2    		ld	[ayFX_POINTER],hl		; Update ayFX stream pointer
0136++ AAFE             		; --- Extract volume ---
0137++ AAFE 79          		ld	a,c				; a:=Control byte
0138++ AAFF E6 0F       		and	$0F				; lower nibble
0139++ AB01             
0140++ AB01             		IF ( AYFXRELATIVE == 1 )
0141++ AB01~            			; --- Fix the volume using PT3 Volume Table ---
0142++ AB01~            			ld	hl,[ayFX_VT]			; hl:=Pointer to relative volume table
0143++ AB01~            			ld	e,a				; e:=a (ayFX volume)
0144++ AB01~            			ld	d,0				; d:=0
0145++ AB01~            			add	hl,de				; hl:=hl+de (hl points to the relative volume of this frame
0146++ AB01~            			ld	a,[hl]				; a:=ayFX relative volume
0147++ AB01~            			or	a				; If relative volume is zero...
0148++ AB01             		ENDIF
0149++ AB01             
0150++ AB01 32 49 F2    		ld	[ayFX_VOLUME],a			; ayFX volume updated
0151++ AB04 C8          		ret	z				; ...return (don't copy ayFX values in to AYREGS)
0152++ AB05             		; -------------------------------------
0153++ AB05             		; --- COPY ayFX VALUES IN TO AYREGS ---
0154++ AB05             		; -------------------------------------
0155++ AB05             		; --- Set noise channel ---
0156++ AB05 CB 79       		bit	7,c				; If noise is off...
0157++ AB07 20 06       		jr	nz,.SETMASKS			; ...jump to .SETMASKS
0158++ AB09 3A 48 F2    		ld	a,[ayFX_NOISE]			; ayFX noise value
0159++ AB0C 32 46 F1    		ld	[AYREGS+6],a			; copied in to AYREGS (noise channel)
0160++ AB0F             .SETMASKS: 	; --- Set mixer masks ---
0161++ AB0F 79          		ld	a,c				; a:=Control byte
0162++ AB10 E6 90       		and	$90				; Only bits 7 and 4 (noise and tone mask for psg reg 7)
0163++ AB12 FE 90       		cp	$90				; If no noise and no tone...
0164++ AB14 C8          		ret	z				; ...return (don't copy ayFX values in to AYREGS)
0165++ AB15             		; --- Copy ayFX values in to ARYREGS ---
0166++ AB15 0F          		rrca					; Rotate a to the right (1 TIME)
0167++ AB16 0F          		rrca					; Rotate a to the right (2 TIMES) (OR mask)
0168++ AB17 16 DB       		ld	d,$DB				; d:=Mask for psg mixer (AND mask)
0169++ AB19             		; --- Dump to correct channel ---
0170++ AB19 21 4A F2    		ld	hl,ayFX_CHANNEL			; Next ayFX playing channel
0171++ AB1C 46          		ld	b,[hl]				; Channel counter
0172++ AB1D             .CHK1: 		; --- Check if playing channel was 1 ---
0173++ AB1D 10 0D       		djnz	.CHK2				; Decrement and jump if channel was not 1
0174++ AB1F             .PLAY_C: 	; --- Play ayFX stream on channel C ---
0175++ AB1F CD 4E AB    		call	.SETMIXER			; Set PSG mixer value (returning a=ayFX volume and hl=ayFX tone)
0176++ AB22 32 4A F1    		ld	[AYREGS+10],a			; Volume copied in to AYREGS (channel C volume)
0177++ AB25 CB 51       		bit	2,c				; If tone is off...
0178++ AB27 C0          		ret	nz				; ...return
0179++ AB28 22 44 F1    		ld	[AYREGS+4],hl			; copied in to AYREGS (channel C tone)
0180++ AB2B C9          		ret					; Return
0181++ AB2C             .CHK2: 		; --- Check if playing channel was 2 ---
0182++ AB2C CB 0A       		rrc	d				; Rotate right AND mask
0183++ AB2E 0F          		rrca					; Rotate right OR mask
0184++ AB2F 10 0D       		djnz	.CHK3				; Decrement and jump if channel was not 2
0185++ AB31             .PLAY_B: 	; --- Play ayFX stream on channel B ---
0186++ AB31 CD 4E AB    		call	.SETMIXER			; Set PSG mixer value (returning a=ayFX volume and hl=ayFX tone)
0187++ AB34 32 49 F1    		ld	[AYREGS+9],a			; Volume copied in to AYREGS (channel B volume)
0188++ AB37 CB 49       		bit	1,c				; If tone is off...
0189++ AB39 C0          		ret	nz				; ...return
0190++ AB3A 22 42 F1    		ld	[AYREGS+2],hl			; copied in to AYREGS (channel B tone)
0191++ AB3D C9          		ret					; Return
0192++ AB3E             .CHK3: 		; --- Check if playing channel was 3 ---
0193++ AB3E CB 0A       		rrc	d				; Rotate right AND mask
0194++ AB40 0F          		rrca					; Rotate right OR mask
0195++ AB41             .PLAY_A: 	; --- Play ayFX stream on channel A ---
0196++ AB41 CD 4E AB    		call	.SETMIXER			; Set PSG mixer value (returning a=ayFX volume and hl=ayFX tone)
0197++ AB44 32 48 F1    		ld	[AYREGS+8],a			; Volume copied in to AYREGS (channel A volume)
0198++ AB47 CB 41       		bit	0,c				; If tone is off...
0199++ AB49 C0          		ret	nz				; ...return
0200++ AB4A 22 40 F1    		ld	[AYREGS+0],hl			; copied in to AYREGS (channel A tone)
0201++ AB4D C9          		ret					; Return
0202++ AB4E             .SETMIXER: 	; --- Set PSG mixer value ---
0203++ AB4E 4F          		ld	c,a				; c:=OR mask
0204++ AB4F 3A 47 F1    		ld	a,[AYREGS+7]			; a:=PSG mixer value
0205++ AB52 A2          		and	d				; AND mask
0206++ AB53 B1          		or	c				; OR mask
0207++ AB54 32 47 F1    		ld	[AYREGS+7],a			; PSG mixer value updated
0208++ AB57 3A 49 F2    		ld	a,[ayFX_VOLUME]			; a:=ayFX volume value
0209++ AB5A 2A 46 F2    		ld	hl,[ayFX_TONE]			; ayFX tone value
0210++ AB5D C9          		ret					; Return
0211++ AB5E             
0212++ AB5E             		IF ( AYFXRELATIVE == 1 )
0213++ AB5E~            			; --- UNCOMMENT THIS IF YOU DON'T USE THIS REPLAYER WITH PT3 REPLAYER ---
0214++ AB5E~            		;VT_:	.INCBIN	"VT.BIN"
0215++ AB5E~            			; --- UNCOMMENT THIS IF YOU DON'T USE THIS REPLAYER WITH PT3 REPLAYER ---
0216++ AB5E             		ENDIF
0217++ AB5E             
0218++ AB5E             
0219++ AB5E             ;AYREGS:			#0
0220++ AB5E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ayFX REPLAYER 
0221++ AB5E             ayFX_MODE: 		#1			; ayFX mode
0222++ AB5E             ayFX_BANK: 		#2			; Current ayFX Bank
0223++ AB5E             ayFX_PRIORITY: 	#1			; Current ayFX stream priotity
0224++ AB5E             ayFX_POINTER: 	#2			; Pointer to the current ayFX stream
0225++ AB5E             ayFX_TONE: 		#2			; Current tone of the ayFX stream
0226++ AB5E             ayFX_NOISE: 		#1			; Current noise of the ayFX stream
0227++ AB5E             ayFX_VOLUME: 	#1			; Current volume of the ayFX stream
0228++ AB5E             ayFX_CHANNEL: 	#1			; PSG channel to play the ayFX stream
0229++ AB5E             
0230++ AB5E             	;IF (AYFXRELATIVE == 1 ) 
0231++ AB5E             ;ayFX_VT:	ds	2			; ayFX relative volume table pointer
0232++ AB5E             	;ENDIF
0233++ AB5E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ayFX REPLAYER END
0157+  AB5E             sfx_bank: 
0158+  AB5E             	incbin "sfx.afb"
0159+  AF76             
0537   AF76             depack_RAM: 
0538   AF76                 include "src/dzx0_fast.asm" ;cuando crees los archivos ponle que salte 8 bits (la cabcerea + el ret): zx0.exe +8  map-screen1.bin 
0001+  AF76             ;
0002+  AF76             ;  Speed-optimized ZX0 decompressor by spke (187 bytes)
0003+  AF76             ;
0004+  AF76             ;  ver.00 by spke (27/01-23/03/2021, 191 bytes)
0005+  AF76             ;  ver.01 by spke (24/03/2021, 193(+2) bytes - fixed a bug in the initialization)
0006+  AF76             ;  ver.01patch2 by uniabis (25/03/2021, 191(-2) bytes - fixed a bug with elias over 8bits)
0007+  AF76             ;  ver.01patch9 by uniabis (10/09/2021, 187(-4) bytes - support for new v2 format)
0008+  AF76             ;
0009+  AF76             ;  Original ZX0 decompressors were written by Einar Saukas
0010+  AF76             ;
0011+  AF76             ;  This decompressor was written on the basis of "Standard" decompressor by
0012+  AF76             ;  Einar Saukas and optimized for speed by spke. This decompressor is
0013+  AF76             ;  about 5% faster than the "Turbo" decompressor, which is 128 bytes long.
0014+  AF76             ;  It has about the same speed as the 412 bytes version of the "Mega" decompressor.
0015+  AF76             ;
0016+  AF76             ;  The decompressor uses AF, BC, DE, HL and IX and relies upon self-modified code.
0017+  AF76             ;
0018+  AF76             ;  The decompression is done in the standard way:
0019+  AF76             ;
0020+  AF76             ;  ld hl,FirstByteOfCompressedData
0021+  AF76             ;  ld de,FirstByteOfMemoryForDecompressedData
0022+  AF76             ;  call DecompressZX0
0023+  AF76             ;
0024+  AF76             ;  Of course, ZX0 compression algorithms are (c) 2021 Einar Saukas,
0025+  AF76             ;  see https://github.com/einar-saukas/ZX0 for more information
0026+  AF76             ;
0027+  AF76             ;  Drop me an email if you have any comments/ideas/suggestions: zxintrospec@gmail.com
0028+  AF76             ;
0029+  AF76             ;  This software is provided 'as-is', without any express or implied
0030+  AF76             ;  warranty.  In no event will the authors be held liable for any damages
0031+  AF76             ;  arising from the use of this software.
0032+  AF76             ;
0033+  AF76             ;  Permission is granted to anyone to use this software for any purpose,
0034+  AF76             ;  including commercial applications, and to alter it and redistribute it
0035+  AF76             ;  freely, subject to the following restrictions:
0036+  AF76             ;
0037+  AF76             ;  1. The origin of this software must not be misrepresented; you must not
0038+  AF76             ;     claim that you wrote the original software. If you use this software
0039+  AF76             ;     in a product, an acknowledgment in the product documentation would be
0040+  AF76             ;     appreciated but is not required.
0041+  AF76             ;  2. Altered source versions must be plainly marked as such, and must not be
0042+  AF76             ;     misrepresented as being the original software.
0043+  AF76             ;  3. This notice may not be removed or altered from any source distribution.
0044+  AF76             
0045+  AF76             DecompressZX0: 
0046+  AF76             
0047+  AF76 DD 21 95 AF         ld      ix, CopyMatch1
0048+  AF7A 01 FF FF            ld      bc, $ffff
0049+  AF7D ED 43 97 AF         ld      (PrevOffset+1), bc      ; default offset is -1
0050+  AF81 03                  inc     bc
0051+  AF82 3E 80               ld      a, $80
0052+  AF84 18 5A               jr      RunOfLiterals           ; BC is assumed to contains 0 most of the time
0053+  AF86             
0054+  AF86             ShorterOffsets: 
0055+  AF86 06 FF               ld      b, $ff                  ; the top byte of the offset is always $FF
0056+  AF88 4E                  ld      c, (hl)
0057+  AF89 23                  inc     hl
0058+  AF8A CB 19               rr      c
0059+  AF8C ED 43 97 AF         ld      (PrevOffset+1), bc
0060+  AF90 30 32               jr      nc, LongerMatch
0061+  AF92             
0062+  AF92             CopyMatch2:                              ; the case of matches with len=2
0063+  AF92 01 02 00            ld      bc, 2
0064+  AF95             
0065+  AF95                     ; the faster match copying code
0066+  AF95             CopyMatch1: 
0067+  AF95 E5                  push    hl                      ; preserve source
0068+  AF96             
0069+  AF96             PrevOffset: 
0070+  AF96 21 FF FF            ld      hl, $ffff               ; restore offset (default offset is -1)
0071+  AF99 19                  add     hl, de                  ; HL = dest - offset
0072+  AF9A ED B0               ldir
0073+  AF9C E1                  pop     hl                      ; restore source
0074+  AF9D             
0075+  AF9D                     ; after a match you can have either
0076+  AF9D                     ; 0 + <elias length> = run of literals, or
0077+  AF9D                     ; 1 + <elias offset msb> + [7-bits of offset lsb + 1-bit of length] + <elias length> = another match
0078+  AF9D             AfterMatch1: 
0079+  AF9D 87                  add     a, a
0080+  AF9E 30 40               jr      nc, RunOfLiterals
0081+  AFA0             
0082+  AFA0             UsualMatch:                              ; this is the case of usual match+offset
0083+  AFA0 87                  add     a, a
0084+  AFA1 30 07               jr      nc, LongerOffets
0085+  AFA3 20 E1               jr      nz, ShorterOffsets      ; NZ after NC == "confirmed C"
0086+  AFA5                     
0087+  AFA5 7E                  ld      a, (hl)                 ; reload bits
0088+  AFA6 23                  inc     hl
0089+  AFA7 17                  rla
0090+  AFA8             
0091+  AFA8 38 DC               jr      c, ShorterOffsets
0092+  AFAA             
0093+  AFAA             LongerOffets: 
0094+  AFAA 0E FE               ld      c, $fe
0095+  AFAC             
0096+  AFAC 87                  add     a, a                    ; inline read gamma
0097+  AFAD CB 11               rl      c
0098+  AFAF 87                  add     a, a
0099+  AFB0 30 FA               jr      nc, $-4
0100+  AFB2             
0101+  AFB2 CC 16 B0            call    z, ReloadReadGamma
0102+  AFB5             
0103+  AFB5             ProcessOffset: 
0104+  AFB5             
0105+  AFB5 0C                  inc     c
0106+  AFB6 C8                  ret     z                       ; end-of-data marker (only checked for longer offsets)
0107+  AFB7 CB 19               rr      c
0108+  AFB9 41                  ld      b, c
0109+  AFBA 4E                  ld      c, (hl)
0110+  AFBB 23                  inc     hl
0111+  AFBC CB 19               rr      c
0112+  AFBE ED 43 97 AF         ld      (PrevOffset+1), bc
0113+  AFC2             
0114+  AFC2                     ; lowest bit is the first bit of the gamma code for length
0115+  AFC2 38 CE               jr      c, CopyMatch2
0116+  AFC4             
0117+  AFC4             LongerMatch: 
0118+  AFC4 01 01 00            ld      bc, 1
0119+  AFC7             
0120+  AFC7 87                  add     a, a                    ; inline read gamma
0121+  AFC8 CB 11               rl      c
0122+  AFCA 87                  add     a, a
0123+  AFCB 30 FA               jr      nc, $-4
0124+  AFCD             
0125+  AFCD CC 16 B0            call    z,ReloadReadGamma
0126+  AFD0             
0127+  AFD0             CopyMatch3: 
0128+  AFD0 E5                  push    hl                      ; preserve source
0129+  AFD1 2A 97 AF            ld      hl, (PrevOffset+1)      ; restore offset
0130+  AFD4 19                  add     hl, de                  ; HL = dest - offset
0131+  AFD5             
0132+  AFD5                     ; because BC>=3-1, we can do 2 x LDI safely
0133+  AFD5 ED A0               ldi
0134+  AFD7 ED B0               ldir
0135+  AFD9 0C                  inc     c
0136+  AFDA ED A0               ldi
0137+  AFDC E1                  pop     hl                      ; restore source
0138+  AFDD             
0139+  AFDD                     ; after a match you can have either
0140+  AFDD                     ; 0 + <elias length> = run of literals, or
0141+  AFDD                     ; 1 + <elias offset msb> + [7-bits of offset lsb + 1-bit of length] + <elias length> = another match
0142+  AFDD             AfterMatch3: 
0143+  AFDD 87                  add     a, a
0144+  AFDE 38 C0               jr      c, UsualMatch
0145+  AFE0             
0146+  AFE0             RunOfLiterals: 
0147+  AFE0 0C                  inc     c
0148+  AFE1 87                  add     a, a
0149+  AFE2 30 07               jr      nc, LongerRun
0150+  AFE4 20 15               jr      nz, CopyLiteral         ; NZ after NC == "confirmed C"
0151+  AFE6                     
0152+  AFE6 7E                  ld      a, (hl)                 ; reload bits
0153+  AFE7 23                  inc     hl
0154+  AFE8 17                  rla
0155+  AFE9             
0156+  AFE9 38 10               jr      c, CopyLiteral
0157+  AFEB             
0158+  AFEB             LongerRun: 
0159+  AFEB 87                  add     a, a                    ; inline read gamma
0160+  AFEC CB 11               rl      c
0161+  AFEE 87                  add     a, a
0162+  AFEF 30 FA               jr      nc, $-4
0163+  AFF1             
0164+  AFF1 20 06               jr      nz, CopyLiterals
0165+  AFF3                     
0166+  AFF3 7E                  ld      a, (hl)                 ; reload bits
0167+  AFF4 23                  inc     hl
0168+  AFF5 17                  rla
0169+  AFF6             
0170+  AFF6 D4 1A B0            call    nc, ReadGammaAligned
0171+  AFF9             
0172+  AFF9             CopyLiterals: 
0173+  AFF9 ED A0               ldi
0174+  AFFB             
0175+  AFFB             CopyLiteral: 
0176+  AFFB ED B0               ldir
0177+  AFFD             
0178+  AFFD                     ; after a literal run you can have either
0179+  AFFD                     ; 0 + <elias length> = match using a repeated offset, or
0180+  AFFD                     ; 1 + <elias offset msb> + [7-bits of offset lsb + 1-bit of length] + <elias length> = another match
0181+  AFFD 87                  add     a, a
0182+  AFFE 38 A0               jr      c, UsualMatch
0183+  B000             
0184+  B000             RepMatch: 
0185+  B000 0C                  inc     c
0186+  B001 87                  add     a, a
0187+  B002 30 07               jr      nc, LongerRepMatch
0188+  B004 20 8F               jr      nz, CopyMatch1          ; NZ after NC == "confirmed C"
0189+  B006             
0190+  B006 7E                  ld      a, (hl)                 ; reload bits
0191+  B007 23                  inc     hl
0192+  B008 17                  rla
0193+  B009             
0194+  B009 38 8A               jr      c, CopyMatch1
0195+  B00B             
0196+  B00B             LongerRepMatch: 
0197+  B00B 87                  add     a, a                    ; inline read gamma
0198+  B00C CB 11               rl      c
0199+  B00E 87                  add     a, a
0200+  B00F 30 FA               jr      nc, $-4
0201+  B011             
0202+  B011 C2 95 AF            jp      nz, CopyMatch1
0203+  B014             
0204+  B014                     ; this is a crafty equivalent of CALL ReloadReadGamma : JP CopyMatch1
0205+  B014 DD E5               push    ix
0206+  B016             
0207+  B016                     ;  the subroutine for reading the remainder of the partly read Elias gamma code.
0208+  B016                     ;  it has two entry points: ReloadReadGamma first refills the bit reservoir in A,
0209+  B016                     ;  while ReadGammaAligned assumes that the bit reservoir has just been refilled.
0210+  B016             ReloadReadGamma: 
0211+  B016 7E                  ld      a, (hl)                 ; reload bits
0212+  B017 23                  inc     hl
0213+  B018 17                  rla
0214+  B019             
0215+  B019 D8                  ret     c
0216+  B01A             ReadGammaAligned: 
0217+  B01A 87                  add     a, a
0218+  B01B CB 11               rl      c
0219+  B01D 87                  add     a, a
0220+  B01E D8                  ret     c
0221+  B01F 87                  add     a, a
0222+  B020 CB 11               rl      c
0223+  B022 87                  add     a, a
0224+  B023             ReadingLongGamma:                        ; this loop does not need unrolling, as it does not get much use anyway
0225+  B023 D8                  ret     c
0226+  B024 87                  add     a, a
0227+  B025 CB 11               rl      c
0228+  B027 CB 10               rl      b
0229+  B029 87                  add     a, a
0230+  B02A 20 F7               jr      nz, ReadingLongGamma
0231+  B02C             
0232+  B02C 7E                  ld      a, (hl)                 ; reload bits
0233+  B02D 23                  inc     hl
0234+  B02E 17                  rla
0235+  B02F 18 F2               jr      ReadingLongGamma
0236+  B031             
0539   B031             maps_tiled1: 
0540   B031                 incbin "./assets/tiled/map-screen1.bin.zx0"
0541   B0D3             maps_tiled2: 
0542   B0D3                 incbin "./assets/tiled/map-screen2.bin.zx0"
0543   B161             maps_tiled3: 
0544   B161                 incbin "./assets/tiled/map-screen3.bin.zx0"
0545   B205             maps_tiled4: 
0546   B205                 incbin "./assets/tiled/map-screen4.bin.zx0"
0547   B29F             maps_tiled5: 
0548   B29F                 incbin "./assets/tiled/map-screen5.bin.zx0"
0549   B34C             maps_tiled6: 
0550   B34C                 incbin "./assets/tiled/map-screen6.bin.zx0"
0551   B3D9             maps_tiled7: 
0552   B3D9                 incbin "./assets/tiled/map-screen7.bin.zx0"
0553   B48B             maps_tiled8: 
0554   B48B                 incbin "./assets/tiled/map-screen8.bin.zx0"
0555   B531             maps_tiled9: 
0556   B531                 incbin "./assets/tiled/map-screen9.bin.zx0"
0557   B5BA             maps_tiled10: 
0558   B5BA                 incbin "./assets/tiled/map-screen10.bin.zx0"
0559   B682             maps_tiled11: 
0560   B682                 incbin "./assets/tiled/map-screen11.bin.zx0"
0561   B719             maps_tiled12: 
0562   B719                 incbin "./assets/tiled/map-screen12.bin.zx0"
0563   B7BD             
0564   B7BD             
0565   B7BD             
0566   B7BD             
0567   B7BD             FINAL: 
